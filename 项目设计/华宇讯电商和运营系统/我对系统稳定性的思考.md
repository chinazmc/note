# å‹æµ‹ç¡®å®šç³»ç»ŸæŒ‡æ ‡
ç›®å‰å®é™…æƒ…å†µæ˜¯ï¼š
1ã€æ ¹æ®å•†å“idè¿”å›å•†å“è¯¦æƒ… ab -n5000 -c300 qps500ï¼Œtp99 2000ms.
2ã€æ ¹æ®skuIdsè·å–skuä¿¡æ¯ abÂ -n5000Â -c300Â qps480ï¼Œtp99åªæœ‰1678ms.
3ã€æ ¹æ®productIdsè·å–å•†å“ä¿¡æ¯ abÂ -n5000Â -c300Â qps828ï¼Œtp99åªæœ‰1050ms.  
4ã€æ ¹æ®å±æ€§å€¼è·å–å•†å“åˆ—è¡¨æ¥å£ qps128,tp99:7596
5ã€æŸ¥è¯¢å•ä¸ªè®¢å•è¯¦æƒ… -n5000 -c500Â  qps1240 tp99 456ms
6ã€æ‰¹é‡æ–°å¢è´­ç‰©è½¦ -n5000 -c500 qps355 tp99 4740
7ã€æ ¹æ®ç”¨æˆ·idæŸ¥è¯¢ç”¨æˆ·è´­ç‰©è½¦åˆ—è¡¨ qps1403 tp99 423
8ã€ æ‰¹é‡æŸ¥è¯¢è®¢å•å•†å“æ‰©å±•ä¿¡æ¯ qps1492 tp99 364
9ã€æ‰¹é‡åˆ é™¤è´­ç‰©è½¦ qps1393 tp99 396
10ã€æ ¹æ®payOrderIdæŸ¥è¯¢è®¢å• qps1287 tp99 449
11ã€ç”¨æˆ·è®¢å•åˆ—è¡¨ qps 563 tp99 990
12ã€ä¸‹å•æ¥å£ -n1000 -c100 tps 70 tp99 2189
-n5000 -c500 tps72 tp99 11581
é€šè¿‡è¿™äº›å‹æµ‹æƒ…å†µï¼Œæˆ‘ä»¬å¯ä»¥æ¸…æ™°çŸ¥é“ç³»ç»Ÿçš„é™æµç›®æ ‡å’Œ è¶…æ—¶tp99ç›®æ ‡ã€‚

è®¢å•ä¸‹å•tps600,tp99 700ms, å•†å“æŸ¥è¯¢ tps1000,tp99 500ms
# æ³¨å†Œä¸­å¿ƒ

ğŸ” æœåŠ¡æ³¨å†Œä¸å‘ç°æœºåˆ¶çš„åŸºæœ¬æ¨¡å‹æ˜¯æ€æ ·çš„ï¼Ÿ
![[Pasted image 20240221145303.png]]
1. ç”Ÿäº§è€…å¯¹å¤–æš´éœ²æœåŠ¡ï¼Œå³å°†å®šä½ä¿¡æ¯å’Œå…ƒæ•°æ®ä¿¡æ¯æ³¨å†Œåˆ°æ³¨å†Œä¸­å¿ƒä¸­ï¼›
2. æ¶ˆè´¹è€…è®¢é˜…æ³¨å†Œä¸­å¿ƒçš„æœåŠ¡ä¿¡æ¯ï¼›
3. åœ¨ç”Ÿäº§è€…æœåŠ¡ä¸Šä¸‹çº¿åä¼šæ›´æ–°æ³¨å†Œä¸­å¿ƒçš„ä¿¡æ¯ï¼Œæ­¤æ—¶æ³¨å†Œä¸­å¿ƒå°†å˜åŒ–ä¿¡æ¯ä¸»åŠ¨é€šçŸ¥æ¶ˆè´¹è€…ï¼›
4. æ¶ˆè´¹è€…æ ¹æ®æ³¨å†Œä¿¡æ¯å‘ç”Ÿäº§è€…å‘èµ·è°ƒç”¨ã€‚

æˆ‘ä»¬ä½¿ç”¨k8s çš„serviceä½œä¸ºæ³¨å†Œä¸­å¿ƒï¼Œæ‰€ä»¥capä¸­æ˜¯æŒ‰ç…§etcd raftåè®®çš„è¯æ˜¯cpæ¨¡å‹ã€‚

ğŸ” æœåŠ¡ä¸Šçº¿ä¸æœåŠ¡ä¸‹çº¿çš„æ­¥éª¤æ˜¯ä»€ä¹ˆï¼Ÿ
æœåŠ¡ä¸Šçº¿åº”è¯¥æ˜¯ å®Œæ•´å¯åŠ¨å¥½é¡¹ç›®ï¼Œç„¶åå…ˆæ³¨å†Œä¸­å¿ƒæ³¨å†Œï¼Œæ³¨å†Œä¸­å¿ƒæ¨é€ç»™æ¶ˆè´¹è€…ã€‚
æœåŠ¡ä¸‹çº¿åº”è¯¥æ˜¯å…ˆå–æ¶ˆæ³¨å†Œä¸­å¿ƒçš„æ•°æ®ï¼Œç„¶åç­‰å¾…è¯·æ±‚å¤„ç†å®Œæˆ–è€…è¶…æ—¶ï¼Œç„¶åå†å…³é—­æœåŠ¡ã€‚å¦å¤–å–æ¶ˆæœåŠ¡ä¹‹åï¼Œè¦é€šçŸ¥æ¶ˆè´¹è€…ã€‚

ğŸ” æ³¨å†Œä¸­å¿ƒé€‰å‹éœ€è¦è€ƒè™‘å“ªäº›å› ç´ ï¼Ÿ
capã€‚

ğŸ” ä½ ä¸ºä»€ä¹ˆä½¿ç”¨ Zookeeper/Nacos/etcd ä½œä¸ºä½ çš„æ³¨å†Œä¸­å¿ƒï¼Ÿ
ä¸€è‡´æ€§åè®®å‡ºè‰²ã€‚

ğŸ” åœ¨æœåŠ¡æ³¨å†Œä¸å‘ç°é‡Œé¢ä½ è§‰å¾—åº”è¯¥ç”¨ AP è¿˜æ˜¯ CPï¼Ÿ
çœ‹ä¸šåŠ¡ï¼Œä¸€èˆ¬æ˜¯apæ¯”è¾ƒå¥½ã€‚ä½†æ˜¯å…¶å®æ™®é€šä¸šåŠ¡åŒºåˆ«ä¸å¤§çš„ã€‚apå°±ç®—ä¸ä¸€è‡´äº†ä¹Ÿå¯ä»¥é‡è¯•ã€‚å…¼å®¹æ€§æ¯”è¾ƒå¥½ã€‚

ğŸ” å¦‚ä½•ä¿è¯æœåŠ¡æ³¨å†Œä¸å‘ç°çš„é«˜å¯ç”¨ï¼Ÿ
é›†ç¾¤æ–¹æ¡ˆï¼Œå¿ƒè·³æ–¹æ¡ˆï¼Œraftæ–¹æ¡ˆè§£å†³è„‘è£‚æˆ–è€…æ•°æ®ä¸ä¸€è‡´ï¼ˆæœ€å°‘åŒæ­¥åˆ°å¤§å¤šæ•°èŠ‚ç‚¹ï¼Œå¹¶ä¸”è·Ÿä»èŠ‚ç‚¹çš„å»¶è¿Ÿä¸å°äºæŸä¸ªå€¼ã€‚ï¼‰

ğŸ” æœåŠ¡å™¨å´©æºƒï¼Œå¦‚ä½•æ£€æµ‹ï¼Ÿ
å¿ƒè·³
ğŸ” å®¢æˆ·ç«¯å®¹é”™çš„æªæ–½æœ‰å“ªäº›ï¼Ÿ
é‡è¯•ï¼ŒåŠæ—¶è·Ÿæ³¨å†Œä¸­å¿ƒæ ¡éªŒæ•°æ®ï¼Œåˆç†è´Ÿè½½å‡è¡¡ã€‚

ğŸ” æ³¨å†Œä¸­å¿ƒå´©æºƒäº†æ€ä¹ˆåŠï¼Ÿ
ä½¿ç”¨ç¼“å­˜ï¼Œé›†ç¾¤æ–¹æ¡ˆ
ğŸ” æ³¨å†Œä¸­å¿ƒæ€ä¹ˆåˆ¤æ–­æœåŠ¡ç«¯å·²ç»å´©æºƒäº†ï¼Ÿ
å¿ƒè·³

# è´Ÿè½½å‡è¡¡ï¼šè°ƒç”¨ç»“æœã€ç¼“å­˜æœºåˆ¶æ€ä¹ˆå½±å“è´Ÿè½½å‡è¡¡çš„ï¼Ÿ

âš–ï¸ é™æ€è´Ÿè½½å‡è¡¡ç®—æ³•å’ŒåŠ¨æ€è´Ÿè½½å‡è¡¡ç®—æ³•çš„æ ¸å¿ƒåŒºåˆ«æ˜¯ä»€ä¹ˆï¼Ÿ
äºŒã€åŠ¨æ€ç®—æ³•
åŠ¨æ€ç®—æ³•æœ‰:æœ€å°‘è¿æ¥æ•°,æœ€å¿«å“åº”é€Ÿåº¦ï¼Œè§‚å¯Ÿæ–¹æ³•ï¼Œé¢„æµ‹æ³•ï¼ŒåŠ¨æ€æ€§èƒ½åˆ†é…ï¼ŒåŠ¨æ€æœåŠ¡å™¨è¡¥å……ï¼ŒæœåŠ¡è´¨é‡ï¼ŒæœåŠ¡ç±»å‹ï¼Œè§„åˆ™æ¨¡å¼

æœ€å°‘è¿æ¥æ•°ï¼ˆLeast Connectionï¼‰ï¼šä¼ é€’æ–°çš„è¿æ¥ç»™é‚£äº›è¿›è¡Œæœ€å°‘è¿æ¥å¤„ç†çš„æœåŠ¡å™¨ã€‚å½“å…¶ä¸­æŸä¸ªæœåŠ¡å™¨å‘ç”Ÿç¬¬äºŒåˆ°ç¬¬7 å±‚çš„æ•…éšœï¼ŒBIG-IP å°±æŠŠå…¶ä»æœåŠ¡å™¨é˜Ÿåˆ—ä¸­æ‹¿å‡ºï¼Œä¸å‚åŠ ä¸‹ä¸€æ¬¡çš„ç”¨æˆ·è¯·æ±‚çš„åˆ†é…, ç›´åˆ°å…¶æ¢å¤æ­£å¸¸ã€‚
æœ€å¿«å“åº”é€Ÿåº¦ï¼ˆFastestï¼‰ï¼šä¼ é€’è¿æ¥ç»™é‚£äº›å“åº”æœ€å¿«çš„æœåŠ¡å™¨ã€‚å½“å…¶ä¸­æŸä¸ªæœåŠ¡å™¨å‘ç”Ÿç¬¬äºŒåˆ°ç¬¬7 å±‚çš„æ•…éšœï¼ŒBIG-IP å°±æŠŠå…¶ä»æœåŠ¡å™¨é˜Ÿåˆ—ä¸­æ‹¿å‡ºï¼Œä¸å‚åŠ ä¸‹ä¸€æ¬¡çš„ç”¨æˆ·è¯·æ±‚çš„åˆ†é…ï¼Œç›´åˆ°å…¶æ¢å¤æ­£å¸¸ã€‚
è§‚å¯Ÿæ–¹æ³•(æ¨¡å¼)ï¼ˆObservedï¼‰ï¼šè¿æ¥æ•°ç›®å’Œå“åº”æ—¶é—´ä»¥è¿™ä¸¤é¡¹çš„æœ€ä½³å¹³è¡¡ä¸ºä¾æ®ä¸ºæ–°çš„è¯·æ±‚é€‰æ‹©æœåŠ¡å™¨ã€‚å½“å…¶ä¸­æŸä¸ªæœåŠ¡å™¨å‘ç”Ÿç¬¬äºŒåˆ°ç¬¬7 å±‚çš„æ•…éšœï¼ŒBIG-IPå°±æŠŠå…¶ä»æœåŠ¡å™¨é˜Ÿåˆ—ä¸­æ‹¿å‡ºï¼Œä¸å‚åŠ ä¸‹ä¸€æ¬¡çš„ç”¨æˆ·è¯·æ±‚çš„åˆ†é…ï¼Œç›´åˆ°å…¶æ¢å¤æ­£å¸¸ã€‚
é¢„æµ‹æ¨¡å¼ï¼ˆPredictiveï¼‰ï¼šBIG-IPåˆ©ç”¨æ”¶é›†åˆ°çš„æœåŠ¡å™¨å½“å‰çš„æ€§èƒ½æŒ‡æ ‡ï¼Œè¿›è¡Œé¢„æµ‹åˆ†æï¼Œé€‰æ‹©ä¸€å°æœåŠ¡å™¨åœ¨ä¸‹ä¸€ä¸ªæ—¶é—´ç‰‡å†…ï¼Œå…¶æ€§èƒ½å°†è¾¾åˆ°æœ€ä½³çš„æœåŠ¡å™¨ç›¸åº”ç”¨æˆ·çš„è¯·æ±‚ã€‚(è¢«BIG-IP è¿›è¡Œæ£€æµ‹) ã€‚
åŠ¨æ€æ€§èƒ½åˆ†é…(Dynamic Ratio-APM):BIG-IP æ”¶é›†åˆ°çš„åº”ç”¨ç¨‹åºå’Œåº”ç”¨æœåŠ¡å™¨çš„å„é¡¹æ€§èƒ½å‚æ•°ï¼ŒåŠ¨æ€è°ƒæ•´æµé‡åˆ†é…ã€‚
åŠ¨æ€æœåŠ¡å™¨è¡¥å……(Dynamic Server Act.):å½“ä¸»æœåŠ¡å™¨ç¾¤ä¸­å› æ•…éšœå¯¼è‡´æ•°é‡å‡å°‘æ—¶ï¼ŒåŠ¨æ€åœ°å°†å¤‡ä»½æœåŠ¡å™¨è¡¥å……è‡³ä¸»æœåŠ¡å™¨ç¾¤ã€‚
æœåŠ¡è´¨é‡(QoSï¼‰:æŒ‰ä¸åŒçš„ä¼˜å…ˆçº§å¯¹æ•°æ®æµè¿›è¡Œåˆ†é…ã€‚
æœåŠ¡ç±»å‹(ToS): æŒ‰ä¸åŒçš„æœåŠ¡ç±»å‹ï¼ˆåœ¨Type of Fieldä¸­æ ‡è¯†ï¼‰è´Ÿè½½å‡è¡¡å¯¹æ•°æ®æµè¿›è¡Œåˆ†é…ã€‚
è§„åˆ™æ¨¡å¼ï¼šé’ˆå¯¹ä¸åŒçš„æ•°æ®æµè®¾ç½®å¯¼å‘è§„åˆ™ï¼Œç”¨æˆ·å¯è‡ªè¡Œã€‚
ä¸‰ã€é™æ€ç®—æ³•
é™æ€ç®—æ³•æœ‰:è½®è¯¢ï¼Œæ¯”ç‡ï¼Œä¼˜å…ˆæƒ (åŠ æƒ)ï¼Œéšæœº

è½®è¯¢ï¼ˆRound Robinï¼‰ï¼šé¡ºåºå¾ªç¯å°†è¯·æ±‚ä¸€æ¬¡é¡ºåºå¾ªç¯åœ°è¿æ¥æ¯ä¸ªæœåŠ¡å™¨ã€‚å½“å…¶ä¸­æŸä¸ªæœåŠ¡å™¨å‘ç”Ÿç¬¬äºŒåˆ°ç¬¬7 å±‚çš„æ•…éšœï¼ŒBIG-IP å°±æŠŠå…¶ä»é¡ºåºå¾ªç¯é˜Ÿåˆ—ä¸­æ‹¿å‡ºï¼Œä¸å‚åŠ ä¸‹ä¸€æ¬¡çš„è½®è¯¢ï¼Œç›´åˆ°å…¶æ¢å¤æ­£å¸¸ã€‚
æ¯”ç‡ï¼ˆRatioï¼‰ï¼šç»™æ¯ä¸ªæœåŠ¡å™¨åˆ†é…ä¸€ä¸ªåŠ æƒå€¼ä¸ºæ¯”ä¾‹ï¼Œæ ¹æ¤è¿™ä¸ªæ¯”ä¾‹ï¼ŒæŠŠç”¨æˆ·çš„è¯·æ±‚åˆ†é…åˆ°æ¯ä¸ªæœåŠ¡å™¨ã€‚å½“å…¶ä¸­æŸä¸ªæœåŠ¡å™¨å‘ç”Ÿç¬¬äºŒåˆ°ç¬¬7 å±‚çš„æ•…éšœï¼ŒBIG-IP å°±æŠŠå…¶ä»æœåŠ¡å™¨é˜Ÿåˆ—ä¸­æ‹¿å‡ºï¼Œä¸å‚åŠ ä¸‹ä¸€æ¬¡çš„ç”¨æˆ·è¯·æ±‚çš„åˆ†é…, ç›´åˆ°å…¶æ¢å¤æ­£å¸¸ã€‚
ä¼˜å…ˆæƒï¼ˆPriorityï¼‰ï¼šç»™æ‰€æœ‰æœåŠ¡å™¨åˆ†ç»„,ç»™æ¯ä¸ªç»„å®šä¹‰ä¼˜å…ˆæƒï¼ŒBIG-IP ç”¨æˆ·çš„è¯·æ±‚ï¼Œåˆ†é…ç»™ä¼˜å…ˆçº§æœ€é«˜çš„æœåŠ¡å™¨ç»„ï¼ˆåœ¨åŒä¸€ç»„å†…ï¼Œé‡‡ç”¨è½®è¯¢æˆ–æ¯”ç‡ç®—æ³•ï¼Œåˆ†é…ç”¨æˆ·çš„è¯·æ±‚ï¼‰ï¼›å½“æœ€é«˜ä¼˜å…ˆçº§ä¸­æ‰€æœ‰æœåŠ¡å™¨å‡ºç°æ•…éšœï¼ŒBIG-IP æ‰å°†è¯·æ±‚é€ç»™æ¬¡ä¼˜å…ˆçº§çš„æœåŠ¡å™¨ç»„ã€‚è¿™ç§æ–¹å¼ï¼Œå®é™…ä¸ºç”¨æˆ·æä¾›ä¸€ç§çƒ­å¤‡ä»½çš„æ–¹å¼ã€‚
éšæœº(random)ï¼šéšæœºåˆ†é…æœåŠ¡å™¨å¤„ç†ï¼Œç®€å•ï¼Œä½†ä¸å¯æ§ã€‚
 
âš–ï¸ è½®è¯¢ä¸éšæœºè´Ÿè½½å‡è¡¡ç®—æ³•æœ‰ä»€ä¹ˆåŒºåˆ«ï¼Ÿ
ä¸åŠ æƒé‡çš„è¯æ²¡ä»€ä¹ˆå·®æ¯”ï¼Œåªæ˜¯ç»“æœæ²¡é‚£ä¹ˆå®¹æ˜“é¢„æµ‹è€Œå·²ã€‚
ä½†æ˜¯åŠ æƒé‡è½®è¯¢çš„è¯ï¼ŒæŸä¸ªèŠ‚ç‚¹æƒé‡è¿‡å¤§å¯èƒ½ä¼šé¥¿æ­»å…¶ä»–èŠ‚ç‚¹ã€‚æƒé‡éšæœºçš„è¯ç›¸å¯¹é¥¿æ­»å‡ ç‡å°äº›ã€‚

âš–ï¸ ä½ äº†è§£å¹³æ»‘çš„åŠ æƒè½®è¯¢ç®—æ³•å—ï¼Ÿ
å°±æ˜¯å¦‚æœæŸå°æœåŠ¡å™¨çš„æƒé‡å¾ˆå¤§çš„æ—¶å€™ï¼Œé‚£ä¹ˆåœ¨ä¸€æ®µæ—¶é—´å†…å°±ä¼šä¸€ç›´å‡»ä¸­å®ƒï¼ŒæœåŠ¡å™¨å‹åŠ›ä¹Ÿå¾ˆå¤§ï¼Œæˆ‘ä»¬å¸Œæœ›å°†è¯·æ±‚å°½å¯èƒ½çš„æ‰“æ•£ä¼šå¥½ä¸€ç‚¹ï¼Œæ‰€ä»¥å°±æå‡ºäº†å¹³æ»‘åŠ æƒè½®è¯¢ç®—æ³•ã€‚

![[Pasted image 20240221154854.png]]


âš–ï¸ å¦‚ä½•æ ¹æ®è°ƒç”¨ç»“æœæ¥è°ƒæ•´è´Ÿè½½å‡è¡¡æ•ˆæœï¼Ÿ
æ¯ä¸ªè¢«è°ƒç”¨æ–¹ä¸Šä¼ è‡ªå·±çš„æ•°æ®åˆ°åŒä¸€ä¸ªåœ°æ–¹ï¼Œç„¶åæ¯æ¬¡å‘èµ·è°ƒç”¨å‰å…ˆé€šè¿‡è¿™ä¸ªåœ°æ–¹æ¥å†³ç­–å‡ºéœ€è¦è°ƒç”¨çš„ip

âš–ï¸ ä¸ºä»€ä¹ˆæœ‰äº›ç®—æ³•è¦åŠ¨æ€è°ƒæ•´èŠ‚ç‚¹çš„æƒé‡ï¼Ÿæƒé‡ç©¶ç«Ÿä»£è¡¨äº†ä»€ä¹ˆï¼Ÿ

âš–ï¸ ä½ ä»¬å…¬å¸çš„ç®—æ³•æœ‰æ²¡æœ‰è°ƒæ•´è¿‡æƒé‡ï¼Ÿä¸ºä»€ä¹ˆï¼Ÿ

âš–ï¸ æœ€å¿«å“åº”æ—¶é—´è´Ÿè½½å‡è¡¡ç®—æ³•æœ‰ä»€ä¹ˆç¼ºç‚¹ï¼Ÿ
è€—è´¹æ€§èƒ½ï¼Œè€Œä¸”å¾ˆéš¾ç¡®å®šåˆé€‚çš„é‡‡æ ·ç‡ä»¥åŠé‡‡æ ·å‘¨æœŸã€‚

âš–ï¸ å¦‚æœæˆ‘ç°åœ¨æœ‰ä¸€ä¸ªåº”ç”¨ï¼Œå¯¹å†…å­˜å’Œ CPU éƒ½éå¸¸æ•æ„Ÿï¼Œä½ å¯ä»¥é’ˆå¯¹è¿™ä¸ªç‰¹æ€§è®¾è®¡ä¸€ä¸ªè´Ÿè½½å‡è¡¡ç®—æ³•å—ï¼Ÿ
è¯·æ±‚åˆå¹¶
âš–ï¸ ä¸ºä»€ä¹ˆä½¿ç”¨è½®è¯¢ã€åŠ æƒè½®è¯¢ã€éšæœºä¹‹ç±»çš„è´Ÿè½½å‡è¡¡ç®—æ³•ï¼Œç³»ç»Ÿå§‹ç»ˆä¼šå‡ºç°å¶å‘æ€§çš„æµé‡ä¸å‡è¡¡ï¼Œä»¥è‡³äºæŸå°æœåŠ¡å™¨å‡ºæ•…éšœçš„æƒ…å†µï¼Ÿæ€ä¹ˆè§£å†³è¿™ä¸€ç±»é—®é¢˜ï¼Ÿ
é™æµï¼Œç†”æ–­ã€‚è¯·æ±‚åˆå¹¶ï¼ŒåŠ¨æ€è°ƒæ•´æƒé‡ï¼ˆæ…é‡ï¼‰
# å•å…ƒæµ‹è¯•ä»¥åŠä»£ç åˆ†æ

## å•å…ƒçš„mock
sqlMockå¯ä»¥æ¨¡æ‹Ÿæ•°æ®åº“ï¼Œåœ¨è¿™ä¸ªè¿‡ç¨‹ä¸­ä½ å¯ä»¥ä¼ å…¥sqlç„¶åå¯¹sqlåˆ†æåè¿”å›ç‰¹å®šçš„ç»“æœã€‚
gomockå·¥å…·å¯ä»¥å¯¹æ¥å£ç”Ÿæˆä»£ç åè¿›è¡Œä»£ç†ï¼Œå¯ä»¥å¯¹ç‰¹å®šå…¥å‚ç”Ÿæˆç‰¹å®šå›å‚ã€‚

## å•æµ‹è¦†ç›–ç‡
é¦–å…ˆæˆ‘ä»¬ä½¿ç”¨Â goÂ testÂ ç”Ÿæˆè¦†ç›–ç‡è¾“å‡ºæ–‡ä»¶Â cover.outÂ ï¼Œå¹¶é€šè¿‡Â gocovÂ å·¥å…·æ¥å°†ç”Ÿæˆçš„è¦†ç›–ç‡æ–‡ä»¶Â cover.outÂ è½¬æ¢æˆå¯ä»¥è¢«Â sonarÂ è¯†åˆ«çš„Â CoberturaÂ æ ¼å¼  
çš„Â xmlÂ æ–‡ä»¶ã€‚  
å°†ç”Ÿæˆçš„å•æµ‹è¦†ç›–ç‡æŠ¥å‘Šå‘é€åˆ°Â sonarÂ å¹³å°ä¸Šæ¥å±•ç¤ºã€‚

ä¸€èˆ¬æ¥è¯´æˆ‘ä»¬è¦æ±‚å•æµ‹è¦†ç›–ç‡ä¸ä½äº80%

## é™æ€ä»£ç åˆ†æ
åœ¨éœ€è¦è¿›è¡Œé™æ€ä»£ç æ‰«æçš„ç›®å½•ä¸‹æ‰§è¡ŒÂ golangci-lintÂ runÂ ï¼Œæ­¤å‘½ä»¤å’ŒÂ golangci-lintÂ runÂ ./â€¦Â å‘½ä»¤ç­‰æ•ˆï¼Œè¡¨ç¤ºæ‰«ææ•´ä¸ªé¡¹ç›®æ–‡ä»¶ä»£ç ï¼Œå¹¶è¿›è¡Œç›‘æµ‹ï¼Œä¹Ÿ  
å¯ä»¥é€šè¿‡æŒ‡å®šÂ goÂ æ–‡ä»¶æˆ–è€…æ–‡ä»¶ç›®å½•åæ¥å¯¹ç‰¹å®šçš„ä»£ç æ–‡ä»¶æˆ–è€…ç›®å½•è¿›è¡Œä»£ç æ‰«æï¼Œä¾‹å¦‚Â golangci-lintÂ runÂ dir1Â dir2/...Â dir3/file1.goÂ ã€‚

# é™æµ
ğŸ é™æµç®—æ³•éƒ½åŒ…æ‹¬å“ªäº›ï¼Ÿ
æ¼æ¡¶ï¼Œä»¤ç‰Œï¼Œbbrï¼Œæ»‘åŠ¨çª—å£ã€‚
æ¼æ¡¶çš„ç¼ºç‚¹æ˜¯æ— æ³•æœ€å¤§åŒ–åˆ©ç”¨ç³»ç»Ÿæ€§èƒ½ï¼Œä¼˜ç‚¹æ˜¯æ’å®šçš„é€Ÿç‡
å¹¶ä¸”æ¼æ¡¶ä¸­æ‰€æœ‰çš„è¯·æ±‚éƒ½éœ€è¦ç­‰å¾…ï¼Œè€Œä¸”è¯·æ±‚å¤ªå¤šè¶…å‡ºæ¼æ¡¶å°±ä¼šç›´æ¥æ‹’ç»ã€‚
ä»¤ç‰Œçš„ä¼˜ç‚¹æ˜¯ä»¤ç‰Œç”¨å®Œçš„æ—¶å€™æ˜¯æ’å®šçš„é€Ÿç‡ï¼Œæ²¡ç”¨å®Œçš„æ—¶å€™å¯ä»¥åŠ å¿«ç³»ç»Ÿçš„qpsã€‚
ä»¤ç‰Œæ¡¶ä¸­è·å–ä¸åˆ°ä»¤ç‰Œçš„ä¹Ÿæ˜¯éœ€è¦ç­‰å¾…ä¸€æ®µæ—¶é—´ã€‚

æ»‘åŠ¨çª—å£çš„ç¡®å®šæ˜¯å¦‚æœåœ¨çª—å£åˆæœŸå°±å¤§é‡è¯·æ±‚ï¼Œåç»­ä¸€æ®µæ—¶é—´éƒ½ç³»ç»Ÿä¸å¯ç”¨äº†ã€‚
bbrå°±æ˜¯å¯ä»¥é€šè¿‡ç³»ç»Ÿçš„åé¦ˆæ¥è°ƒæ•´æµé‡ï¼Œæ¯”è¾ƒä¸å—åˆ°å›ºå®šå‚æ•°çš„å½±å“ï¼Œæ²¡é‚£ä¹ˆæ­»æ¿éœ€è¦æ€»æ˜¯è°ƒæ•´ã€‚

ğŸ ä¸åŒçš„é™æµç®—æ³•æ€ä¹ˆé€‰ï¼Ÿ
äº’ç›¸è¡¥å……ï¼Œæ¯”å¦‚å¯¹äºå•†å“ç³»ç»Ÿçš„æŸäº›æ¥å£ï¼Œå¯ä»¥å…ˆå…¨å±€é™æµé‡‡ç”¨ä»¤ç‰Œæ¡¶çš„åšæ³•ä½¿ç”¨å‹æµ‹çš„ç»“æœå€¼ï¼Œé˜²æ­¢åç»­çš„bbrå…¬å¼é¢„æµ‹ä¸å‡†ï¼Œå› ä¸ºæœ‰å¯èƒ½cpuæ²¡æœ‰è¾¾åˆ°80%ä½†æ˜¯æ•°æ®åº“å·²ç»æ‰›ä¸ä½äº†ã€‚
bbrç”¨äºå•ä¸ªæœåŠ¡cpuçš„æ§åˆ¶ï¼Œä»¥åŠåº”å¯¹çªå‘æµé‡ã€‚

ğŸ é™æµçš„å¯¹è±¡åº”è¯¥å¦‚ä½•é€‰æ‹©ï¼Ÿ

ğŸ æ€ä¹ˆç¡®å®šæµé‡çš„é˜ˆå€¼ï¼Ÿ

ğŸ å¦‚ä½•åº”å¯¹çªå‘æµé‡ï¼Ÿ

ğŸ è¢«é™æµçš„è¯·æ±‚ä¼šè¢«æ€ä¹ˆå¤„ç†ï¼Ÿ
ç³»ç»Ÿç¹å¿™ï¼Œç¨åé‡è¯•ã€‚
ğŸ ä¸ºä»€ä¹ˆä½¿ç”¨äº†é™æµï¼Œç³»ç»Ÿè¿˜æ˜¯æœ‰å¯èƒ½å´©æºƒï¼Ÿ

ğŸ æˆ‘ä»¬æœ‰ä¸€ä¸ªåŠŸèƒ½ï¼Œå¯¹äºæ™®é€šç”¨æˆ·æ¥è¯´ï¼Œä¸€äº›æ¥å£éœ€è¦é™åˆ¶åœ¨æ¯åˆ†é’Ÿä¸è¶…è¿‡ 10 æ¬¡ï¼Œæ•´å¤©ä¸èƒ½è¶…è¿‡ 1000 æ¬¡ï¼›VIP ç”¨æˆ·ä¸é™åˆ¶ã€‚ä½ æ€ä¹ˆè§£å†³è¿™ä¸ªé—®é¢˜ï¼Ÿ
é€šè¿‡redisè®¾ç½®ä¸¤ä¸ªzsetç”¨æ¥é™æµï¼Œä½†æ˜¯vipç”¨æˆ·ä¸è®¾ç½®rediså°±è¡Œã€‚
## kong æ ¹æ®ipé™æµ

## å…³é”®è·¯å¾„å…¨å±€é™æµ
æ ¹æ®rediså…¨å±€é™æµï¼Œé™æµçš„æ ‡å‡†æ˜¯å‹æµ‹çš„ç»“æœï¼Œä¾‹å¦‚è®¢å•æ˜¯600tpsï¼Œå•†å“åˆ—è¡¨æ˜¯1000qps
## æ™®é€šè·¯å¾„æœ¬åœ°é™æµ
bbrå’Œè‡ªé€‚åº”ç†”æ–­çš„è§£å†³çš„ç—›ç‚¹éƒ½æ˜¯é¢‘ç¹å¼€å…³ï¼Œä»¥åŠç§’çš„ç»´åº¦å¤ªè¿‡ç²—æ”¾ï¼Œæå¾—åƒä¸ªé˜€é—¨ä¸€æ ·ä¸è¡Œã€‚
ç¼ºç‚¹æ˜¯å…¬å¼çš„åˆ¤æ–­å®¹æ˜“è¯¯åˆ¤ï¼Œå¯¼è‡´æ— æ³•åŠæ—¶è§£å†³ä¸‹æ¸¸çš„é—®é¢˜ã€‚


bbrå’Œè‡ªé€‚åº”éƒ½æ˜¯æ ¹æ®å¤šå°‘ç§’å†…æœ‰å¤šå°‘ä¸ªçª—å£è¿™ç§å‚æ•°æ¥å¼„æ»‘åŠ¨çª—å£è¿›è¡Œ å…¬å¼æ•°æ®çš„ç”Ÿæˆã€‚
ä¸€èˆ¬æ¥è¯´æˆ‘ä»¬æ˜¯5s,50ä¸ªçª—å£ï¼Œä¹Ÿå°±æ˜¯200msä¸€ä¸ªæ¡¶ã€‚
è‡³äºä¸ºä»€ä¹ˆæ˜¯5s,50ä¸ªçª—å£ï¼Œä¸»è¦æ˜¯å°±æ˜¯ä¸ºäº†ç»´æŠ¤200msä¸€ä¸ªæ¡¶ï¼Œ200msæ˜¯å¾ˆå¤šdbå’Œrediså’Œesè¦è¿”å›çš„ä¸€ä¸ªèŒƒå›´ï¼Œä¹Ÿæ˜¯ä¸€ä¸ªæœ€å°çš„åŸå­å•ä½ã€‚
bbrå’Œç†”æ–­éƒ½æ˜¯æ ¹æ®æ»‘åŠ¨çª—å£çš„æ»šåŠ¨æ¥è¿›è¡Œå…¬å¼çš„è®¡ç®—æ¥è¿›è¡Œè‡ªé€‚åº”çš„

æ¼æ–—æ¡¶/ä»¤ç‰Œæ¡¶ç¡®å®èƒ½å¤Ÿä¿æŠ¤ç³»ç»Ÿä¸è¢«æ‹–å®, ä½†ä¸ç®¡æ¼æ–—æ¡¶è¿˜æ˜¯ä»¤ç‰Œæ¡¶, å…¶é˜²æŠ¤æ€è·¯éƒ½æ˜¯è®¾å®šä¸€ä¸ªæŒ‡æ ‡, å½“è¶…è¿‡è¯¥æŒ‡æ ‡åå°±é˜»æ­¢æˆ–å‡å°‘æµé‡çš„ç»§ç»­è¿›å…¥ï¼Œå½“ç³»ç»Ÿè´Ÿè½½é™ä½åˆ°æŸä¸€æ°´å¹³ååˆ™æ¢å¤æµé‡çš„è¿›å…¥ã€‚ä½†å…¶é€šå¸¸éƒ½æ˜¯è¢«åŠ¨çš„ï¼Œå…¶å®é™…æ•ˆæœå–å†³äºé™æµé˜ˆå€¼è®¾ç½®æ˜¯å¦åˆç†ï¼Œä½†å¾€å¾€è®¾ç½®åˆç†ä¸æ˜¯ä¸€ä»¶å®¹æ˜“çš„äº‹æƒ….

é¡¹ç›®æ—¥å¸¸ç»´æŠ¤ä¸­, ç»å¸¸èƒ½å¤Ÿçœ‹åˆ°æŸæŸåŒå­¦åœ¨ç¾¤é‡Œè¯´:xxç³»ç»Ÿ429äº†, ç„¶åç»è¿‡ä¸€ç•ªæŸ¥æ‰¾åå‘ç°æ˜¯ä¸€æ³¢çªç„¶çš„æ´»åŠ¨æµé‡, åªèƒ½ç”³è¯·å†æ–°å¢å‡ å°æœºå™¨. è¿‡äº†å‡ å¤© OP å‘ç°è¯¥é›†ç¾¤çš„æµé‡è¾¾ä¸åˆ°é¢„æœŸåˆä¸‹æ‰äº†å‡ å°æœºå™¨, ç„¶ååˆå¼€å§‹ä¸€è½®æ–°çš„å¾ªç¯.

è¿™é‡Œå…ˆä¸è®¨è®ºé›†ç¾¤è‡ªåŠ¨ä¼¸ç¼©çš„é—®é¢˜. è¿™é‡Œæå‡ºä¸€äº›é—®é¢˜

1. é›†ç¾¤å¢åŠ æœºå™¨æˆ–è€…å‡å°‘æœºå™¨é™æµé˜ˆå€¼æ˜¯å¦è¦é‡æ–°è®¾ç½®?
2. è®¾ç½®é™æµé˜ˆå€¼çš„ä¾æ®æ˜¯ä»€ä¹ˆ?
3. äººåŠ›è¿ç»´æˆæœ¬æ˜¯å¦è¿‡é«˜?
4. å½“è°ƒç”¨æ–¹åé¦ˆ429æ—¶, è¿™ä¸ªæ—¶å€™é‡æ–°è®¾ç½®é™æµ, å…¶å®æµé‡é«˜å³°å·²ç»è¿‡äº†é‡æ–°è¯„ä¼°é™æµæ˜¯å¦æœ‰æ„ä¹‰?

è¿™äº›å…¶å®éƒ½æ˜¯é‡‡ç”¨æ¼æ–—æ¡¶/ä»¤ç‰Œæ¡¶çš„ç¼ºç‚¹, æ€»ä½“æ¥è¯´å°±æ˜¯å¤ªè¢«åŠ¨, ä¸èƒ½å¿«é€Ÿé€‚åº”æµé‡å˜åŒ–

TCPÂ BBRÂ æ‹¥å¡æ§åˆ¶ç®—æ³•Â çš„æ€æƒ³ç»™äº†æˆ‘ä»¬ä¸€ä¸ªå¾ˆå¤§çš„å¯å‘ã€‚æˆ‘ä»¬åº”è¯¥æ ¹æ®ç³»ç»Ÿèƒ½å¤Ÿå¤„ç†çš„è¯·æ±‚ï¼Œå’Œå…è®¸è¿›æ¥çš„è¯·æ±‚ï¼Œæ¥åšå¹³è¡¡ï¼Œè€Œä¸æ˜¯æ ¹æ®ä¸€ä¸ªé—´æ¥çš„æŒ‡æ ‡ï¼ˆç³»ç»ŸÂ loadï¼‰æ¥åšé™æµã€‚æœ€ç»ˆæˆ‘ä»¬è¿½æ±‚çš„ç›®æ ‡æ˜¯Â åœ¨ç³»ç»Ÿä¸è¢«æ‹–å®çš„æƒ…å†µä¸‹ï¼Œæé«˜ç³»ç»Ÿçš„ååç‡ï¼Œè€Œä¸æ˜¯Â loadÂ ä¸€å®šè¦åˆ°ä½äºæŸä¸ªé˜ˆå€¼ã€‚å¦‚æœæˆ‘ä»¬è¿˜æ˜¯æŒ‰ç…§å›ºæœ‰çš„æ€ç»´ï¼Œè¶…è¿‡ç‰¹å®šçš„Â loadÂ å°±ç¦æ­¢æµé‡è¿›å…¥ï¼Œç³»ç»ŸÂ loadÂ æ¢å¤å°±æ”¾å¼€æµé‡ï¼Œè¿™æ ·åšçš„ç»“æœæ˜¯æ— è®ºæˆ‘ä»¬æ€ä¹ˆè°ƒå‚æ•°ï¼Œè°ƒæ¯”ä¾‹ï¼Œéƒ½æ˜¯æŒ‰ç…§æœæ¥è°ƒèŠ‚å› ï¼Œéƒ½æ— æ³•å–å¾—è‰¯å¥½çš„æ•ˆæœã€‚

kratosÂ è‡ªé€‚åº”é™æµåˆ†æ  
é™æµå…¬å¼  
(cpuÂ >Â 800Â ORÂ (NowÂ -Â PrevDrop)Â <Â 1s)Â ANDÂ (MaxPassÂ *Â MinRtÂ *Â windowsÂ /Â 1000)Â <Â InFlight  
ä¸ºtrueä»£è¡¨è¦é™æµ
é‡‡é›†cpuç”¨çš„shirou/gopsutil/cpu è¿™ä¸ªåº“æ¥é‡‡é›†cgroupä¸­çš„cpu
cpuÂ >Â 800Â Â è¡¨ç¤ºÂ CPUÂ è´Ÿè½½å¤§äºÂ 80%Â è¿›å…¥é™æµ  
(NowÂ -Â PrevDrop)Â <Â 1sÂ Â è¿™ä¸ªè¡¨ç¤ºåªè¦è§¦å‘è¿‡Â 1Â æ¬¡é™æµï¼Œé‚£ä¹ˆÂ 1sÂ å†…éƒ½ä¼šå»åšé™æµçš„åˆ¤å®šï¼Œè¿™æ˜¯ä¸ºäº†é¿å…åå¤å‡ºç°é™æµæ¢å¤å¯¼è‡´è¯·æ±‚æ—¶é—´å’Œç³»ç»Ÿè´Ÿè½½äº§ç”Ÿå¤§é‡æ¯›åˆº  
(MaxPassÂ *Â MinRtÂ *Â windowsÂ /Â 1000)Â <Â InFlightÂ Â åˆ¤æ–­å½“å‰è´Ÿè½½æ˜¯å¦å¤§äºæœ€å¤§è´Ÿè½½  
InFlightÂ Â è¡¨ç¤ºå½“å‰ç³»ç»Ÿä¸­æœ‰å¤šå°‘è¯·æ±‚  
(MaxPassÂ *Â MinRtÂ *Â windowsÂ /Â 1000)Â Â è¡¨ç¤ºè¿‡å»ä¸€æ®µæ—¶é—´çš„æœ€å¤§è´Ÿè½½  
MaxPassÂ Â è¡¨ç¤ºæœ€è¿‘Â 5sÂ å†…ï¼Œå•ä¸ªé‡‡æ ·çª—å£ä¸­æœ€å¤§çš„è¯·æ±‚æ•°  
MinRtÂ Â è¡¨ç¤ºæœ€è¿‘Â 5sÂ å†…ï¼Œå•ä¸ªé‡‡æ ·çª—å£ä¸­æœ€å°çš„å“åº”æ—¶é—´  
windowsÂ Â è¡¨ç¤ºä¸€ç§’å†…é‡‡æ ·çª—å£çš„æ•°é‡ï¼Œé»˜è®¤é…ç½®ä¸­æ˜¯Â 5sÂ 50Â ä¸ªé‡‡æ ·ï¼Œé‚£ä¹ˆÂ windowsÂ çš„å€¼ä¸ºÂ 10ã€‚

ä¸€å¥è¯æè¿°å°±æ˜¯ï¼Œåªæœ‰åœ¨cpuå¤§äº800çš„æ—¶å€™æ‰ä¼šå»åˆ¤æ–­æ˜¯å¦é™æµï¼Œå¦‚æœæ²¡æœ‰è¾¾åˆ°ï¼Œå†åˆ¤æ–­ä¸‹æ˜¯å¦1så†…é™æµè¿‡ã€‚å¦‚æœä¸¤è€…éƒ½æ²¡æœ‰è¾¾åˆ°ï¼Œå°±ä¸é™æµã€‚ä½†æ˜¯å¦‚æœæœ‰ä¸€è€…ä¸ºtrueï¼Œé‚£ä¹ˆå°±è·å–æ‰€æœ‰æ¡¶ä¸­æœ€å¤§çš„é€šè¿‡æ•°å’Œæœ€å°rtï¼Œç›¸ä¹˜åï¼Œä¹˜ä»¥ä¸€ç§’å†…æ‹¥æœ‰çš„æ¡¶æ•°ï¼Œå†é™¤ä»¥1000msï¼Œè·å–msçš„ç†æƒ³è¯·æ±‚æ•°æ˜¯å¦å°äºå½“å‰è¯·æ±‚æ•°ï¼Œå¦‚æœæ˜¯ï¼Œè¯´æ˜ä¸ç†æƒ³è¦é™æµã€‚
[![Goå¯ç”¨æ€§ é™æµ-åˆ†å¸ƒå¼é™æµ-kratos é™æµç­–ç•¥.png](https://img.lailin.xyz/image/1618158541909-f94f46a3-fad8-47d3-a389-395a57116c55.png)
### kratos ä¸­é—´ä»¶å®ç°

```golang
func (b *RateLimiter) Limit() HandlerFunc {
	return func(c *Context) {
		uri := fmt.Sprintf("%s://%s%s", c.Request.URL.Scheme, c.Request.Host, c.Request.URL.Path)
		limiter := b.group.Get(uri)
		done, err := limiter.Allow(c)
		if err != nil {
			_metricServerBBR.Inc(uri, c.Request.Method)
			c.JSON(nil, err)
			c.Abort()
			return
		}
		defer func() {
			done(limit.DoneInfo{Op: limit.Success})
			b.printStats(uri, limiter)
		}()
		c.Next()
	}
}
```

ä½¿ç”¨æ–¹å¼

```golang
e := bm.DefaultServer(nil)
limiter := bm.NewRateLimiter(nil)
e.Use(limiter.Limit())
e.GET("/api", myHandler)
```

### æºç å®ç°

#### Allow

```golang
func (l *BBR) Allow(ctx context.Context, opts ...limit.AllowOption) (func(info limit.DoneInfo), error) {
	allowOpts := limit.DefaultAllowOpts()
	for _, opt := range opts {
		opt.Apply(&allowOpts)
	}
	if l.shouldDrop() { // åˆ¤æ–­æ˜¯å¦è§¦å‘é™æµ
		return nil, ecode.LimitExceed
	}
	atomic.AddInt64(&l.inFlight, 1) // å¢åŠ æ­£åœ¨å¤„ç†è¯·æ±‚æ•°
	stime := time.Since(initTime) // è®°å½•è¯·æ±‚åˆ°æ¥çš„æ—¶é—´
	return func(do limit.DoneInfo) {
		rt := int64((time.Since(initTime) - stime) / time.Millisecond) // è¯·æ±‚å¤„ç†æˆåŠŸçš„å“åº”æ—¶é•¿
		l.rtStat.Add(rt) // å¢åŠ rtStatå“åº”è€—æ—¶çš„ç»Ÿè®¡
		atomic.AddInt64(&l.inFlight, -1) // è¯·æ±‚å¤„ç†æˆåŠŸå, å‡å°‘æ­£åœ¨å¤„ç†çš„è¯·æ±‚æ•°
		switch do.Op {
		case limit.Success:
			l.passStat.Add(1) // å¤„ç†æˆåŠŸåå¢åŠ æˆåŠŸå¤„ç†è¯·æ±‚æ•°çš„ç»Ÿè®¡
			return
		default:
			return
		}
	}, nil
}
```

#### shouldDrop

```golang
func (l *BBR) shouldDrop() bool {
	// åˆ¤æ–­ç›®å‰cpuçš„ä½¿ç”¨ç‡æ˜¯å¦è¾¾åˆ°è®¾ç½®çš„CPUçš„é™åˆ¶, é»˜è®¤å€¼800
	if l.cpu() < l.conf.CPUThreshold { 
		// å¦‚æœä¸Šä¸€æ¬¡èˆå¼ƒè¯·æ±‚çš„æ—¶é—´æ˜¯0, é‚£ä¹ˆè¯´æ˜æ²¡æœ‰é™æµçš„éœ€æ±‚, ç›´æ¥è¿”å›
		prevDrop, _ := l.prevDrop.Load().(time.Duration)
		if prevDrop == 0 {
			return false
		}
		// å¦‚æœä¸Šä¸€æ¬¡è¯·æ±‚çš„æ—¶é—´ä¸å½“å‰çš„è¯·æ±‚æ—¶é—´å°äº1s, é‚£ä¹ˆè¯´æ˜æœ‰é™æµçš„éœ€æ±‚
		if time.Since(initTime)-prevDrop <= time.Second {
			if atomic.LoadInt32(&l.prevDropHit) == 0 {
				atomic.StoreInt32(&l.prevDropHit, 1)
			}
			// å¢åŠ æ­£åœ¨å¤„ç†çš„è¯·æ±‚çš„æ•°é‡
			inFlight := atomic.LoadInt64(&l.inFlight)
			// åˆ¤æ–­æ­£åœ¨å¤„ç†çš„è¯·æ±‚æ•°æ˜¯å¦è¾¾åˆ°ç³»ç»Ÿçš„æœ€å¤§çš„è¯·æ±‚æ•°é‡
			return inFlight > 1 && inFlight > l.maxFlight()
		}
		// æ¸…ç©ºå½“å‰çš„prevDrop
		l.prevDrop.Store(time.Duration(0))
		return false
	}
	// å¢åŠ æ­£åœ¨å¤„ç†çš„è¯·æ±‚çš„æ•°é‡
	inFlight := atomic.LoadInt64(&l.inFlight)
	// åˆ¤æ–­æ­£åœ¨å¤„ç†çš„è¯·æ±‚æ•°æ˜¯å¦è¾¾åˆ°ç³»ç»Ÿçš„æœ€å¤§çš„è¯·æ±‚æ•°é‡
	drop := inFlight > 1 && inFlight > l.maxFlight()
	if drop {
		prevDrop, _ := l.prevDrop.Load().(time.Duration)
		// å¦‚æœåˆ¤æ–­è¾¾åˆ°äº†æœ€å¤§è¯·æ±‚æ•°é‡, å¹¶ä¸”å½“å‰æœ‰é™æµéœ€æ±‚
		if prevDrop != 0 {
			return drop
		}
		l.prevDrop.Store(time.Since(initTime))
	}
	return drop
}
```

#### maxFlight

è¯¥å‡½æ•°æ˜¯æ ¸å¿ƒå‡½æ•°. å…¶è®¡ç®—å…¬å¼: MaxPass * MinRt * windows / 1000. maxPASS/minRTéƒ½æ˜¯åŸºäº`metric.RollingCounter`æ¥å®ç°çš„, é™äºç¯‡å¹…åŸå› è¿™é‡Œå°±ä¸å†å…·ä½“çœ‹å…¶å®ç°(æƒ³çœ‹çš„å¯ä»¥å»çœ‹rolling_counter_test.goè¿˜æ˜¯è›®å®¹æ˜“ç†è§£çš„)

```golang
func (l *BBR) maxFlight() int64 {
	return int64(math.Floor(float64(l.maxPASS()*l.minRT()*l.winBucketPerSec)/1000.0 + 0.5))
}
```

- winBucketPerSec: æ¯ç§’å†…çš„é‡‡æ ·æ•°é‡,å…¶è®¡ç®—æ–¹å¼:int64(time.Second)/(int64(conf.Window)/int64(conf.WinBucket)), conf.Windowé»˜è®¤å€¼10s, conf.WinBucketé»˜è®¤å€¼100. ç®€åŒ–ä¸‹å…¬å¼: 1/(10/100) = 10, æ‰€ä»¥æ¯ç§’å†…çš„é‡‡æ ·æ•°å°±æ˜¯10

```golang
// å•ä¸ªé‡‡æ ·çª—å£åœ¨ä¸€ä¸ªé‡‡æ ·å‘¨æœŸä¸­çš„æœ€å¤§çš„è¯·æ±‚æ•°, é»˜è®¤çš„é‡‡æ ·çª—å£æ˜¯10s, é‡‡æ ·bucketæ•°é‡100
func (l *BBR) maxPASS() int64 {
	rawMaxPass := atomic.LoadInt64(&l.rawMaxPASS)
	if rawMaxPass > 0 && l.passStat.Timespan() < 1 {
		return rawMaxPass
	}
	// éå†100ä¸ªé‡‡æ ·bucket, æ‰¾åˆ°é‡‡æ ·bucketä¸­æœ€å¤§çš„è¯·æ±‚æ•°
	rawMaxPass = int64(l.passStat.Reduce(func(iterator metric.Iterator) float64 {
		var result = 1.0
		for i := 1; iterator.Next() && i < l.conf.WinBucket; i++ {
			bucket := iterator.Bucket()
			count := 0.0
			for _, p := range bucket.Points {
				count += p
			}
			result = math.Max(result, count)
		}
		return result
	}))
	if rawMaxPass == 0 {
		rawMaxPass = 1
	}
	atomic.StoreInt64(&l.rawMaxPASS, rawMaxPass)
	return rawMaxPass
}

// å•ä¸ªé‡‡æ ·çª—å£ä¸­æœ€å°çš„å“åº”æ—¶é—´
func (l *BBR) minRT() int64 {
	rawMinRT := atomic.LoadInt64(&l.rawMinRt)
	if rawMinRT > 0 && l.rtStat.Timespan() < 1 {
		return rawMinRT
	}
	// éå†100ä¸ªé‡‡æ ·bucket, æ‰¾åˆ°é‡‡æ ·bucketä¸­æœ€å°çš„å“åº”æ—¶é—´
	rawMinRT = int64(math.Ceil(l.rtStat.Reduce(func(iterator metric.Iterator) float64 {
		var result = math.MaxFloat64
		for i := 1; iterator.Next() && i < l.conf.WinBucket; i++ {
			bucket := iterator.Bucket()
			if len(bucket.Points) == 0 {
				continue
			}
			total := 0.0
			for _, p := range bucket.Points {
				total += p
			}
			avg := total / float64(bucket.Count)
			result = math.Min(result, avg)
		}
		return result
	})))
	if rawMinRT <= 0 {
		rawMinRT = 1
	}
	atomic.StoreInt64(&l.rawMinRt, rawMinRT)
	return rawMinRT
}
```
# ç†”æ–­

ğŸ”¥ ä¸ºä»€ä¹ˆè¯´ç†”æ–­å¯ä»¥æé«˜ç³»ç»Ÿçš„å¯ç”¨æ€§ï¼Ÿ

ğŸ”¥ å¦‚ä½•åˆ¤æ–­èŠ‚ç‚¹çš„å¥åº·çŠ¶æ€ï¼Œéœ€è¦çœ‹å“ªäº›æŒ‡æ ‡ï¼Ÿ
å“åº”æ—¶é—´ï¼Œå¼‚å¸¸çŠ¶æ€æŒç»­æ—¶é—´

ğŸ”¥ è§¦å‘ç†”æ–­ä¹‹åï¼Œè¯¥ç†”æ–­å¤šä¹…ï¼Ÿ

ğŸ”¥ å“åº”æ—¶é—´è¶…è¿‡å¤šå°‘åº”è¯¥è§¦å‘ç†”æ–­ï¼Ÿ

ğŸ”¥ å“åº”æ—¶é—´è¶…è¿‡é˜ˆå€¼å°±ä¸€å®šè¦è§¦å‘ç†”æ–­å—ï¼Ÿ
å¼‚å¸¸çŠ¶æ€æŒç»­ä¸€æ®µæ—¶é—´
ğŸ”¥ æ€ä¹ˆé¿å…å¶å‘æ€§è¶…è¿‡é˜ˆå€¼çš„æƒ…å†µï¼Ÿ
å¼‚å¸¸çŠ¶æ€æŒç»­ä¸€æ®µæ—¶é—´
ğŸ”¥ æœåŠ¡ç†”æ–­åå¦‚ä½•æ¢å¤ï¼Ÿ
åŠæ‰“å¼€
ğŸ”¥ äº§ç”ŸæŠ–åŠ¨çš„åŸå› ï¼Œä»¥åŠå¦‚ä½•è§£å†³æŠ–åŠ¨é—®é¢˜ï¼Ÿ
é€‰æ‹©çš„ç†”æ–­æ ‡å‡†ä¸æ­£å¸¸ï¼Œä¾‹å¦‚è®¾ç½®çš„å“åº”æ—¶é—´è¿‡å°ï¼Œå¯¼è‡´ç³»ç»Ÿè¯·æ±‚ç¨å¾®ä¸€ä¸Šæ¥å°±å‡ºé—®é¢˜ã€‚
æ‰“å¼€å’Œå…³é—­çš„é¢‘ç‡è¿‡é«˜ã€‚ç¬¬ä¸€ä¸ªåŸå› æ˜¯ä¸Šé¢çš„æ ‡å‡†è¿‡ä¸¥ï¼Œç¬¬äºŒä¸ªåŸå› æ˜¯å¤ªè¿‡å®¹æ˜“å°±å…³é—­ç†”æ–­äº†ï¼Œä¾‹å¦‚æ‰“å¼€ç†”æ–­ååªè¦åŠæ‰“å¼€è¿‡ç¨‹ä¸­åªè¦æœ‰ä¸€ä¸ªè¯·æ±‚æˆåŠŸå°±å…³é—­ç†”æ–­ï¼Œä½†æ˜¯åç»­çš„è¯·æ±‚åˆæ˜¯ä¸€å¤§ç‰‡æœ‰é—®é¢˜çš„åˆç«‹åˆ»æ‰“å¼€ç†”æ–­äº†ã€‚
## ç®€å•çš„ç†”æ–­
ä¹‹å‰çš„æ–‡ç« ï¼Œåˆ†æäº†Â Hystrix-GoÂ ç†”æ–­ç®—æ³•çš„å®ç°ï¼Œå…¶ç®—æ³•æ ¸å¿ƒæ˜¯ï¼šå½“è¯·æ±‚å¤±è´¥æ¯”ç‡è¾¾åˆ°ä¸€å®šé˜ˆå€¼ä¹‹åï¼Œç†”æ–­å™¨å¼€å¯ï¼Œå¹¶ä¼‘çœ ä¸€æ®µæ—¶é—´ï¼ˆç”±é…ç½®å†³å®šï¼‰ï¼Œè¿™æ®µä¼‘çœ æœŸè¿‡åï¼Œç†”æ–­å™¨å°†å¤„äºåŠå¼€çŠ¶æ€ï¼Œåœ¨æ­¤çŠ¶æ€ä¸‹å°†è¯•æ¢æ€§çš„æ”¾è¿‡ä¸€éƒ¨åˆ†æµé‡ï¼Œå¦‚æœè¿™éƒ¨åˆ†æµé‡è°ƒç”¨æˆåŠŸåï¼Œå†æ¬¡å°†ç†”æ–­å™¨å…³é—­ï¼Œå¦åˆ™ç†”æ–­å™¨ç»§ç»­ä¿æŒå¼€å¯å¹¶è¿›å…¥ä¸‹ä¸€è½®ä¼‘çœ å‘¨æœŸã€‚  
  
ä½†è¿™ä¸ªç†”æ–­ç®—æ³•æœ‰ä¸€ä¸ªé—®é¢˜ï¼Œè¿‡äºä¸€åˆ€åˆ‡ã€‚æ˜¯å¦å¯ä»¥åšåˆ°åœ¨ç†”æ–­å™¨å¼€å¯çŠ¶æ€ä¸‹ï¼ˆä½†æ˜¯åç«¯æœªÂ Shutdownï¼‰ä»ç„¶å¯ä»¥æ”¾è¡Œå°‘éƒ¨åˆ†æµé‡å‘¢ï¼Ÿå½“ç„¶ï¼Œè¿™é‡Œæœ‰ä¸ªå‰æï¼Œéœ€è¦çœ‹åç«¯æ­¤æ—¶è¿˜èƒ½å¤Ÿæ¥å—å¤šå°‘æµé‡ã€‚ä¸‹ä¸€æ­¥æˆ‘ä»¬æ¥çœ‹çœ‹Â GoogleÂ çš„ç­–ç•¥å®ç°ã€‚

ä»€ä¹ˆæ—¶å€™åˆ¤å®šæœåŠ¡éœ€è¦è§¦å‘ç†”æ–­ï¼Œä¸ºä»€ä¹ˆé€‰ç”¨è¿™ä¸ªæŒ‡æ ‡ã€‚  
  
å‡å¦‚è¯´ä½ å‡†å¤‡ç”¨å“åº”æ—¶é—´æ¥ä½œä¸ºæŒ‡æ ‡ï¼Œé‚£ä¹ˆä½ å¯ä»¥è¿™ä¹ˆå›ç­”ï¼Œå…³é”®è¯æ˜¯æŒç»­è¶…è¿‡é˜ˆå€¼ã€‚  
  
ä¸ºäº†ä¿éšœå¾®æœåŠ¡çš„å¯ç”¨æ€§ï¼Œæˆ‘åœ¨æˆ‘çš„æ ¸å¿ƒæœåŠ¡é‡Œé¢æ¥å…¥äº†ç†”æ–­ã€‚é’ˆå¯¹ä¸åŒçš„æœåŠ¡ï¼Œæˆ‘è®¾è®¡äº†ä¸åŒçš„å¾®æœåŠ¡ç†”æ–­ç­–ç•¥ã€‚  
  
æ¯”å¦‚è¯´æœ€ç®€å•çš„ç†”æ–­ç­–ç•¥å°±æ˜¯æ ¹æ®å“åº”æ—¶é—´æ¥è¿›è¡Œã€‚å½“å“åº”æ—¶é—´è¶…è¿‡é˜ˆå€¼ä¸€æ®µæ—¶é—´ä¹‹åå°±ä¼šè§¦å‘ç†”æ–­ã€‚æˆ‘ä¸€èˆ¬ä¼šæ ¹æ®ä¸šåŠ¡æƒ…å†µæ¥é€‰æ‹©è¿™ä¸ªé˜ˆå€¼ï¼Œä¾‹å¦‚ï¼Œå¦‚æœäº§å“ç»ç†è¦æ±‚å“åº”æ—¶é—´æ˜¯1sï¼Œé‚£ä¹ˆæˆ‘ä¼šæŠŠé˜ˆå€¼è®¾å®šåœ¨1.2sã€‚å¦‚æœå“åº”æ—¶é—´è¶…è¿‡1.2sï¼Œå¹¶ä¸”æŒç»­ä¸‰åç§’ï¼Œå°±ä¼šè§¦å‘ç†”æ–­ã€‚åœ¨è§¦å‘ç†”æ–­çš„æƒ…å†µä¸‹ï¼Œæ–°è¯·æ±‚ä¼šè¢«æ‹’ç»ï¼Œè€Œå·²æœ‰çš„è¯·æ±‚è¿˜æ˜¯ä¼šè¢«ç»§ç»­å¤„ç†ï¼Œç›´åˆ°æœåŠ¡æ¢å¤æ­£å¸¸ã€‚

å…³é—­(closed):Â å…³é—­çŠ¶æ€ä¸‹æ²¡æœ‰è§¦å‘æ–­è·¯ä¿æŠ¤ï¼Œæ‰€æœ‰çš„è¯·æ±‚éƒ½æ­£å¸¸é€šè¡Œ  
æ‰“å¼€(open):Â å½“é”™è¯¯é˜ˆå€¼è§¦å‘ä¹‹åï¼Œå°±è¿›å…¥å¼€å¯çŠ¶æ€ï¼Œè¿™ä¸ªæ—¶å€™æ‰€æœ‰çš„æµé‡éƒ½ä¼šè¢«èŠ‚æµï¼Œä¸è¿è¡Œé€šè¡Œ  
åŠæ‰“å¼€(half-open):Â å¤„äºæ‰“å¼€çŠ¶æ€ä¸€æ®µæ—¶é—´ä¹‹åï¼Œä¼šå°è¯•å°è¯•æ”¾è¡Œä¸€ä¸ªæµé‡æ¥æ¢æµ‹å½“å‰Â serverÂ ç«¯æ˜¯å¦å¯ä»¥æ¥æ”¶æ–°æµé‡ï¼Œå¦‚æœè¿™ä¸ªæ²¡æœ‰é—®é¢˜å°±ä¼šè¿›å…¥å…³é—­çŠ¶æ€ï¼Œå¦‚æœæœ‰é—®é¢˜åˆä¼šå›åˆ°æ‰“å¼€çŠ¶æ€
## google sreBreaker

æˆ‘ä»¬æ‰“ç®—ä½¿ç”¨çš„æ–¹æ³•ï¼š
```
max(0, (requests-k*accepts)/(requests+1) )
```

ç®—æ³•å¦‚ä¸Šæ‰€ç¤ºï¼Œè¿™ä¸ªå…¬å¼è®¡ç®—çš„æ˜¯è¯·æ±‚è¢«ä¸¢å¼ƒçš„æ¦‚ç‡[3]  
  
requests:Â ä¸€æ®µæ—¶é—´çš„è¯·æ±‚æ•°é‡  
accepts:Â æˆåŠŸçš„è¯·æ±‚æ•°é‡  
K:Â å€ç‡ï¼ŒKÂ è¶Šå°è¡¨ç¤ºè¶Šæ¿€è¿›ï¼Œè¶Šå°è¡¨ç¤ºè¶Šå®¹æ˜“è¢«ä¸¢å¼ƒè¯·æ±‚  



ä¾‹å¦‚k=1.1 å°±è¯´æ˜åä¸ªè¯·æ±‚ä¸­åªè¦æœ‰ä¸€ä¸ªè¯·æ±‚å‡ºé—®é¢˜ï¼Œå°±å‡ºç°æ¦‚ç‡ç†”æ–­,ä¹Ÿå°±æ˜¯åä¸ªè¯·æ±‚ä¸­æˆåŠŸçš„è¯·æ±‚å°äº9å°±å‡ºé—®é¢˜ã€‚

k=1.6,å°±è¯´æ˜åä¸ªè¯·æ±‚ä¸­ï¼ŒæˆåŠŸçš„è¯·æ±‚å°äº6ä¸ªï¼Œå°±å‡ºç°æ¦‚ç‡ç†”æ–­

  

è¿™é‡Œé¢è¦é…åˆæ»‘åŠ¨çª—å£ï¼Œæ¯”å¦‚ ä¸‰ç§’å†…åˆ†åä¸ªçª—å£å°±è¡Œï¼Œå½“ç†”æ–­å™¨å¼€å¯ï¼Œæ¯è¿‡ä¸€ä¸ªçª—å£å°±æœ‰æ¦‚ç‡é€šè¿‡è¯·æ±‚ï¼ŒçŸ¥é“æˆåŠŸæ•°ä¸Šå‡ã€‚æ¯ä¸ªçª—å£éƒ½è´Ÿè´£å­˜å‚¨countæ€»æ•°ï¼Œacceptsæ€»æ•°ã€‚æ‰€ä»¥æœ€åçš„æ€»æ•°å’ŒæˆåŠŸæ•°å°±æ˜¯æ‰€æœ‰çª—å£çš„æ€»æ•°ç›¸åŠ ï¼Œaccepptsæ€»æ•°ç›¸åŠ ã€‚

# è¶…æ—¶æ§åˆ¶


ğŸ•™ ä¸ºä»€ä¹ˆè¦åšè¶…æ—¶æ§åˆ¶ï¼Ÿ
1ã€ç¡®ä¿å®¢æˆ·ç«¯èƒ½åœ¨é¢„æœŸæ—¶é—´å†…æ‹¿åˆ°å“åº”  
2ã€åŠæ—¶é‡Šæ”¾èµ„æº  
ğŸ•™ ä¸ºä»€ä¹ˆç¼ºä¹è¶…æ—¶æ§åˆ¶æœ‰å¯èƒ½å¼•èµ·è¿æ¥æ³„éœ²ã€çº¿ç¨‹æ³„éœ²ï¼Ÿ

ğŸ•™ ä»€ä¹ˆæ˜¯é“¾è·¯è¶…æ—¶æ§åˆ¶ï¼Ÿ

ğŸ•™ å¦‚ä½•ç¡®å®šè¶…æ—¶æ—¶é—´ï¼Ÿ
ç¡®å®šè¶…æ—¶æ—¶é—´çš„æ–¹æ³•ï¼š1ã€äº§å“ç»ç†Â   
2ã€tp99,æ ¹æ®tp99Â å†—ä½™ä¸€ç‚¹ç‚¹  
3ã€åŒºåˆ†é‡è¯•å’Œéš¾ä»¥é‡è¯•çš„æ¥å£
ğŸ•™ æ€ä¹ˆåœ¨é“¾è·¯ä¸­ä¼ é€’è¶…æ—¶æ—¶é—´ï¼Ÿ
context
ğŸ•™ è¶…æ—¶æ—¶é—´ä¼ é€’çš„æ˜¯ä»€ä¹ˆï¼Ÿ

ğŸ•™ å¦‚ä½•è®¡ç®—ç½‘ç»œä¼ è¾“æ—¶é—´ï¼Ÿ

ğŸ•™ ä»€ä¹ˆæ˜¯æ—¶é’ŸåŒæ­¥é—®é¢˜ï¼Ÿ

ğŸ•™ å®¢æˆ·ç«¯å’ŒæœåŠ¡ç«¯è°æ¥ç›‘å¬è¶…æ—¶ï¼Ÿ

ğŸ•™ è¶…æ—¶ä¹‹åèƒ½ä¸èƒ½ä¸­æ–­ä¸šåŠ¡ï¼Ÿæ€ä¹ˆä¸­æ–­ï¼Ÿ

# é™çº§
ğŸ¤š ä»€ä¹ˆæ—¶å€™ä¼šç”¨åˆ°é™çº§ï¼Œè¯·ä¸¾ä¾‹è¯´æ˜ï¼Ÿ

ğŸ¤š é™çº§æœ‰ä»€ä¹ˆå¥½å¤„ï¼Ÿ

ğŸ¤š è·¨æœåŠ¡é™çº§å¸¸è§çš„åšæ³•æ˜¯ä»€ä¹ˆï¼Ÿ

ğŸ¤š ä½ æ€ä¹ˆè¯„ä¼°ä¸šåŠ¡æœåŠ¡çš„é‡è¦æ€§ï¼Ÿæˆ–è€…è¯´ï¼Œä½ æ€ä¹ˆçŸ¥é“ A æœåŠ¡æ¯” B æœåŠ¡æ›´åŠ é‡è¦ï¼Ÿ

ğŸ¤š è¯·è¯´ä¸€è¯´æœåŠ¡å†…éƒ¨å¸¸è§çš„é™çº§æ€è·¯ã€‚

ğŸ¤š æ€ä¹ˆåˆ¤æ–­å“ªäº›æœåŠ¡éœ€è¦é™çº§ï¼Ÿ

ğŸ¤š è§¦å‘é™çº§ä¹‹åï¼Œåº”è¯¥ä¿æŒåœ¨é™çº§çŠ¶æ€å¤šä¹…ï¼Ÿ

ğŸ¤š æœåŠ¡é™çº§ä¹‹åå¦‚ä½•æ¢å¤ï¼Œå¦‚ä½•ä¿è¯æ¢å¤è¿‡ç¨‹ä¸­ä¸å‘ç”ŸæŠ–åŠ¨ï¼Ÿ

ğŸ¤š ä½ ä»¬å…¬å¸çš„äº§å“é¦–é¡µæ˜¯å¦‚ä½•ä¿è¯é«˜å¯ç”¨çš„ï¼Ÿ


## é€šè¿‡ç›‘å¬nsqæ¶ˆæ¯è¿›è¡Œé™çº§

## é€šè¿‡é…ç½®æ–‡ä»¶é™çº§
# è‡ªé€‚åº”æ‰©ç¼©å®¹
## k8s hpaæ‰©å®¹


# é“¾è·¯è¿½è¸ª
## èƒŒæ™¯
2020Â å¹´ï¼Œæˆ‘ä»¬ä¸æ–­æ”¶åˆ°ä¸šåŠ¡ç ”å‘çš„åé¦ˆï¼šèƒ½ä¸èƒ½å…¨é‡é‡‡é›†Â traceï¼Ÿè¿™ä¿ƒä½¿æˆ‘ä»¬å¼€å§‹é‡æ–°æ€è€ƒå¦‚ä½•æ”¹è¿›è°ƒç”¨é“¾è¿½è¸ªç³»ç»Ÿã€‚æˆ‘ä»¬åšäº†ä¸€ä¸ªç®€å•çš„å®¹é‡é¢„ä¼°ï¼šç›®å‰Â JaegerÂ æ¯å¤©å†™å…¥Â ESÂ çš„æ•°æ®é‡æ¥è¿‘Â 100GB/å¤©ï¼Œå¦‚æœè¦å…¨é‡é‡‡é›†Â traceÂ æ•°æ®ï¼Œä¿å®ˆå‡è®¾å¹³å‡æ¯ä¸ªÂ HTTPÂ APIÂ æœåŠ¡çš„æ€»Â QPSÂ ä¸ºÂ 100ï¼Œé‚£ä¹ˆå®Œæ•´å­˜ä¸‹å…¨é‡æ•°æ®éœ€è¦Â 10TB/å¤©ï¼›ä¹è§‚å‡è®¾Â 100Â åæœåŠ¡å™¨ç ”å‘æ¯äººæ¯å¤©æŸ¥çœ‹Â 1Â æ¡Â traceï¼Œæ¯æ¡Â traceÂ çš„å¹³å‡å¤§å°ä¸ºÂ 1KBï¼Œåˆ™æ•´ä½“ä¿¡å™ªæ¯”åƒä¸‡åˆ†ä¹‹ä¸€ã€‚å¯ä»¥çœ‹å‡ºï¼Œè¿™ä»¶äº‹æƒ…æœ¬èº«çš„Â ROIÂ å¾ˆä½ï¼Œè€ƒè™‘åˆ°æœªæ¥ä¸šåŠ¡ä¼šæŒç»­å¢é•¿ï¼Œå­˜å‚¨è¿™äº›æ•°æ®çš„ä»·å€¼ä¹Ÿä¼šç»§ç»­é™ä½ï¼Œå› æ­¤å…¨é‡é‡‡é›†çš„æ–¹æ¡ˆè¢«æ”¾å¼ƒã€‚é€€ä¸€æ­¥æƒ³ï¼šå…¨é‡é‡‡é›†çœŸçš„æ˜¯æœ¬è´¨éœ€æ±‚å—ï¼Ÿå®é™…ä¸Šå¹¶éå¦‚æ­¤ï¼Œæˆ‘ä»¬æƒ³è¦çš„å…¶å®æ˜¯ã€Œæœ‰æ„æ€ã€çš„Â traceÂ å…¨é‡‡ï¼Œã€Œæ²¡æ„æ€ã€çš„Â traceÂ ä¸é‡‡ã€‚

## éœ€æ±‚

éšç€æœåŠ¡æ•°é‡çš„æ—¥ç›Šå¢åŠ ï¼Œæ‰¿æ¥å…¨é‡çš„Â TracingÂ æ•°æ®æ‰€éœ€çš„èµ„æºè¶Šæ¥è¶Šå¤šã€‚å¦‚æœå…¨é‡é‡‡é›†ï¼Œé“¾è·¯ä¸­äº§ç”Ÿçš„spanÂ æ‰€å çš„å­˜å‚¨æˆæœ¬å°†ä¼šå¾ˆé«˜ã€‚ç›®å‰ç”Ÿäº§ç¯å¢ƒé‡‡ç”¨0.1%Â çš„é‡‡é›†ç‡ï¼Œå­˜å‚¨æˆæœ¬è¾ƒä½ã€‚è¿™ç§ç­–ç•¥è™½ç„¶å¾ˆèŠ‚çœèµ„æºï¼Œä½†å…¶ç¼ºç‚¹åœ¨ä¸€æ¬¡æ¬¡çº¿ä¸Šé—®é¢˜æ’æŸ¥ä¸­é€æ¸æš´éœ²ï¼š  
  
ä¸€ä¸ªè¿›ç¨‹ä¸­åŒ…å«å¤šä¸ªæ¥å£ï¼šä¸è®ºæŒ‰å›ºå®šæ¦‚ç‡é‡‡æ ·è¿˜æ˜¯é™æµé‡‡æ ·ï¼Œéƒ½ä¼šå¯¼è‡´å°æµé‡æ¥å£ä¸€ç›´é‡‡é›†ä¸åˆ°è°ƒç”¨é“¾æ•°æ®  
çº¿ä¸ŠæœåŠ¡å‡ºé”™æ˜¯å°æ¦‚ç‡äº‹ä»¶ï¼Œå¯¼è‡´å‡ºé”™çš„è¯·æ±‚è¢«é‡‡ä¸­çš„æ¦‚ç‡æ›´å°ï¼Œå°±å¯¼è‡´é‡‡åˆ°çš„è°ƒç”¨é“¾ä¿¡æ¯é‡ä¸å¤§ï¼Œå¼•å‘é—®é¢˜çš„è°ƒç”¨é“¾å´ä¸¢å¤±çš„é—®é¢˜
## åšæ³•
TailÂ SamplingÂ Processor  
ä¸ºäº†è§£å†³è¿™äº›é—®é¢˜ï¼Œæˆ‘ä»¬å¯ä»¥é‡‡å–ä¸€ç§æ–¹æ³•ï¼Œå³å°†æ‰€æœ‰ç”Ÿæˆçš„æ•°æ®å‘é€åˆ°ä¸€ä¸ªä¸­é—´å¹³å°ï¼Œè¯¥å¹³å°ä¼šå…ˆè¿›è¡Œæš‚å­˜å’Œæ¸…æ´—ï¼Œç„¶åå†å†³å®šæ˜¯å¦è¦ä¿ç•™æˆ–ä¸¢å¼ƒæ•´ä¸ªè·Ÿè¸ªä¿¡æ¯ã€‚å…·ä½“æ“ä½œå¦‚ä¸‹å›¾æ‰€ç¤ºï¼šå½“ä¸€ä¸ªè¯·æ±‚åˆ°è¾¾æ—¶ï¼Œæ¯ä¸ªæœåŠ¡ä¼šå°†å…¶ç”Ÿæˆçš„è·Ÿè¸ªä¿¡æ¯ï¼ˆSpanï¼‰å‘é€åˆ°ä¸€ä¸ªåä¸ºOpenTelemetryÂ Collectorçš„ä¸­é—´ç»„ä»¶ã€‚åœ¨Collectorä¸Šæœ‰ä¸€ä¸ªå°¾éƒ¨é‡‡æ ·ç»„ä»¶ï¼Œè¯¥ç»„ä»¶ä¼šåœ¨æ¥æ”¶åˆ°ç¬¬ä¸€ä¸ªSpanåï¼Œç­‰å¾…ä¸€æ®µæ—¶é—´ï¼ˆä¾‹å¦‚5ç§’ï¼‰ï¼Œä»¥ä¾¿ç»§ç»­æ”¶é›†æ¥è‡ªå…¶ä»–æœåŠ¡ã€å…·æœ‰ç›¸åŒTraceÂ IDçš„Spanã€‚ç­‰å¾…æ—¶é—´ç»“æŸåï¼Œå¤§é‡çš„Spanä¼šæŒ‰ç…§å®ƒä»¬çš„TraceÂ IDè¿›è¡Œåˆ†ç±»æ±‡æ€»ï¼Œç„¶åå¯¹å±äºåŒä¸€ä¸ªTraceÂ IDçš„Spanè¿›è¡Œéå†ï¼Œä»¥æ£€æŸ¥æ˜¯å¦åŒ…å«é”™è¯¯ä¿¡æ¯ï¼Œæˆ–è€…ç´¯è®¡è€—æ—¶æ˜¯å¦è¶…è¿‡äº†é¢„è®¾çš„é˜ˆå€¼ç­‰ã€‚åŸºäºè¿™äº›ä¿¡æ¯ï¼Œå¯ä»¥æœ‰ä¾æ®åœ°ç­›é€‰å‡ºé«˜ä»·å€¼çš„è·Ÿè¸ªä¿¡æ¯ï¼Œå°†å®ƒä»¬çº³å…¥åç»­çš„å¤„ç†æµç¨‹ã€‚è¿™ç§æ–¹æ³•æœ‰åŠ©äºæ›´æœ‰æ•ˆåœ°å¤„ç†è·Ÿè¸ªæ•°æ®ï¼Œè¯†åˆ«æ½œåœ¨é—®é¢˜ï¼Œä»¥åŠæé«˜æ•´ä½“æ€§èƒ½ã€‚  
  
è¿™ç§é‡‡æ ·çš„æ¨¡å¼ç§°ä¸ºå°¾éƒ¨é‡‡æ ·ï¼Œå®ƒç”±Â CollectorÂ ä¾æ®å®Œæ•´Â TraceÂ çš„ä¿¡æ¯è¿›è¡Œå†³ç­–ï¼Œå†³ç­–çš„ä¾æ®æ¯”å¤´éƒ¨é‡‡æ ·ä¸°å¯Œå¾ˆå¤šã€‚ä½†æ˜¯ç”±äºéœ€è¦æ‰¿è½½å¤§é‡ä¸´æ—¶æ•°æ®ï¼Œæ‰€ä»¥å¯¹åŸºç¡€è®¾æ–½è¦æ±‚å¾ˆé«˜ã€‚å®ƒçš„æ•ˆæœåœ¨äºï¼š  
æŒä¹…åŒ–çš„æ•°æ®æœ‰ä¾æ®ã€æœ‰è§„å¾‹ã€æœ‰ä»·å€¼ï¼›  
å‡å°‘äº†å±•ç¤ºæœ‰ä»·å€¼æ•°æ®æ‰€éœ€çš„æˆæœ¬ï¼Œä¾‹å¦‚å­˜å‚¨èµ„æºï¼Œå¹¶ä¸”å¯¹æé«˜æŸ¥è¯¢é€Ÿåº¦ä¹Ÿæœ‰å¸®åŠ©ã€‚  

éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œåœ¨å®é™…éƒ¨ç½²ä¸­ï¼Œæ•´ä¸ªæ¶æ„è¦åšåˆ°é«˜å¯ç”¨ï¼Œå¾€å¾€ä¼šå­˜åœ¨å¤šä¸ªÂ CollectorÂ èŠ‚ç‚¹ï¼Œè€ŒåŒä¸€ä¸ªÂ TraceÂ çš„ä¸åŒÂ SpanÂ æ˜¯ç”±ä¸åŒæœåŠ¡äº§ç”Ÿçš„ï¼Œè¿™äº›æœåŠ¡ä½äºä¸åŒåœ°æ–¹ï¼Œå°¾éƒ¨é‡‡æ ·è¦æ±‚ä»–ä»¬éƒ½è½å…¥ç›¸åŒçš„Â CollectorÂ èŠ‚ç‚¹ï¼Œé‚£ä¹ˆå¿…ç„¶éœ€è¦ä¸€å±‚è´Ÿè½½å‡è¡¡æ¶è®¾åœ¨Â CollectorÂ ä¹‹å‰ï¼Œä¾ç…§Â TraceÂ IDÂ è¿›è¡Œè½¬å‘ã€‚è®©Â otel-agentÂ æŒ‰ç…§Â traceIDÂ åšè´Ÿè½½å‡è¡¡ï¼Œä½¿ç”¨exportersÂ ä¸­çš„loadbalancingÂ ç»„ä»¶ã€‚
## æ¶æ„
æ¶æ„å›¾å¦‚ä¸‹ï¼š  
![[Pasted image 20240202120446.png]]
![[Pasted image 20240202122208.png]]
podÂ é€šè¿‡sdkÂ çš„æ–¹å¼ä¸ŠæŠ¥åˆ°otel-agentï¼ŒagentÂ çš„receiversä½¿ç”¨otelÂ grpcçš„æ–¹å¼æ¥æ”¶traceï¼›processorsÂ ä½¿ç”¨Â batchÂ æ¥æ‰¹é‡å¤„ç†ï¼›exportersÂ ä½¿ç”¨Â loadbalancingÂ æ–¹å¼æ ¹æ®traceIDÂ è´Ÿè½½åˆ°ä¸‹æ¸¸åŒä¸€ä¸ªcollectorã€‚  
  
otel-collectorÂ ç”±grpcÂ æ¥æ”¶ç›¸åŒtraceIDçš„spanï¼Œæœ¬åœ°æ‰¹é‡å¤„ç†ï¼ŒåŸºäºè¿™äº›ä¿¡æ¯æ ¹æ®Â tail_samplingÂ é…ç½®è§„åˆ™å†³å®šæ˜¯å¦ä¸ŠæŠ¥åˆ°é˜¿é‡Œäº‘analysiså¹³å°ã€‚åŒæ—¶å¯é…ç½®ä¸åŒçš„processorÂ å¤„ç†ä¸åŒæ•°æ®å¯¼å‡ºåˆ°ä¸åŒçš„å¹³å°ã€‚

æœ€ç»ˆçš„æ ‡å‡†çš„æ˜¯ï¼š
åœ¨è°ƒç”¨é“¾ä¸ŠerrorÂ çº§åˆ«æ—¥å¿—  
æ•´ä¸ªè°ƒç”¨é“¾è¯·æ±‚è€—æ—¶è¶…è¿‡Â 1s

å¸¸è§„é“¾è·¯æ¯å¤©åªå¯¹æ¯ä¸ªæ¥å£é‡‡ç”¨ä¸€æ¬¡ï¼Œéƒ¨åˆ†æ¥å£ä¸€å¤©é‡‡æ ·å¤šæ¬¡å¸¸è§„é“¾è·¯ã€‚
## æœ€ç»ˆè§„æ¨¡
æœ€ç»ˆè§„æ¨¡ï¼š
otel-agentçš„æ¯ä¸ªpodä½¿ç”¨å†…å­˜åœ¨3gï¼Œcpuä½¿ç”¨åœ¨1.2ã€‚ç”Ÿäº§ç¯å¢ƒå¯åŠ¨8ä¸ªpodï¼Œæ¯åˆ†é’Ÿæ¥å—30ä¸‡å·¦å³çš„spanã€‚

otel-collectorçš„æ¯ä¸ªpodä½¿ç”¨automaxprocå†…å­˜æ˜¯2gï¼Œcpuä½¿ç”¨1cï¼Œç”Ÿäº§ç¯å¢ƒå¯åŠ¨8ä¸ªpodã€‚

## ç»“æœ
ESÂ ç´¢å¼•ä½“ç§¯ä¸‹é™è¶…è¿‡Â 80%ï¼Œç›®å‰æ¯å¤©ç´¢å¼•ä½“ç§¯ä¸ºÂ 10-20Â GBï¼›é“¾è·¯è¿½è¸ªæ•´ä½“çš„cpuæ¶ˆè€—é™ä½äº†50%ã€‚åªå­˜å‚¨ä¸€ä¸ªæœˆçš„æ•°æ®ã€‚

è¿™ä¸ªè¿‡ç¨‹ä½“ç°çš„æ˜¯ åˆ©ç”¨ä¸€ä¸ªæ–°æ¡†æ¶çš„èƒ½åŠ›ï¼Œä»¥åŠè·å–èµ„æ–™çš„èƒ½åŠ›ã€‚

# ç›‘æ§

# ç°åº¦
## ç°åº¦çš„ç”¨é€”
ç°åº¦ç¯å¢ƒçš„ç›®çš„æ˜¯æ§åˆ¶å½±å“çš„èŒƒå›´ï¼Œåªæœ‰éƒ¨åˆ†å®¢æˆ·å……å½“é‡‘ä¸é›€ã€‚é‡ç‚¹æ˜¯æ§åˆ¶é—®é¢˜å½±å“çš„èŒƒå›´

æ‰€ä»¥ç°åº¦å¯ä»¥ä½œä¸ºé¢„ç”Ÿäº§ç¯å¢ƒçš„è¡¥å……ï¼Œç”¨æ¥å‡å°å¯¹ä¸Šçº¿çš„å‹åŠ›ã€‚æ¯•ç«Ÿä¸Šçº¿ä¹‹åå¯ä»¥æŠŠä½¿ç”¨èŒƒå›´æŒ‡å®šäºæŸä¸€ä¸ªç”¨æˆ·ä¹‹ç±»çš„ã€‚
æ•°æ®åº“å‡ºé”™æ—¶ç°åº¦éœ€è¦è´Ÿè´£çš„å—ï¼Ÿ
ä¸æ˜¯ï¼Œé‚£æ˜¯è´¨é‡æŠŠæ§çš„é—®é¢˜ï¼Œç°åº¦ä¸ç°åº¦éƒ½ä¼šå‡ºé—®é¢˜
## ç›®å‰ç³»ç»Ÿæµé‡çš„èƒŒæ™¯
### ç®¡ç†ç³»ç»Ÿ
æ ¹æ®åŸŸåä»ingressè¿›å»ï¼Œç„¶åå¤šä¸ªåŒåŸŸåçš„ingressé€šè¿‡ingressçš„pathæ¥åˆ¤æ–­ï¼Œç„¶åæ‰“åˆ°gatewayè¿™ä¸ªdeploymentï¼Œè¿™ä¸ªdeploymentæ˜¯ä¸€ä¸ªkongé¡¹ç›®
### ä¸šåŠ¡ç³»ç»Ÿ
æ ¹æ®åŸŸåä»ingressè¿›å»ï¼Œç„¶åå¤šä¸ªåŒåŸŸåçš„ingressé€šè¿‡ingressçš„pathæ¥åˆ¤æ–­ï¼Œç„¶åæ‰“åˆ°gatewayè¿™ä¸ªdeploymentï¼Œè¿™ä¸ªdeploymentæ˜¯ä¸€ä¸ªkongé¡¹ç›®ï¼Œæœ€åé€šè¿‡xhoståˆ¤æ–­
## è€ƒè™‘çš„åšæ³•ï¼ˆç†è®ºä¸Šçš„åšæ³•ï¼‰

é€šè¿‡salesChannelIdï¼Œç”¨æˆ·idï¼Œæµé‡æ¥æºï¼Œipåœ°å€å»ä¸€ä¸ªæµç¨‹å¼•æ“é¡¹ç›®ä¸­åˆ¤æ–­ä½¿ç”¨çš„k8s serviceï¼Œå¹¶ä¸”åœ¨è¯·æ±‚å¤´ä¸­è®¾ç½®æ˜¯å¦å¼€å¯ç°åº¦ã€‚æ‰€ä»¥å¼€å¯è¿™ä¸ªæ’ä»¶å°±æ˜¯ä»£è¡¨è¦è¿›è¡Œç°åº¦äº†ï¼Œå…³é—­è¿™ä¸ªæ’ä»¶å°±æ²¡æœ‰ç°åº¦äº†

æ¯ä¸ªpodåœ¨è¿›è¡Œè¿œç¨‹è°ƒç”¨çš„æ—¶å€™ï¼Œå¦‚æœåˆ¤æ–­åˆ°è¯·æ±‚å¤´ä¸­æœ‰å¼€å¯ç°åº¦çš„æ ‡å¿—ï¼Œå°±ä»£è¡¨éœ€è¦å»salesChannelIdï¼Œç”¨æˆ·idï¼Œæµé‡æ¥æºï¼Œipåœ°å€ å‘åˆ°æµç¨‹å¼•æ“é¡¹ç›®ä¸­è·å–ä¸‹æ¸¸åœ°å€serviceåœ°å€ï¼Œè¿™ä¸ªåŠ¨ä½œç”±clientåŒ…é»˜è®¤è¿›è¡Œ

# å¼‚æ­¥/è§£è€¦

# æ•°æ®ä¸€è‡´æ€§æ£€æµ‹å’Œä¿®å¤

## å¾®æœåŠ¡æ¶æ„ä¸­æ•°æ®ä¸€è‡´æ€§é€šç”¨åšæ³•
### è°ƒç”¨æ–¹ç³»ç»Ÿä¿è¯æœ€ç»ˆä¸€è‡´æ€§
#### æ ¸å¿ƒæ€æƒ³
é€šè¿‡ä¸šåŠ¡ä¾§ç³»ç»Ÿçš„æœåŠ¡ä¿è¯æ•°æ®çš„æœ€ç»ˆä¸€è‡´æ€§ï¼Œå…¶æ ¸å¿ƒæ€æƒ³å°±æ˜¯ä¸šåŠ¡ä¾§ç³»ç»Ÿè®°å½•ä¸‹æ¥æ¯ä¸€æ¬¡å…·ä½“ä¸šåŠ¡æ“ä½œçš„æ‰§è¡Œæµæ°´æ—¥å¿—ä¿¡æ¯ï¼Œå¹¶ä¸”å¯¹æ²¡æœ‰å…¨éƒ¨æˆåŠŸçš„å˜æ›´ç»“  
æœï¼Œè§¦å‘æ‰§è¡Œæ•°æ®ä¸€è‡´æ€§çš„æ ¡éªŒæ ¸å¯¹å·¥ä½œã€‚
#### è®¾è®¡åŸåˆ™  
å¹³å°ä¾§ç³»ç»ŸæœåŠ¡ï¼Œæä¾›æ”¯æŒæ‰§è¡Œä¸šåŠ¡æ“ä½œçš„åŸºç¡€æœåŠ¡èƒ½åŠ›çš„æ¥å£ã€‚

ç‰¹åˆ«å¼ºè°ƒä¸€ç‚¹ï¼Œè¿™é‡Œæ˜¯éœ€è¦æ ¹æ®ä¸šåŠ¡æ“ä½œæ ‡è¯†å’Œä¸šåŠ¡æ“ä½œå”¯ä¸€IDæ¥å®ç°æ¥å£çš„å¹‚ç­‰è®¾è®¡ã€‚
ä¸ºä»€ä¹ˆæˆ‘ä»¬æœ‰äº†å”¯ä¸€IDï¼ŒåŒæ—¶è¿˜æ˜¯éœ€è¦æœ‰ä¸šåŠ¡æ“ä½œæ ‡è¯†ï¼Ÿ
å› ä¸ºåœ¨å®é™…çš„ç”Ÿäº§å®è·µä¸­ï¼Œåœ¨å„ç§å†…å› å’Œå¤–å› çš„èƒŒæ™¯ä¸‹ï¼Œéœ€è¦å…¼é¡¾ç³»ç»Ÿçš„ç¨³å®šæ€§å’Œä¸šåŠ¡è¿­ä»£çš„çµæ´»æ€§ï¼Œå¾ˆéš¾åšåˆ°ç»å¯¹çš„å…¨å±€æ€§å”¯ä¸€IDçš„ç”Ÿæˆã€‚æ›´å¤šæ—¶å€™ï¼Œåªéœ€è¦åœ¨æŸä¸ªä¸šåŠ¡ä¾§ç³»ç»Ÿçš„å†…éƒ¨ï¼Œä¿è¯å…¨å±€å”¯ä¸€æ€§å³å¯ï¼Œè¿™ä¹Ÿæ˜¯ç¬¦åˆå®é™…æƒ…å†µçš„ç³»ç»Ÿè®¾è®¡ã€‚

ç±»ä¼¼çš„è§£å†³é—®é¢˜çš„æ€è·¯ï¼Œåœ¨å…¶ä»–çš„ç³»ç»Ÿè®¾è®¡åœºæ™¯ï¼Œä¹Ÿæ˜¯æœ‰éå¸¸é«˜çš„å€Ÿé‰´ä»·å€¼çš„ã€‚  
å¹³å°ä¾§ç³»ç»ŸæœåŠ¡ï¼Œæä¾›æ‰§è¡Œä¸šåŠ¡æ“ä½œåçš„ç»“æœæŸ¥è¯¢æ¥å£ï¼Œæ”¯æŒæ ¹æ®ä¸šåŠ¡æ“ä½œæ ‡è¯†å’Œä¸šåŠ¡æ“ä½œçš„å”¯ä¸€æ€§IDæŸ¥è¯¢èƒ½åŠ›ã€‚  
ä¸šåŠ¡æ“ä½œè®°å½•è¡¨ï¼Œæ”¯æŒè®°å½•å’Œè¯†åˆ«ä¸šåŠ¡æ“ä½œçš„æ ‡è¯†å’Œæ¯æ¬¡æ‰§è¡Œçš„å”¯ä¸€IDã€‚  
ä¸šåŠ¡ä¾§ç³»ç»ŸæœåŠ¡ï¼Œè§¦å‘å¯¹ä¸šåŠ¡æ“ä½œè®°å½•è¡¨çš„æ•°æ®ä¸€è‡´æ€§çš„æ£€æŸ¥æ ¸å¯¹å·¥ä½œï¼Œæ‰§è¡Œæ ¸å¯¹çš„æ–¹å¼ï¼Œæ¯”å¦‚å®æ—¶çš„åŒæ­¥æ£€æŸ¥æ ¸å¯¹ã€å‡†å®æ—¶çš„å¼‚æ­¥æ£€æŸ¥æ ¸å¯¹ã€å®šæ—¶ä»»åŠ¡çš„å¼‚æ­¥æ£€æŸ¥æ ¸å¯¹ç­‰ç­‰ï¼Œä¸ºäº†ä¿è¯è‡ªå·±å’Œå¹³å°ä¾§ç³»ç»Ÿçš„æ•°æ®æœ€ç»ˆä¸€è‡´æ€§ã€‚

#### çŠ¶æ€å­˜å‚¨è®¾è®¡
åœ¨ä¸€èˆ¬æƒ…å†µä¸‹ï¼Œå»ºè®®æŠŠMySQLå­˜å‚¨å½“åšæˆ‘ä»¬é¦–é€‰çš„å­˜å‚¨ï¼ŒMySQLæä¾›éå¸¸å®Œå–„çš„æ•°æ®ä¸€è‡´æ€§ä¿è¯èƒ½åŠ›ï¼Œæœ€ç®€å•çš„æ–¹å¼æ˜¯åŸºäºæ•°æ®åº“çš„è”åˆå”¯ä¸€ç´¢å¼•è®¾è®¡ï¼Œå¤šæ¬¡  
å±‚TagÂ +Â å”¯ä¸€IDçš„ä¸šåŠ¡å”¯ä¸€é”®ã€‚ä½†æ˜¯ä¹Ÿæ˜¯æœ‰ç¼ºé™·çš„ï¼Œæ¯”å¦‚MySQLè‡ªèº«çš„æ€§èƒ½ç“¶é¢ˆå’Œæ˜‚è´µçš„å­˜å‚¨æˆæœ¬ã€‚æ€§èƒ½ä¸Šçš„ç“¶é¢ˆï¼Œå¯ä»¥é€šè¿‡è®¿é—®MySQLçš„å¹‚ç­‰æ ¡éªŒä¹‹å‰ï¼Œå¢  
åŠ è®¿é—®Redisçš„å¹‚ç­‰æ ¡éªŒï¼Œæ ¡éªŒä¸é€šè¿‡æŠ›å‡ºå¼‚å¸¸ï¼Œåœ¨MySQLå¹‚ç­‰æ ¡éªŒé€šè¿‡ä»¥åï¼Œå¼‚æ­¥åˆ·æ•°æ®åˆ°Redisä¸­ï¼Œè¿™æ ·ä¿è¯Redisæ ¡éªŒé€šè¿‡çš„åŒæ—¶MySQLæ ¡éªŒä¸€å®šæ˜¯é€šè¿‡  
çš„ã€‚
æˆ‘ä»¬å¯ä»¥æ¥å—Redisçš„å¹‚ç­‰æ ¡éªŒçš„ä¸å‡†ç¡®æ€§ï¼Œä»…ä»…æ˜¯æœŸæœ›å®ƒæˆä¸ºæµé‡æ¼æ–—çš„ä¸Šå±‚ï¼Œä¸ºMySQLæ‰¿æ‹…èµ·æµé‡è¿‡æ»¤ä½œç”¨ï¼Œå½“ç„¶ä½ å¯ä»¥æœ‰å…¶ä»–çš„æ›´å¤šçš„æ–¹æ¡ˆæ¥åšè¿™ä»¶äº‹ï¼Œç”šè‡³ç»„åˆèµ·æ¥ä½¿ç”¨ã€‚ä¹Ÿå¯ä»¥å¢åŠ åˆ†åº“åˆ†è¡¨çš„ç­–ç•¥ï¼Œæ¥è§£å†³MySQLçš„æ€§èƒ½ç“¶é¢ˆã€‚åœ¨MySQLçš„å­˜å‚¨æˆæœ¬æ˜¯ç›¸å¯¹æ¯”è¾ƒé«˜çš„ï¼Œæˆ‘ä»¬å¯ä»¥å¯¹å†å²çš„æ•°æ®åšå½’æ¡£å¤„ç†ï¼Œåªä¿ç•™ä¸€éƒ¨åˆ†çš„çƒ­æ•°æ®ï¼ŒåŸåˆ™ä¸Šä¿æŒå•è¡¨çš„æ•°æ®è¡Œæ•°åœ¨500w~1000wä¹‹é—´ï¼ŒåŒæ—¶ä¹Ÿå¯ä»¥æœ‰èƒ½æ”¯æŒä¸€å®šé‡çš„å†å²æ•°é‡æŸ¥è¯¢ã€‚åŒæ—¶è¿™ä¸ªè¿‡ç¨‹ä¹Ÿéœ€è¦è€ƒè™‘æ— é”å¤„ç†é—®é¢˜å’ŒMySQLç©ºé—´ç¢ç‰‡çš„é—®é¢˜ç­‰ç­‰ã€‚


# other
å¸¸è§é—®é¢˜  
  
é—®é¢˜ï¼šSLAåº”è¯¥æŒ‰ç…§å“ªä¸ªç»´åº¦å»å®šä¹‰ï¼Ÿæ¥å£ã€åº”ç”¨ã€ä¸šåŠ¡ï¼Ÿ  
  
ç­”ï¼šéƒ½å¯ä»¥ï¼Œåªè¦è®²æ¸…æ¥šæ˜¯æ¥å£SLAï¼Œè¿˜æ˜¯åº”ç”¨SLAï¼Œè¿˜æ˜¯ä¸šåŠ¡SLAå°±å¯ä»¥ã€‚ä½†æ³¨æ„ï¼šæåˆ°åº”ç”¨SLAï¼Œåº”è¯¥ç­‰äºæ ¸å¿ƒæ¥å£çš„æœ€å·®SLAï¼›æåˆ°ä¸šåŠ¡SLAåº”è¯¥ç­‰äºé»„é‡‘é“¾è·¯çš„æœ€å·®SLAã€‚  
  
é—®é¢˜ï¼šSLAæ—¶é—´è®¡ç®—å‘¨æœŸåº”è¯¥å¤šå°‘ï¼Ÿ  
  
ç­”ï¼šéƒ½å¯ä»¥ï¼Œä¸»è¦è®²æ¸…æ¥šè®¡ç®—å‘¨æœŸå°±å¯ä»¥ï¼Œä¸€èˆ¬ä»¥å¹´ä¸ºå•ä½æ›´å…·ä»£è¡¨æ€§ã€‚