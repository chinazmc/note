# 测试样本的有效性
恰当的测试既要考虑到影响测试解释力的统计学概念，也要考虑到这些解释的内在局限性。不恰当的测试可能导致你空有十足信心，但实际上测试结果的预测价值缺乏保证，甚至完全没有保证。事实上，糟糕的测试可能会给出完全错误的答案。

民意调查者们知道，一个样本对整个总体有多大的代表性是个关键问题。用不具代表性的样本得出的调查结论是不准确的，而犯下这种错误的调查者会被炒鱿鱼。在交易世界中，这也是一个关键问题。遗憾的是，交易者与民意调查者们不同。民意调查者们大多都懂抽样统计学，但交易者们大多不懂。在这方面，交易者们的近期偏好也许就是最常见的迹象——交易者们只注重近期发生的交易，或是仅用近期的数据作历史测试，这就像是在民主党大会上抽取选民样本一样。

短期测试的问题在于，市场在这段较短的时期内可能仅出现了一两种状态，而不是我们在第二章中所说的全部4种状态。比如，如果市场一直处于稳定波动的状态，那么均值回归和反趋势策略的效果会非常好。但如果市场状态改变了，你所测试的方法可能就不再那么有效了。所以，你的测试方法必须尽可能地提高你所测试的样本对未来的代表性。

# 衡量指标的稳健性
在系统测试中，你要做的是观测相对表现，分析未来潜力，判定一个特定理念是否有价值。但这里面有个问题，那就是公认的那些业绩衡量指标并不是非常稳定，也就是说，它们不够稳健。这就使评判一个理念的相对优势变得非常困难，因为寥寥几次交易中的微小变化就能对这些不稳健指标的值产生巨大的影响。指标的不稳定性可能导致测试者过高地评价一个理念，或是盲目地抛弃一个本来很有潜力的理念——因为它受到了不稳定指标的影响，并没有展现出应有的潜力。

如果对数据稍作改变并不会显著影响一个统计指标，我们就说这个指标是稳健的。但现有的指标对数据的变化都太过敏感，因此都太不稳健。正因为如此，在我们对交易系统作历史模拟检验时，参数值的轻微变化就会带来某些指标值的大幅变化。这些指标本身就是不稳健的——也就是说，它们对数据的轻微变化太过敏感。任何对数据有影响的因素都会对测试结果产生过大的影响，这很容易导致数据拟合，很容易让你被不切实际的测试结果所迷惑。要想有效地测试海龟方法，我们要做的第一件事就是克服这个问题，找到稳健的业绩衡量指标。
前面的章节把MAR比率、CAGR（平均复合增长率）和夏普比率用作相对表现的衡量指标。但这些指标并不稳健，因为它们对测试期的起始日和终止日非常敏感。这对短于10年的测试来说尤其明显。让我们看看将一次测试的起始日和终止日调整几个月会怎么样。假设我们从1996年2月1日而不是1月1日开始测试，一直测试到2006年4月30日而不是6月30日。也就是说，我们去掉了最初的一个月和最后的两个月。

# 回归年度回报率


# 稳健风险回报比率
为了把上述所有因素都考虑在内，我发明了一个新的风险回报比指标，我称之为稳健风险回报比率（robust risk/reward ratio）。我也喜欢称之为R立方，因为我的骨子里还是有点技术遗风，习惯于用这样的术语。R立方的分子就是RAR，分母也是个新指标，我称之为长度调整平均最大衰落（length-adjusted average maximum drawdown）。这个分母指标有两个要素：平均最大衰落和长度调整。平均最大衰落就是5次最大衰落幅度的平均值。长度调整就是将这5个衰落期的平均天数除以365天，然后用这个结果乘以平均最大衰落。平均衰落天数的计算原理与平均衰落幅度相同，也就是将5次衰落期的天数相加再除以5。因此，如果RAR是50%，平均最大衰落是25%，而平均衰落长度是1年，也就是365天，那么R立方就等于2.0——也就是50%/（25%×365/365）。作为一个风险回报比指标，R立方从程度和时间这两个角度考虑了风险问题。它所使用的指标对测试起止日的变化并不是那么敏感，因此它比MAR指标更稳健——也就是说，它不太容易随着数据的轻微变动而发生大的变化。

# 稳健夏普比率
稳健夏普比率就是RAR除以年度化的月度回报标准差。这个指标对数据变化的敏感度较低，原因与RAR的敏感度低于CAGR的原因相同，上面已经说过。如表12-1所示，稳健指标对测试起止日的变化远不如普通指标敏感。

# 样本的代表性
我们的样本交易和检验结果对未来有多大的代表性是由两大因素决定的：市场数量：我们所测试的市场越多，我们就越有可能将市场的各种不同状态包含在内。测试时间：时间跨度较长的测试会涵盖更多的市场状态，而且更有可能将具有未来代表性的历史时期包含在内。我建议你把你能得到的所有数据都测试一遍。买数据花不了太多的钱，但如果你没有经过对多个市场和多个年头的充分测试就盲目地相信一个系统，那你的风险可就大了。假如你的系统第一次碰上某种市场状态就失效了，但这种状态在过去的20年中已经出现过三四次，只不过你并没有检验过它，你不会觉得自己很愚蠢吗？年轻的交易者特别容易犯这种错误。他们相信他们所看到的状态就是市场整体状态的代表，而往往意识不到市场具有周期性和多变性，经常回归到过去曾经出现过的状态。就像在生活中一样，年轻人往往看不到历史的价值，就因为历史发生在他们出生之前。年轻是好事，但不要太愚蠢——一定要学历史。

还记得吗，在互联网泡沫时代，每个人都是短线高手，每个人都是天才。但当泡沫戛然破裂，曾经大获成功的方法不再有效时，这些天才又有几个能幸存下来？如果他们作过一点测试，他们就会知道他们的方法是以那个黄金时期的特殊市场状态为依托的，因此当这些状态不再存在时，他们会放弃这些方法。也许，他们从一开始就会采用适用于所有状态的稳健方法。

# 样本规模
样本规模这个概念很简单：你需要一个足够大的样本才能进行有效的统计学推理。样本越小，推理就越粗糙；样本越大，推理就越准确。这方面不存在某个神奇的标准数字，样本就是越大越好，越小越糟。不到20的样本规模会导致严重的偏差；超过100的样本规模更具预测价值；达到数百的样本规模也许对大多数测试来说就够用了。有些公式和方法会明确地规定样本的必要规模，但遗憾的是，这些公式都不是为交易世界中的那些数据设计的，因为交易世界不存在精细而又规律的潜在收益分布曲线（就像图4-3中那种女性身高分布曲线一样）。不过，真正的挑战并不在于确定样本的必要规模，而在于当你考虑某个并不是经常发挥作用的法则时，你很难评判从过去的数据中得出的推论。因为对这样的法则来说，你没办法得到足够大的样本。以大泡沫濒临破裂时的市场行为为例，你可以想出某些针对这种市场状态的法则，甚至可以检验这些法则，但你不可能收集到作出决策所需要的大样本。在这种情况下，我们必须明白我们的测试结果不具备太大的说服力，因为我们的样本比必要样本小得多。这个问题也存在于前文所说的季节性趋势的分析中。
在你测试一条新法则时，你必须衡量一下这个法则的应用频率。如果一条法则在整个测试期内只有4次生效，那么从统计学上说，你无从判断这条法则是否有用，你所看到的效果很有可能只是随机性的。有个办法可以解决这个问题：你可以设法将这条法则一般化，提高它发挥作用的频率。这样一来，样本规模就会扩大，测试的统计学说服力也就相应地提高了。有两种常见的做法可能将小样本规模的问题进一步放大：一个是单一市场最优化，一个是系统设计过于复杂。
单一市场最优化：单独应用在各个市场中的最优化方法更难用足够大的样本进行测试，因为单个市场上的交易机会要少得多。
过于复杂的系统：复杂的系统有很多法则，有时候很难判断某一条法则发挥作用的频率或程度。因此，如果用过于复杂的系统进行测试，我们更难对测试结果的说服力抱有信心。
出于这些原因，我不建议针对单个市场进行最优化，而且我更喜欢具备统计学意义的简单理念。

# 从虚拟测试到实战交易
你怎么判断你在实际交易中可能获得什么样的成果？对历史测试来说，这或许是最有趣的问题之一。要想得到有意义的答案，你必须理解影响系统表现的因素，使用稳健指标的必要性，以及采集足够大的代表性样本的重要性。一旦你做到了这一点，你就可以开始思考市场变换的潜在影响，思考为什么连老练的交易者设计的优秀系统也会经历业绩的盛衰起伏。你不可能知道，也不可能预见到一个系统的表现会怎么样，这是现实。充其量，你只能借用有效的工具来判断系统的潜在效果，以及影响这种效果的因素。
## 幸运的系统
如果一个系统在最近一段时间表现得特别出众，这有可能是个运气问题，或许市场对这种系统来说正处于理想的状态中。一般来说，这种冒尖的系统在好时期过后很容易转入困难时期，不能指望它在未来会重现这种好运的表现。这也许会发生，但你不能寄希望于运气。你更有可能经历业绩的下滑。
## 参数调整检验
在决定采用一个系统之前先体验一下参数的作用是个很好的习惯，我称之为参数调整检验。挑出几个系统参数，大幅调整参数值，比如20%～25%，然后看看效果怎么样。以图11-2和图11-3的最优化曲线为例，你可以把参数值调整到远离最优点的地方。对这个布林格通道系统来说，我想看看把350天和-0.8的最优化退出标准变为250天和零会怎么样。结果，参数的调整令RAR从59%变为58%，R立方从3.67变为2.18，这是相当显著的变化。当你从历史数据测试转向市场中的实战时，你很有可能看到这样的戏剧性变化。

## 滚动最优化窗口
还有一个方法可以帮助你直接体验从虚拟测试到现实交易的转变，那就是滚动最优化窗口（rolling optimization window）。随便选择8～10年前的一天，用这一天之前的所有的数据进行最优化——要使用你平常所用的最优化方法，作出你平常会作出的权衡决策，就如同你只有截至那一天的数据。当你得出了“最优化”参数值后，再用这一天之后两年内的数据检验一下这些参数值。系统在这两年内的表现怎么样呢？
接下来，把测试终点向后顺延两年（也就是6～8年前的一天），再测试一次。比起上一次测试和上一个滚动窗口，这一次有什么变化？比起你最初的参数值，也就是用所有可用数据计算出的最优值，这一次又有什么不同？继续向后顺延，重复这个程序，直到延伸至今天。
我用这个方法对布林格通道系统进行了最优化。在测试过程中，我对三个参数的值都进行了大范围调整检验，然后根据最优位置（一般来说接近于R立方值达到最大的那个点）选出最优值。我分别做了5次10年期检验，最后的滚动最优化结果如表12-4所示。
![[Pasted image 20230116175444.png]]

可以看到，在每一个滚动期中，实际表现都与测试值大相径庭。另外，不同滚动期的最优值也不尽相同。这证明了测试结果的不精确性，也反映了从虚拟测试转向实践交易时的不确定性。


# 蒙特卡洛检验
蒙特卡洛检验是判断系统稳健性的一种方法，可以回答这样的问题：如果把历史稍作变化会怎么样？未来又会怎么样？通过蒙特卡洛检验，你可以用代表历史实际数据的一系列事件来生成另外一种略有变化的别样景象。

要用蒙特卡洛检验来生成别样景象，我们有两种常见方法可用：
- 交易调整：随机性地改变实际模拟结果中的交易命令和起始日，然后用调整后的交易命令和这些交易的损益水平来调整资产净值。
- 净值曲线调整：在初始净值曲线中随机选择一些部分，将它们组合成新的净值曲线。

在这两种方法中，净值曲线调整所生成的别样净值曲线更具现实性，因为随机改变交易命令的蒙特卡洛检验很容易低估衰落的可能性。

最大衰落总是发生在大趋势的末端或资产呈增长趋势的时期。因为在这些时候，市场之间的相关性要高于平常。期货和股票市场都是如此。当大趋势在走到尽头后崩溃并逆转时，似乎所有事情都开始对你不利，即使是平常看似不相关的市场，也开始在这些起伏不定的日子相互挂钩了。

由于交易调整法去除了交易和日期的关联性，它也去除了多个同时逆转的交易对净值曲线的不利影响。这意味着蒙特卡洛检验中的衰落程度和频率要比现实中低。以2006年春季的黄金和白银走势为例。如果你检验的是一个同时涉足这两个市场的趋势跟踪系统，那么交易调整意味着你在这两个市场上的衰落损失将发生在不同的时期，这等于缓和了每一个市场上的衰落程度。事实上，这种效果也会延伸到其他几个相对意想不到的市场上，比如食糖。像黄金和白银一样，食糖市场在2006年5月中旬至6月中旬的20天内也发生了严重的衰落。因此交易调整不可取，因为它低估了中长期系统在实际交易中的衰落水平。
(这里看不懂)