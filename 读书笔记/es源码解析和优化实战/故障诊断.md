#es 

# 使用Profile API定位慢查询

# 使用explain API分析未分配的分片

# 节点CPU使用率高
节点占用CPU很高，我们想知道CPU在运行什么任务，一般通过线程堆栈来查看。有两种方式可以查看哪些线程CPU占用率比较高。
· 使用hot_threads API，参考ThreadPool一章。
· 使用top+jstack,top获取线程级CPU占用率，再根据线程ID，配合jstack定位CPU占用率在特定比例之上的线程堆栈。

# 分析工具
本节介绍一些基础的分析工具，它们大部分是系统自带且常用的，无论分析性能问题还是排查故障，都离不开它们。
## 22.6.1 I/O信息
iostat iostat是用来分析 I/O 状态的常用工具，其输出结果是以/proc/diskstats 为基础计算的。例如，我们使用1秒的间隔来采样：
iostat -xd 1
输出结果包括系统中全部磁盘的信息：
![[Pasted image 20220421110049.png]]
我们经常关注的几个指标：
· iops，由r/s（每秒读次数）和w/s（每秒写次数）组成。
· await，平均I/O等待时间，包括硬件处理I/O的时间和在队列中的等待时间。
· %util，设备的繁忙比，是设备执行的I/O时间与所经过的时间百分比。当值接近100%时设备产生饱和。在设备具有并行处理能力的情况下，util达到100%不代表设备没有余力处理更多I/O请求。

当I/O产生性能问题时，iostat可能不足以定位故障，可以使用blktrace来分析I/O请求的各个环节。该工具的原理和使用方式可以参考http://bean-li.github.io/blktrace-to-report/。

进程级I/O状态 iostat提供磁盘级的I/O状态，无法关联到进程，如果想查看哪些进程的I/O最高，则可以使用pidstat或iotop两个工具，它们可以动态给出每个进程的读写速度。例如，下面为iotop的输出结果，在统计信息中给出了全部磁盘的读写速度，以及每个进程的读写速度。
如果想看到特定磁盘上特定进程的 I/O 情况，则这两个工具无法做到，这种情况可以通过systemtap来监控。

## 22.6.2 内存
top、free、vmstat 等工具可以帮助我们看到基础的内存信息，包括物理内存总量、剩余空间、cache 量等。这些简单指令本书不再一一列出。我们感兴趣的是，当系统物理内存不足时，系统回收内存的效率如何。在这种场景下，我们可以通过sar -B来观察内存分页的统计信息：

后续有空再补