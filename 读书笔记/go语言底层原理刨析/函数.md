---
sr-due: 2024-12-02
sr-interval: 4
sr-ease: 270
---

#函数 #review/golang

Go语言同样支持匿名函数和闭包。闭包（Closure）是在函数作为一类公民的编程语言中实现词法绑定的一种技术，闭包包含了函数的入口地址和其关联的环境。闭包和普通函数最大的区别在于，闭包函数中可以引用闭包外的变量。下面是通过闭包设计的一个http中间件，通过闭包可以轻易地在原有函数的基础上包裹中间功能，而不破坏原有函数。

![[Pasted image 20220213140343.png]]
这种错误可以通过trace工具来避免
## 栈扩容与栈转移原理

Go语言在线程的基础上实现了用户态更加轻量级的协程，线程的栈大小一般是在创建时指定的，为了避免出现栈溢出（stack overflow）的错误，默认的栈大小会相对较大（例如2MB）。而在Go语言中，每个协程都有一个栈，并且在Go 1.4之后，每个栈的大小在初始化的时候都是2KB。程序中经常有成千上万的协程存在，可以预料到，Go语言中的栈是可以扩容的。Go语言中最大的协程栈在64位操作系统中为1GB，在32位系统中为250MB。在Go语言中，栈的大小不用开发者手动调整，都是在运行时实现的。栈的管理有两个重要的问题：触发扩容的时机及栈调整的方式。
如上所示，newstack函数首先通过栈底地址与栈顶地址相减计算旧栈的大小，并计算新栈的大小。新栈为旧栈的两倍大小。在64位操作系统中，如果栈大小超过了1GB则直接报错为stack overflow。栈扩容的重要一步是将旧栈的内容转移到新栈中。栈扩容首先将协程的状态设置为_Gcopystack，以便在垃圾回收状态下不会扫描该协程栈带来错误。栈复制并不像直接复制内存那样简单，如果栈中包含了引用栈中其他地址的指针，那么该指针需要对应到新栈中的地址，copystack函数会分配一个新栈的内存。为了应对频繁的栈调整，对获取栈的内存进行了许多优化，特别是对小栈。在Linux操作系统下，会对2KB/4KB/8KB/16KB的小栈进行专门的优化，即在全局及每个逻辑处理器（P）中预先分配这些小栈的缓存池，从而避免频繁地申请堆内存。

栈的全局与本地缓存池结构如图9-6所示，每个逻辑处理器中的缓存池都来自全局缓存池（stackpool）。mcache有时可能不存在（例如在调整P的大小后），这时需要直接从全局缓存池获取栈缓存。逻辑处理器及mcache的详细内容，参见第14章对于协程的描述以及第18章对于内存分配的描述。对于大栈，其大小不确定，虽然也有一个全局的缓存池，但不会预先放入多个栈，当栈被销毁时，如果被销毁的栈为大栈则放入全局缓存池中。当全局缓存池中找不到对应大小的栈时，会从堆区分配。
![[Pasted image 20220213142103.png]]
在分配到新栈后，如果有指针指向旧栈，那么需要将其调整到新栈中。在调整时有一个额外的步骤是调整sudog，由于通道在阻塞的情况下存储的元素可能指向了栈上的指针，因此需要调整。接着需要将旧栈的大小复制到新栈中，这涉及借助memmove函数进行内存复制。内存复制完成后，需要调整当前栈的SP寄存器和新的stackguard0，并记录新的栈顶与栈底。扩容最关键的一步是在新栈中调整指针。因为新栈中的指针可能指向旧栈，旧栈一旦释放就会出现严重的问题。图9-7描述了栈扩容的过程，copystack函数会遍历新栈上所有的栈帧信息，并遍历其中所有可能有指针的位置。一旦发现指针指向旧栈，就会调整当前的指针使其指向新栈。

![[Pasted image 20220213142132.png]]

![[Pasted image 20220213142157.png]]
## 总结
函数是程序开发中的重要组成部分，合理地使用函数可以减少重复代码、减少冗余、隐藏信息、提高代码清晰度。在Go语言中，函数是一等公民，这意味着可以将它看作变量，并且它可以作为参数传递、返回及赋值。Go语言同样支持匿名函数及闭包，但是要注意闭包使用的常见陷阱。Go语言在线程的基础上实现了用户态更加轻量级的协程，每个协程都有一个栈，并且在Go 1.4之后每个栈的大小在初始化时都为2KB。Go语言中的栈是可以扩容与伸缩的。Go语言中最大的协程栈在64位操作系统中为1GB，在32位系统中为250MB。协程栈扩容的时机是函数调用的序言阶段。如果即将发生栈溢出，则会开辟一个2倍于旧栈的新栈，并将旧栈中的数据转移到新栈中。在转移的过程中，如果有指向旧栈的指针，那么还涉及指针的调整。可以将程序看作一系列函数调用的过程。程序涉及多个函数之间的相互调用，理解函数底层协程栈、栈帧、函数调用方式等原理有助于理解程序的运行机制。对协程堆栈信息的打印是非常重要的调试手段和观察程序运行的方式。


# golang函数 question

Go1.4之后每个栈的初始化大小是多少？在32位和64位系统中最大多少MB?
?
2KB,32位系统是250MB，64位系统是1024MB
<!--SR:!2022-11-26,117,290-->