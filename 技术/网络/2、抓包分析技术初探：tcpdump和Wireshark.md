#网络 

## tcpdump 怎么用？

好了，现在我们对抓包分析的基础知识就有一定的了解了，下面我们就来着重学习下其中的重点，也就是 tcpdump 和 Wireshark 这两个分析工具。

我们先来看看 tcpdump。

### tcpdump 的基本用法

虽然 tcpdump 有完备的文档和命令手册，但如果你不经常抓包，并不能掌握得特别熟练。我个人的经验是，抓包技术课是一门实践课，不是理论课。既然是实践课，就要多多实践，从鲜活的案例中积累起来的经验无比宝贵。

在这门课程里，我也会把自己过往多年的实践总结，毫无保留地分享给你。今天这节课，我们先初步学一些技巧，当作“开胃菜”，希望合你胃口。

如何抓取报文？

用 tcpdump 抓取报文，最常见的场景是要抓取去往某个 ip，或者从某个 ip 过来的流量。我们可以用 host {对端 IP} 作为抓包过滤条件，比如：
```bash
tcpdump host 10.10.10.10
```
另一个常见的场景是抓取某个端口的流量，比如，我们想抓取 SSH 的流量，那么可以这样：
```bash
tcpdump port 22
```
还有不少参数我们也经常用到，比如：

-w 文件名，可以把报文保存到文件；

-c 数量，可以抓取固定数量的报文，这在流量较高时，可以避免一不小心抓取过多报文；

-s 长度，可以只抓取每个报文的一定长度，后面我会介绍相关的使用场景；

-n，不做地址转换（比如 IP 地址转换为主机名，port 80 转换为 http）；

-v/-vv/-vvv，可以打印更加详细的报文信息；

-e，可以打印二层信息，特别是 MAC 地址；

-p，关闭混杂模式。所谓混杂模式，也就是嗅探（Sniffering），就是把目的地址不是本机地址的网络报文也抓取下来。

这里还有个 -X 参数的用法。
### Wireshark 的一些知识和使用技巧

下面，我们一起来探讨一些使用 Wireshark 时容易遇到的问题，帮你减少使用 Wireshark 时的“心理压力”，更好地跟这位女神“交朋友”。

怎么知道抓包文件是在哪一端抓取的？

这是一个有趣的问题。尽管我们做抓包的时候很清楚是在哪端做了抓包，但是把文件传给别人后，对方就未必知道这一点，甚至我们自己过段时间也迷糊了：我上次这个抓包文件到底是在客户端上，还是服务端上抓取的？

要搞清楚这一点也很简单，我们可以利用 IP 的 TTL 属性。显然，无论是哪一端，它的报文在发出时，其 TTL 就是原始值，也就是 64、128、255 中的某一个。而对端报文的 TTL，因为会经过若干个网络跳数，所以一般都会比 64、128、255 这几个数值要小一些。

所以，我们只要看一下抓包文件中任何一个客户端报文（也就是源端口为高端口）的 TTL，如果它是 64、128 或 255，那说明这个抓包文件就是在客户端做的。反之，就是在服务端做的。
![[Pasted image 20220622115117.png]]
如何定位到应用层的请求和返回的报文？

在众多报文中找到应用层请求和对应的响应报文，这个任务用人工去做的话是很繁琐的。还好，用 Wireshark 就很方便。在 Wireshark 界面中，我们很容易找到请求和返回的报文。比如这样：
![[Pasted image 20220622115130.png]]