# holmes

åŸºäºè§„åˆ™çš„è‡ªåŠ¨Golang Profile Dumper.

ä½œä¸ºä¸€å"æ‡’æƒ°"çš„ç¨‹åºå‘˜ï¼Œå¦‚ä½•é¿å…åœ¨çº¿ä¸ŠGolangç³»ç»ŸåŠå¤œå®•æœº ï¼ˆä¸€èˆ¬æ˜¯OOMå¯¼è‡´çš„ï¼‰æ—¶èµ·åºŠä¿å­˜ç°åœºå‘¢ï¼Ÿåˆæˆ–è€…å¦‚ä½•dumpå‹æµ‹æ—¶æ€§èƒ½å°–åˆºæ—¶åˆ»çš„profileæ–‡ä»¶å‘¢ï¼Ÿ

holmes æˆ–è®¸èƒ½å¸®åŠ©æ‚¨è§£å†³ä»¥ä¸Šé—®é¢˜ã€‚

## è®¾è®¡

holmes æ¯éš”ä¸€æ®µæ—¶é—´æ”¶é›†ä¸€æ¬¡ä»¥ä¸‹åº”ç”¨æŒ‡æ ‡ï¼š

- åç¨‹æ•°ï¼Œé€šè¿‡`runtime.NumGoroutine`ã€‚
- å½“å‰åº”ç”¨æ‰€å ç”¨çš„RSSï¼Œé€šè¿‡[gopsutil](https://github.com/shirou/gopsutil)ç¬¬ä¸‰æ–¹åº“ã€‚
- CPUä½¿ç”¨ç‡ï¼Œæ¯”å¦‚8Cçš„æœºå™¨ï¼Œå¦‚æœä½¿ç”¨äº†4Cï¼Œåˆ™ä½¿ç”¨ç‡ä¸º50%ï¼Œé€šè¿‡[gopsutil](https://github.com/shirou/gopsutil)ç¬¬ä¸‰æ–¹åº“ã€‚

é™¤æ­¤ä¹‹å¤–ï¼Œholmesè¿˜ä¼šæ ¹æ®Gcå‘¨æœŸæ”¶é›†RSSæŒ‡æ ‡ï¼Œå¦‚æœæ‚¨å¼€å¯äº†`GCheap dump`çš„è¯ã€‚

åœ¨é¢„çƒ­é˜¶æ®µï¼ˆåº”ç”¨å¯åŠ¨åï¼Œholmesä¼šæ”¶é›†åæ¬¡æŒ‡æ ‡ï¼‰ç»“æŸåï¼Œholmesä¼šæ¯”è¾ƒå½“å‰æŒ‡æ ‡æ˜¯å¦æ»¡è¶³ç”¨æˆ·æ‰€è®¾ç½®çš„é˜ˆå€¼/è§„åˆ™ï¼Œå¦‚æœæ»¡è¶³çš„è¯ï¼Œåˆ™dump profileï¼Œ ä»¥æ—¥å¿—æˆ–è€…äºŒè¿›åˆ¶æ–‡ä»¶çš„æ ¼å¼ä¿ç•™ç°åœºã€‚

## å¦‚ä½•ä½¿ç”¨


```shell
    go get mosn.io/holmes
```

åœ¨åº”ç”¨åˆå§‹åŒ–é€»è¾‘åŠ ä¸Šå¯¹åº”çš„holmesé…ç½®ã€‚

```go
func main() {
	
  h := initHolmes()
  
  // start the metrics collect and dump loop
  h.Start()
  ......
  
  // quit the application and stop the dumper
  h.Stop()
}
func initHolmes() *Holmes{
    h, _ := holmes.New(
    holmes.WithCollectInterval("5s"),
    holmes.WithDumpPath("/tmp"),
    holmes.WithCPUDump(20, 25, 80, time.Minute),
    holmes.WithCPUMax(90),
    )
    h.EnableCPUDump()
    return h
}
```

holmes æ”¯æŒå¯¹ä»¥ä¸‹å‡ ç§åº”ç”¨æŒ‡æ ‡è¿›è¡Œç›‘æ§:

```
* mem: å†…å­˜åˆ†é…     
* cpu: cpuä½¿ç”¨ç‡      
* thread: çº¿ç¨‹æ•°    
* goroutine: åç¨‹æ•°
* gcHeap: åŸºäºGCå‘¨æœŸçš„å†…å­˜åˆ†é…
```

### Dump Goroutine profile

```go
h, _ := holmes.New(
    holmes.WithCollectInterval("5s"),
    holmes.WithDumpPath("/tmp"),
    holmes.WithTextDump(),
    holmes.WithDumpToLogger(true),
    holmes.WithGoroutineDump(10, 25, 2000, 10*1000, time.Minute),
)
h.EnableGoroutineDump()

// start the metrics collect and dump loop
h.Start()

// stop the dumper
h.Stop()
```

- WithCollectInterval("5s") æ¯5sé‡‡é›†ä¸€æ¬¡å½“å‰åº”ç”¨çš„å„é¡¹æŒ‡æ ‡ï¼Œè¯¥å€¼å»ºè®®è®¾ç½®ä¸ºå¤§äº1sã€‚
- WithDumpPath("/tmp") profileæ–‡ä»¶ä¿å­˜è·¯å¾„ã€‚
- WithTextDump() ä»¥æ–‡æœ¬æ ¼å¼ä¿å­˜profileå†…å®¹ã€‚
- WithDumpToLogger() profileå†…å®¹å°†ä¼šè¾“å‡ºåˆ°æ—¥å¿—ã€‚
- WithGoroutineDump(10, 25, 2000, 100\*1000, time.Minute) å½“goroutineæŒ‡æ ‡æ»¡è¶³ä»¥ä¸‹æ¡ä»¶æ—¶ï¼Œå°†ä¼šè§¦å‘dumpæ“ä½œã€‚ current_goroutine_num >Â `10`Â && current_goroutine_num <Â `100*1000`Â && current_goroutine_num >Â `125`% * previous_average_goroutine_num or current_goroutine_num >Â `2000`.Â `time.Minute`Â æ˜¯ä¸¤æ¬¡dumpæ“ä½œä¹‹é—´æœ€å°æ—¶é—´é—´éš”ï¼Œé¿å…é¢‘ç¹profilingå¯¹æ€§èƒ½äº§ç”Ÿçš„å½±å“ã€‚

> WithGoroutineDump(min int, diff int, abs int, max int, coolDown time.Duration) å½“åº”ç”¨æ‰€å¯åŠ¨çš„goroutine numberå¤§äº`Max`Â æ—¶ï¼Œholmesä¼šè·³è¿‡dumpæ“ä½œï¼Œå› ä¸ºå½“goroutine numberå¾ˆå¤§æ—¶ï¼Œ dump goroutine profileæ“ä½œæˆæœ¬å¾ˆé«˜ï¼ˆSTW && dumpï¼‰ï¼Œæœ‰å¯èƒ½æ‹–å®åº”ç”¨ã€‚å½“`Max`=0 æ—¶ä»£è¡¨æ²¡æœ‰é™åˆ¶ã€‚

### Dump cpu profile

```go
h, _ := holmes.New(
holmes.WithCollectInterval("5s"),
holmes.WithDumpPath("/tmp"),
holmes.WithCPUDump(20, 25, 80, time.Minute),
holmes.WithCPUMax(90),
)
h.EnableCPUDump()

// start the metrics collect and dump loop
h.Start()

// stop the dumper
h.Stop()
```

- WithCollectInterval("5s") æ¯5sé‡‡é›†ä¸€æ¬¡å½“å‰åº”ç”¨çš„å„é¡¹æŒ‡æ ‡ï¼Œè¯¥å€¼å»ºè®®è®¾ç½®ä¸ºå¤§äº1sã€‚
- WithDumpPath("/tmp") profileæ–‡ä»¶ä¿å­˜è·¯å¾„ã€‚
- cpu profileæ”¯æŒä¿å­˜æ–‡ä»¶ï¼Œä¸æ”¯æŒè¾“å‡ºåˆ°æ—¥å¿—ä¸­ï¼Œæ‰€ä»¥WithBinaryDump()å’Œ WithTextDump()åœ¨è¿™åœºæ™¯ä¼šå¤±æ•ˆã€‚
- WithCPUDump(10, 25, 80, time.Minute) ä¼šåœ¨æ»¡è¶³ä»¥ä¸‹æ¡ä»¶æ—¶dump profile cpu usage >Â `10%`Â && cpu usage >Â `125%`Â * previous cpu usage recorded or cpu usage >Â `80%`.Â `time.Minute`Â æ˜¯ä¸¤æ¬¡dumpæ“ä½œä¹‹é—´æœ€å°æ—¶é—´é—´éš”ï¼Œé¿å…é¢‘ç¹profilingå¯¹æ€§èƒ½äº§ç”Ÿçš„å½±å“ã€‚
- WithCPUMax å½“cpuä½¿ç”¨ç‡å¤§äº`Max`, holmesä¼šè·³è¿‡dumpæ“ä½œï¼Œä»¥é˜²æ‹–å®ç³»ç»Ÿã€‚

### Dump Heap Memory Profile

```go
h, _ := holmes.New(
    holmes.WithCollectInterval("5s"),
    holmes.WithDumpPath("/tmp"),
    holmes.WithTextDump(),
    holmes.WithMemDump(30, 25, 80, time.Minute),
)

h.EnableMemDump()

// start the metrics collect and dump loop
h.Start()

// stop the dumper
h.Stop()
```

- WithCollectInterval("5s") æ¯5sé‡‡é›†ä¸€æ¬¡å½“å‰åº”ç”¨çš„å„é¡¹æŒ‡æ ‡ï¼Œè¯¥å€¼å»ºè®®è®¾ç½®ä¸ºå¤§äº1sã€‚
- WithDumpPath("/tmp") profileæ–‡ä»¶ä¿å­˜è·¯å¾„ã€‚
- WithTextDump() profileçš„å†…å®¹å°†ä¼šè¾“å‡ºåˆ°æ—¥å¿—ä¸­ã€‚
- WithMemDump(30, 25, 80, time.Minute) ä¼šåœ¨æ»¡è¶³ä»¥ä¸‹æ¡ä»¶æ—¶æŠ“å–heap profile memory usage >Â `10%`Â && memory usage >Â `125%`Â * previous memory usage or memory usage >Â `80%`ï¼ŒÂ `time.Minute`Â æ˜¯ä¸¤æ¬¡dumpæ“ä½œä¹‹é—´æœ€å°æ—¶é—´é—´éš”ï¼Œé¿å…é¢‘ç¹profilingå¯¹æ€§èƒ½äº§ç”Ÿçš„å½±å“ã€‚

### åŸºäºGcå‘¨æœŸçš„Heap Memory Dump

åœ¨ä¸€äº›åœºæ™¯ä¸‹ï¼Œæˆ‘ä»¬æ— æ³•é€šè¿‡å®šæ—¶çš„`Memory Dump`ä¿ç•™åˆ°ç°åœº, æ¯”å¦‚åº”ç”¨åœ¨ä¸€ä¸ª`CollectInterval`å‘¨æœŸå†…åˆ†é…äº†å¤§é‡å†…å­˜ï¼Œ åˆå¿«é€Ÿå›æ”¶äº†å®ƒä»¬ï¼Œæ­¤æ—¶`holmes`åœ¨å‘¨æœŸå‰åçš„é‡‡é›†åˆ°å†…å­˜ä½¿ç”¨ç‡æ²¡æœ‰äº§ç”Ÿè¿‡å¤§æ³¢åŠ¨ï¼Œä¸å®é™…æƒ…å†µä¸ç¬¦ã€‚ä¸ºäº†è§£å†³è¿™ç§æƒ…å†µï¼Œ`holmes`å¼€å‘äº†åŸºäºGCå‘¨æœŸçš„Â `Profile`ç±»å‹ï¼Œå®ƒä¼šåœ¨å†…å­˜ä½¿ç”¨ç‡é£™é«˜çš„å‰åä¸¤ä¸ªGCå‘¨æœŸå†…å„dumpä¸€æ¬¡profileï¼Œç„¶åå¼€å‘äººå‘˜å¯ä»¥ä½¿ç”¨`pprof --base`å‘½ä»¤å»å¯¹æ¯” ä¸¤ä¸ªæ—¶åˆ»å †å†…å­˜ä¹‹é—´çš„å·®å¼‚ã€‚Â [å…·ä½“å®ç°ä»‹ç»](https://uncledou.site/2022/go-pprof-heap/)ã€‚

```go
	h, _ := holmes.New(
		holmes.WithDumpPath("/tmp"),
		holmes.WithLogger(holmes.NewFileLog("/tmp/holmes.log", mlog.INFO)),
		holmes.WithBinaryDump(),
		holmes.WithMemoryLimit(100*1024*1024), // 100MB
		holmes.WithGCHeapDump(10, 20, 40, time.Minute),
		// holmes.WithProfileReporter(reporter),
	)
	h.EnableGCHeapDump().Start()
	time.Sleep(time.Hour)
```

### åŠ¨æ€è®¾ç½®holmesé…ç½®

æ‚¨å¯ä»¥é€šè¿‡`Set`åœ¨ç³»ç»Ÿè¿è¡Œæ—¶æ›´æ–°holmesçš„é…ç½®ã€‚å®ƒçš„ä½¿ç”¨ååˆ†ç®€å•ï¼Œå’Œåˆå§‹åŒ–æ—¶çš„`New`æ–¹æ³•ä¸€æ ·ã€‚

```go
    h.Set(
        WithCollectInterval("2s"),
        WithGoroutineDump(10, 10, 50, 90, time.Minute))
```

### Dumpäº‹ä»¶ä¸ŠæŠ¥

æ‚¨å¯ä»¥é€šè¿‡å®ç°`Reporter`Â æ¥å®ç°ä»¥ä¸‹åŠŸèƒ½ï¼š

- å‘é€åŒ…å«ç°åœºçš„å‘Šè­¦ä¿¡æ¯ï¼Œå½“`holmes`è§¦å‘`Dump`æ“ä½œæ—¶ã€‚
- å°†`Profiles`ä¸Šä¼ åˆ°å…¶ä»–åœ°æ–¹ï¼Œä»¥é˜²å®ä¾‹è¢«é”€æ¯ï¼Œä»è€Œå¯¼è‡´profileä¸¢å¤±ï¼Œæˆ–è¿›è¡Œåˆ†æã€‚

```go
        type ReporterImpl struct{}
        func (r *ReporterImpl) 	Report(pType string, filename string, reason ReasonType, eventID string, sampleTime time.Time, pprofBytes []byte, scene Scene) error{ 
			// do something	
        }
        ......
        r := &ReporterImpl{} // a implement of holmes.ProfileReporter Interface.
    	h, _ := holmes.New(
            holmes.WithProfileReporter(reporter),
            holmes.WithDumpPath("/tmp"),
            holmes.WithLogger(holmes.NewFileLog("/tmp/holmes.log", mlog.INFO)),
            holmes.WithBinaryDump(),
            holmes.WithMemoryLimit(100*1024*1024), // 100MB
            holmes.WithGCHeapDump(10, 20, 40, time.Minute),
)
  
```

### å¼€å¯å…¨éƒ¨


holmeså½“ç„¶ä¸æ˜¯åªæ”¯æŒä¸€ä¸ªç±»å‹çš„dumpå•¦ï¼Œæ‚¨å¯ä»¥æŒ‰éœ€é€‰æ‹©æ‚¨éœ€è¦çš„dumpç±»å‹ã€‚

```go
h, _ := holmes.New(
    holmes.WithCollectInterval("5s"),
    holmes.WithDumpPath("/tmp"),
    holmes.WithTextDump(),

    holmes.WithCPUDump(10, 25, 80, time.Minute),
    holmes.WithMemDump(30, 25, 80, time.Minute),
    holmes.WithGCHeapDump(10, 20, 40, time.Minute),
    holmes.WithGoroutineDump(500, 25, 20000, 0, time.Minute),
)

    h.EnableCPUDump().
    EnableGoroutineDump().
	EnableMemDump().
	EnableGCHeapDump().Start()
```

### åœ¨docker æˆ–è€…cgroupç¯å¢ƒä¸‹è¿è¡Œ holmes

```go
h, _ := holmes.New(
    holmes.WithCollectInterval("5s"),
    holmes.WithDumpPath("/tmp"),
    holmes.WithTextDump(),

    holmes.WithCPUDump(10, 25, 80, time.Minute),
    holmes.WithCGroup(true), // set cgroup to true
)
```

## å·²çŸ¥é£é™©

Gorountine dump ä¼šå¯¼è‡´ STWï¼Œ[ä»è€Œå¯¼è‡´æ—¶å»¶](https://github.com/golang/go/issues/33250)ã€‚

> ç›®å‰Goå®˜æ–¹å·²ç»æœ‰ä¸€ä¸ª[CL](https://go-review.googlesource.com/c/go/+/387415/)åœ¨ä¼˜åŒ–è¿™ä¸ªé—®é¢˜äº†ã€‚


# è®¡ç®—å¯†é›†å‹æœåŠ¡ æ€§èƒ½ä¼˜åŒ–å®æˆ˜å§‹æœ«

## èƒŒæ™¯

### é¡¹ç›®èƒŒæ™¯

![å›¾ç‰‡](https://mmbiz.qpic.cn/mmbiz_png/YdZzofiato9J4NAbEHy096EYh9xr2FGpb7icWgeIGia56F49kT8wuVZFicUY1SHaJV1xcJeTWib3t922t8H2ufyFN1A/640?wx_fmt=png&tp=webp&wxfrom=5&wx_lazy=1&wx_co=1)

worker æœåŠ¡æ•°æ®é“¾è·¯å›¾  

worker æœåŠ¡æ¶ˆè´¹ä¸Šæ¸¸æ•°æ®ï¼ˆå·¥ä½œæ—¥é«˜å³°æœŸäº§å‡ºé€Ÿåº¦è¾¾è¿‘Â **200 MB/s**ï¼ŒèŠ‚å‡æ—¥é«˜å³°æœŸå¯è¾¾Â **300MB/s**Â ä»¥ä¸Šï¼‰ï¼Œè¿›è¡Œä¸­é—´å¤„ç†åï¼Œå†™å…¥å¤šä¸ªä¸‹æ¸¸ã€‚åœ¨å®è·µä¸­ç»“åˆä¸šåŠ¡åœºæ™¯ï¼ŒåŸºäº**å¿«æ…¢éš”ç¦»**çš„æ€æƒ³ï¼Œä»¥ä¸‰ä¸ªä¸åŒçš„ consumer group æ¶ˆè´¹åŒä¸€ Topicï¼Œéš”ç¦»ä¸‰ç§æ•°æ®å¤„ç†é“¾è·¯ã€‚

### é¢å¯¹é—®é¢˜

- worker æœåŠ¡åœ¨é«˜å³°æœŸæ—¶ CPU Idle ä¼šé™è‡³ 60%ï¼Œå› å…¶å±äºæ•°æ®å¤„ç†ç±»è®¡ç®—å¯†é›†å‹æœåŠ¡ï¼ŒCPU Idle è¿‡ä½ä¼šä½¿æœåŠ¡ååé™ä½ï¼Œåœ¨æ•°æ®å¤„ç†ä¸Šäº§ç”Ÿè¾ƒå¤§å»¶æ—¶ï¼Œä¸”å—é™äº Kafka åˆ†åŒºæ•°ï¼Œæ— æ³•è¿›è¡Œæ¨ªå‘æ‰©å®¹ï¼›
- å¯¹ä¸Šæ¸¸æ•°æ®çš„é‡‡æ ·ç‡è¾¾ **30%**ï¼Œä¸šåŠ¡æ–¹å¯¹æ•°æ®çš„å®Œæ•´æ€§æœ‰è¾ƒå¤§è¯‰æ±‚ï¼Œä½†ç³»ç»Ÿ CPU å­˜åœ¨ç“¶é¢ˆï¼Œæ— æ³•æ»¡è¶³ï¼›

## æ€§èƒ½ä¼˜åŒ–

é’ˆå¯¹ä»¥ä¸Šé—®é¢˜ï¼Œå¼€å§‹ç€æ‰‹å¯¹æœåŠ¡ CPU Idle è¿›è¡Œä¼˜åŒ–ï¼›æŠ“å–æœåŠ¡ pprof profile å›¾å¦‚ä¸‹ï¼šgo tool pprof -http=:6061 http://ã€Œip:portã€/debug/pprof/profile
![[Pasted image 20240806131249.png]]
ä¼˜åŒ–å‰çš„ pprof profile å›¾  

### æœåŠ¡ä¸å­˜å‚¨ä¹‹é—´ç½®æ¢å‹åŠ›

#### èƒŒæ™¯

worker æœåŠ¡æ¶ˆè´¹åˆ°ä¸Šæ¸¸æ•°æ®åï¼Œä¼šå…ˆå†™å…¨éƒ¨å†™å…¥ Apollo çš„æ•°æ®åº“ï¼Œä¹‹åæ¯åˆ†é’Ÿå®šæ—¶æå–å¤„ç†ï¼Œä½†æ¶ˆæ¯ä½“å¤§å° P99 åˆ†ä½è¾¾è¿‘Â **1.5M**ï¼Œå¯¹äº Apollo æœ‰è¾ƒä¸¥é‡çš„å¤§ Key é—®é¢˜ï¼Œå†ç»“åˆ RocksDB ç‰¹æœ‰çš„å†™æ”¾å¤§é—®é¢˜ï¼Œä¼šè¿›ä¸€æ­¥åŠ å‰§å­˜å‚¨å‹åŠ›ã€‚åœ¨è¿™ä¸ªèƒŒæ™¯ä¸‹ï¼Œæˆ‘ä»¬é‡‡ç”¨ zlib å‹ç¼©ç®—æ³•ï¼Œå¯¹æ¶ˆæ¯ä½“å…ˆè¿›è¡Œå‹ç¼©åå†å†™å…¥ Apolloï¼Œå‡ç¼“è¯»å†™å¤§ Key å¯¹ Apollo çš„å‹åŠ›ã€‚

#### ä¼˜åŒ–

åœ¨ CPU çš„ä¼˜åŒ–è¿‡ç¨‹ä¸­ï¼Œæˆ‘ä»¬å‘ç°æœåŠ¡åœ¨å‹ç¼©æ“ä½œä¸Šå ç”¨äº†è¾ƒå¤šçš„ CPUï¼Œäºæ˜¯å¯¹å‹ç¼©ç­‰çº§è¿›è¡Œè°ƒæ•´ï¼Œä»¥å‡å°å‹ç¼©ç‡ã€å¢å¤§ä¸‹æ¸¸å­˜å‚¨å‹åŠ›ä¸ºä»£ä»·ï¼Œå‡å°‘å‹ç¼©æ“ä½œå¯¹æœåŠ¡ CPU çš„å ç”¨ï¼Œæå‡æœåŠ¡ CPU ã€‚è¿™ä¸€æ“ä½œæœ¬è´¨ä¸Šæ˜¯åœ¨æœåŠ¡ä¸å­˜å‚¨ä¹‹é—´è¿›è¡Œå‹åŠ›ç½®æ¢ï¼Œæ˜¯ä¸€ç§**ç©ºé—´æ¢æ—¶é—´**çš„åšæ³•ã€‚

#### å…³äºå‹ç¼©ç­‰çº§

è¿™é‡Œéœ€è¦ç‰¹åˆ«æ³¨æ„çš„æ˜¯ï¼Œåœ¨å‹ç¼©ç­‰çº§çš„è®¾ç½®ä¸Šå¯èƒ½å­˜åœ¨è¾ƒä¸ºä¸¥é‡çš„**è¾¹é™…æ•ˆç”¨é€’å‡**é—®é¢˜ã€‚åœ¨è¿›è¡ŒåŸºå‡†æµ‹è¯•æ—¶å‘ç°ï¼Œå°†å‹ç¼©ç­‰çº§ç”± BestCompression è°ƒæ•´ä¸º DefaultCompression åï¼Œå‹ç¼©ç‡åªæœ‰è¿‘Â **1â€±**Â çš„ä¸‹é™ï¼Œä½†å‹ç¼©æ–¹é¢çš„ CPU å ç”¨å´ç›¸å¯¹æé«˜è¿‘ **50%**ã€‚æ­¤ç»“è®ºä¸èƒ½é€‚ç”¨äºæ‰€æœ‰åœºæ™¯ï¼Œéœ€ä»å®é™…æƒ…å†µå‡ºå‘ï¼Œä½†åœ¨ä½¿ç”¨æ—¶åº”æ³¨æ„è¿™ä¸ªé—®é¢˜ï¼Œé€‰æ‹©ç›¸å¯¹æœ€ä¼˜çš„å‹ç¼©æ–¹å¼ã€‚
![[Pasted image 20240806131341.png]]
zlib å¯è®¾ç½®çš„å‹ç¼©ç­‰çº§  

### ä½¿ç”¨æ›´é«˜æ•ˆçš„åºåˆ—åŒ–åº“

#### èƒŒæ™¯

worker æœåŠ¡åœ¨è®¾è®¡ä¹‹åˆåŸºäºå¿«æ…¢éš”ç¦»çš„æ€æƒ³ï¼Œä½¿ç”¨ä¸‰ä¸ªä¸åŒçš„ consumer group è¿›è¡Œåˆ†å¼€æ¶ˆè´¹ï¼Œå¯¼è‡´å¯¹åŒä¸€ä»½æ•°æ®ä¼šé‡å¤æ¶ˆè´¹ä¸‰æ¬¡ï¼Œè€Œä¸Šæ¸¸äº§å‡ºçš„æ•°æ®æ˜¯åœ¨ PB åºåˆ—åŒ–ä¹‹åå†™å…¥ Kafkaï¼Œæ¶ˆè´¹ä¾§äº¦éœ€è¦è¿›è¡Œ PB ååºåˆ—åŒ–æ–¹èƒ½ä½¿ç”¨ï¼Œå› æ­¤å¯¼è‡´äº† PB ååºåˆ—åŒ–æ“ä½œåœ¨ CPU ä¸Šçš„è¾ƒå¤§å¼€é”€ã€‚

#### ä¼˜åŒ–

ç»è¿‡æ¢è®¨å’Œè°ƒç ”åå‘ç°ï¼Œgogo/protobuf ä¸‰æ–¹åº“ç›¸è¾ƒäºåŸç”Ÿçš„ golang/protobuf åº“æ€§èƒ½æ›´å¥½ï¼Œåœ¨ CPU ä¸Šå ç”¨æ›´ä½ï¼Œé€Ÿåº¦æ›´å¿«ï¼Œå› æ­¤é‡‡ç”¨ gogo/protobuf åº“æ›¿æ¢æ‰åŸç”Ÿçš„ golang/protobuf åº“ã€‚

#### gogo/protobuf ä¸ºä»€ä¹ˆå¿«

- é€šè¿‡å¯¹æ¯ä¸€ä¸ªå­—æ®µéƒ½ç”Ÿæˆä»£ç çš„æ–¹å¼ï¼Œ**å–æ¶ˆäº†å¯¹åå°„çš„ä½¿ç”¨**ï¼›
- é‡‡ç”¨é¢„è®¡ç®—æ–¹å¼ï¼Œåœ¨åºåˆ—åŒ–æ—¶èƒ½å¤Ÿå‡å°‘å†…å­˜åˆ†é…æ¬¡æ•°ï¼Œè¿›è€Œ**å‡å°‘äº†å†…å­˜åˆ†é…**å¸¦æ¥çš„ç³»ç»Ÿè°ƒç”¨ã€é”å’Œ GC ç­‰ä»£ä»·ã€‚

> ç”¨è¿‡å»æˆ–æœªæ¥æ¢ç°åœ¨çš„æ—¶é—´ï¼šé¡µé¢é™æ€åŒ–ã€æ± åŒ–æŠ€æœ¯ã€é¢„ç¼–è¯‘ã€ä»£ç ç”Ÿæˆç­‰éƒ½æ˜¯æå‰åšä¸€äº›äº‹æƒ…ï¼Œç”¨è¿‡å»çš„æ—¶é—´ï¼Œæ¥é™ä½ç”¨æˆ·åœ¨çº¿æœåŠ¡çš„å“åº”æ—¶é—´ï¼›å¦å¤–å¯¹äºä¸€äº›åœ¨çº¿æœåŠ¡éå¿…é¡»çš„è®¡ç®—ã€å­˜å‚¨çš„è€—æ—¶æ“ä½œï¼Œä¹Ÿå¯ä»¥å¼‚æ­¥åŒ–å»¶åè¿›è¡Œå¤„ç†ï¼Œè¿™å°±æ˜¯ç”¨æœªæ¥çš„æ—¶é—´æ¢ç°åœ¨çš„æ—¶é—´ã€‚å‡ºå¤„ï¼šhttps://mp.weixin.qq.com/s/S8KVnG0NZDrylenIwSCq8g

#### å…³äºåºåˆ—åŒ–åº“

è¿™é‡Œåªåˆ—ä¸¾çš„äº† PB åºåˆ—åŒ–åº“çš„ä¼˜åŒ– Caseï¼Œä½†åœ¨ JSON åºåˆ—åŒ–æ–¹é¢ä¹Ÿå­˜åœ¨ä¸€æ ·çš„ä¼˜åŒ–æ‰‹æ®µï¼Œå¦‚ json-iteratorã€sonicã€gjson ç­‰ç­‰ï¼Œæˆ‘ä»¬åœ¨ Feature æœåŠ¡ä¸­å…ˆåé‡‡ç”¨äº† json-iterator ä¸ gjson åº“æ›¿æ¢åŸæœ‰çš„æ ‡å‡†åº“ JSON åºåˆ—åŒ–æ–¹å¼ï¼Œå‡å–å¾—äº†æ˜¾è‘—æ•ˆæœã€‚JSON åº“è°ƒç ”æŠ¥å‘Šï¼šhttps://segmentfault.com/a/1190000041591284
![[Pasted image 20240806131438.png]]
è°ƒæ•´å‹ç¼©ç­‰çº§ä¸æ›´æ¢ PB åºåˆ—åŒ–åº“ä¹‹å  

### æ•°æ®æ”’æ‰¹ å‡å°‘è°ƒç”¨

#### èƒŒæ™¯

åœ¨è§‚å¯Ÿ pprof å›¾åå‘ç°å†™ hbase å ç”¨äº†è¿‘ 50% çš„ç›¸å¯¹ CPUï¼Œç»è¿‡è¿›ä¸€æ­¥åˆ†æåï¼Œå‘ç°æ¯æ¬¡åœ¨åºåˆ—åŒ–ä¸€ä¸ªå­—æ®µæ—¶ Thrift éƒ½ä¼šè°ƒç”¨ä¸€æ¬¡ socket->syscallï¼Œå¸¦æ¥é¢‘ç¹çš„ä¸Šä¸‹æ–‡åˆ‡æ¢å¼€é”€ã€‚

#### ä¼˜åŒ–

é˜…è¯»ä»£ç åå‘ç°ï¼Œ åŸä»£ç ä¸­ä½¿ç”¨äº† Thrift çš„ TTransport å®ç°ï¼Œå…¶åŠŸèƒ½æ˜¯åŒ…è£… TSocketï¼Œè£¸è°ƒ Syscallï¼Œæ¯æ¬¡ Write æ—¶éƒ½ä¼šè°ƒç”¨ socket å†™å…¥è¿›è€Œè°ƒç”¨ Syscallã€‚è¿™ä¸é€šå¸¸æˆ‘ä»¬çš„ç¼–ç ä¹ æƒ¯ä¸ç¬¦ï¼Œè®¤ä¸ºåº”è¯¥æœ‰ä¸€ä¸ª buffer å……å½“ä¸­é—´å±‚è¿›è¡Œæ•°æ®æ”’æ‰¹ï¼Œå½“ buffer å†™å®Œæˆ–è€…å†™æ»¡åå†å‘ä¸‹å±‚å†™å…¥ã€‚äºæ˜¯è¿›ä¸€æ­¥é˜…è¯» Thrift æºç ï¼Œå‘ç°å…¶ä¸­æœ‰å¤šç§ Transport å®ç°ï¼Œè€Œ TTBufferedTransport æ˜¯ç¬¦åˆæˆ‘ä»¬ç¼–ç ä¹ æƒ¯çš„ã€‚
![[Pasted image 20240806131525.png]]
å¯¹ Thrift è°ƒç”¨è¿›è¡Œä¼˜åŒ–ï¼Œä½¿ç”¨å¸¦ buffer çš„ transportï¼Œå¤§å¤§å‡å°‘å¯¹ Syscallçš„è°ƒç”¨
![[Pasted image 20240806131547.png]]
æ›´æ¢ transport ä¹‹åï¼Œå¯¹ HBase çš„è°ƒç”¨æ¶ˆè€—åªå‰©æœ€å³ä¾§çš„ä¸€æ¡äº†  
![[Pasted image 20240806131606.png]]
å¯¹ HBase çš„è®¿é—®è€—æ—¶å¤§å¹…ä¸‹é™  

#### Thrift Client éƒ¨åˆ†æºç åˆ†æ

Transport ä½¿ç”¨äº†è£…é¥°å™¨æ¨¡å¼

|Transport å®ç°|ä½œç”¨|
|---|---|
|TTransport|åŒ…è£… TSocketï¼Œè£¸è°ƒ Syscallï¼Œæ¯æ¬¡ Write éƒ½ä¼šè°ƒç”¨ syscallï¼›|
|TTBufferedTransport|éœ€è¦æå‰å£°æ˜ buffer çš„å¤§å°ï¼Œåœ¨è°ƒç”¨ Socket ä¹‹å‰åŠ äº†ä¸€å±‚ bufferï¼Œå†™æ»¡æˆ–è€…å†™å®Œä¹‹åå†è°ƒç”¨ Syscallï¼›|
|TFramedTransport|ä¸ TTBufferedTransport ç±»ä¼¼ï¼Œä½†åªä¼šåœ¨å…¨éƒ¨å†™å…¥ buffer åï¼Œå†è°ƒç”¨ Syscallã€‚æ•°æ®æ ¼å¼ä¸ºï¼šsize+contentï¼Œå®¢æˆ·ç«¯ä¸æœåŠ¡ç«¯å¿…é¡»éƒ½ä½¿ç”¨è¯¥å®ç°ï¼Œå¦åˆ™ä¼šå› ä¸ºæ ¼å¼ä¸å…¼å®¹æŠ¥é”™ï¼›|
|streamTransport|ä¼ å…¥è‡ªå·±å®ç°çš„ IO æ¥å£ï¼›|
|TMemoryBufferTransport|çº¯å†…å­˜äº¤æ¢ï¼Œä¸ä¸ç½‘ç»œäº¤äº’ï¼›|

Protocol

  

|Protocol å®ç°|ä½œç”¨|
|---|---|
|TBinaryProtocol|ç›´æ¥çš„äºŒè¿›åˆ¶æ ¼å¼ï¼›|
|TCompactProtocol|ç´§å‡‘å‹ã€é«˜æ•ˆå’Œå‹ç¼©çš„äºŒè¿›åˆ¶æ ¼å¼ï¼›|
|TJSONProtocol|JSON æ ¼å¼ï¼›|
|TSimpleJSONProtocol|SimpleJSON äº§ç”Ÿçš„è¾“å‡ºé€‚ç”¨äº AJAX æˆ–è„šæœ¬è¯­è¨€ï¼Œå®ƒä¸ä¿ç•™Thriftçš„å­—æ®µæ ‡ç­¾ï¼Œä¸èƒ½è¢« Thrift è¯»å›ï¼Œå®ƒä¸åº”è¯¥ä¸å…¨åŠŸèƒ½çš„ TJSONProtocol ç›¸æ··æ·†ï¼›https://cwiki.apache.org/confluence/display/THRIFT/ThriftUsageJava|

#### å…³äºæ•°æ®æ”’æ‰¹

æ•°æ®æ”’æ‰¹ï¼šå°†æ•°æ®å…ˆå†™å…¥ç”¨æˆ·æ€å†…å­˜ä¸­ï¼Œè€Œåç»Ÿä¸€è°ƒç”¨ syscall è¿›è¡Œå†™å…¥ï¼Œå¸¸ç”¨åœ¨æ•°æ®è½ç›˜ã€ç½‘ç»œä¼ è¾“ä¸­ï¼Œå¯é™ä½ç³»ç»Ÿè°ƒç”¨æ¬¡æ•°ã€åˆ©ç”¨ç£ç›˜é¡ºåºå†™ç‰¹æ€§ç­‰ï¼Œæ˜¯ä¸€ç§ç©ºé—´æ¢æ—¶é—´çš„åšæ³•ã€‚æœ‰æ—¶ä¹Ÿä¼šç‰ºç‰²ä¸€å®šçš„æ•°æ®å®æ—¶æ€§ï¼Œå¦‚ kafka producer ä¾§ã€‚ç›¸ä¼¼ä¼˜åŒ–å¯è§ï¼šhttps://mp.weixin.qq.com/s/ntNGz6mjlWE7gb_ZBc5YeA

### è¯­æ³•è°ƒæ•´

é™¤åœ¨å¯¹åº“çš„ä½¿ç”¨ä¸Šè¿›è¡Œä¼˜åŒ–å¤–ï¼Œåœ¨ GO è¯­è¨€æœ¬èº«çš„ä½¿ç”¨ä¸Šä¹Ÿå­˜åœ¨ä¸€äº›ä¼˜åŒ–æ–¹å¼ï¼›

- sliceã€map é¢„åˆå§‹åŒ–ï¼Œå‡å°‘é¢‘ç¹æ‰©å®¹å¯¼è‡´çš„å†…å­˜æ‹·è´ä¸åˆ†é…å¼€é”€ï¼›
- å­—ç¬¦ä¸²è¿æ¥ä½¿ç”¨ strings.builder(é¢„åˆå§‹åŒ–) ä»£æ›¿ fmt.Sprintf()ï¼›
```go
func ConcatString(sl ...string) string {
   n := 0
   for i := 0; i < len(sl); i++ {
      n += len(sl[i])
   }

   var b strings.Builder
   b.Grow(n)
   for _, v := range sl {
      b.WriteString(v)
   }
   return b.String()
}

```

- buffer ä¿®æ”¹è¿”å› string([]byte) æ“ä½œä¸º []byteï¼Œå‡å°‘å†…å­˜ []byte -> string çš„å†…å­˜æ‹·è´å¼€é”€ï¼›
![[Pasted image 20240806131649.png]]

- string <-> []byte çš„å¦ä¸€ç§ä¼˜åŒ–ï¼Œéœ€ç¡®ä¿ []byte å†…å®¹åç»­ä¸ä¼šè¢«ä¿®æ”¹ï¼Œå¦åˆ™ä¼šå‘ç”Ÿ panicï¼›
```go
func String2Bytes(s string) []byte {
    sh := (*reflect.StringHeader)(unsafe.Pointer(&s))
    bh := reflect.SliceHeader{
        Data: sh.Data,
        Len:  sh.Len,
        Cap:  sh.Len,
    }
    return *(*[]byte)(unsafe.Pointer(&bh))
}

func Bytes2String(b []byte) string {
    return *(*string)(unsafe.Pointer(&b))
}


```

#### å…³äºè¯­æ³•è°ƒæ•´

æ›´å¤šè¯­æ³•è°ƒæ•´ï¼Œè§ä»¥ä¸‹æ–‡ç« 

- https://www.bacancytechnology.com/blog/golang-performance
    
- https://mp.weixin.qq.com/s/Lv2XTD-SPnxT2vnPNeREbg
    

### GC è°ƒä¼˜

#### èƒŒæ™¯

åœ¨ä¸Šæ¬¡ä¼˜åŒ–å®Œæˆä¹‹åï¼Œç³»ç»Ÿå·²ç»åŸºæœ¬ç¨³å®šï¼ŒCPU Idle é«˜å³°æœŸä¹Ÿå¯ä»¥ç»´æŒåœ¨ 80% å·¦å³ï¼Œä½†åç»­å› ä¸šåŠ¡è¯‰æ±‚å¯¹ä¸Šæ¸¸æ•°æ®é‡‡æ ·ç‡è°ƒæ•´è‡³ 100%ï¼ŒCPU.Idle é«˜å³°æœŸæŒ‡æ ‡å†æ¬¡ä¸‹é™è‡³è¿‘ 70%ï¼Œä¸”ç”±äºå®šæ—¶ä»»åŠ¡çš„é—®é¢˜ï¼Œå­˜åœ¨ CPU.Idle æ‰ 0 é£é™©ï¼›

#### ä¼˜åŒ–

ç»è¿‡å¯¹ pprof çš„å†æ¬¡åˆ†æï¼Œå‘ç° runtime.gcMarkWorker å ç”¨ä¸åˆå¸¸ç†ï¼Œè¾¾åˆ°è¿‘ 30%ï¼Œäºæ˜¯å¼€å§‹ç€æ‰‹å¯¹ GC è¿›è¡Œä¼˜åŒ–ï¼›
![[Pasted image 20240806131856.png]]
GC ä¼˜åŒ–å‰ pprof å›¾  

##### æ–¹æ³•ä¸€ï¼šä½¿ç”¨ sync.pool()

é€šå¸¸æ¥è¯´ä½¿ç”¨ sync.pool() ç¼“å­˜å¯¹è±¡ï¼Œå‡å°‘å¯¹è±¡åˆ†é…æ•°ï¼Œæ˜¯ä¼˜åŒ– GC çš„æœ€ä½³æ–¹å¼ï¼Œå› æ­¤æˆ‘ä»¬åœ¨é¡¹ç›®ä¸­ä½¿ç”¨å…¶å¯¹ bytes.buffer å¯¹è±¡è¿›è¡Œç¼“å­˜å¤ç”¨ï¼Œæ„å›¾å‡å°‘ GC å¼€é”€ï¼Œä½†å®é™…ä¸Šçº¿åÂ **CPU Idle å´ç•¥å¾®ä¸‹é™ï¼Œä¸” GC é—®é¢˜å¹¶æ— ç¼“è§£**ã€‚åŸå› æœ‰äºŒï¼š

1. sync.pool æ˜¯å…¨å±€å¯¹è±¡ï¼Œè¯»å†™å­˜åœ¨ç«äº‰é—®é¢˜ï¼Œå› æ­¤åœ¨è¿™æ–¹é¢ä¼šæ¶ˆè€—ä¸€å®šçš„ CPUï¼Œä½†ä¹‹æ‰€ä»¥é€šå¸¸ç”¨å®ƒä¼˜åŒ–å CPU ä¼šæœ‰æå‡ï¼Œæ˜¯å› ä¸ºå®ƒçš„å¯¹è±¡å¤ç”¨åŠŸèƒ½å¯¹ GC å¸¦æ¥çš„ä¼˜åŒ–ï¼Œå› æ­¤ sync.pool çš„ä¼˜åŒ–æ•ˆæœå–å†³äºé”ç«äº‰å¢åŠ çš„ CPU æ¶ˆè€—ä¸ä¼˜åŒ– GC å‡å°‘çš„ CPU æ¶ˆè€—è¿™ä¸¤è€…çš„å·®å€¼ï¼›
    
2. GC å‹åŠ›çš„å¤§å°é€šå¸¸å–å†³äº inuse_objectsï¼Œä¸ inuse_heap æ— å…³ï¼Œä¹Ÿå°±æ˜¯è¯´ä¸æ­£åœ¨ä½¿ç”¨çš„å¯¹è±¡æ•°æœ‰å…³ï¼Œä¸æ­£åœ¨ä½¿ç”¨çš„å †å¤§å°æ— å…³ï¼›

æœ¬æ¬¡ä¼˜åŒ–æ—¶é€‰æ‹©å¯¹ bytes.buffer è¿›è¡Œå¤ç”¨ï¼Œæ˜¯æƒ³åšåˆ°å‡å°‘å †å¤§å°çš„åˆ†é…ï¼Œå‡ºå‘ç‚¹é”™äº†ï¼Œå¯¹ GC é—®é¢˜çš„ç†è§£æœ‰è¯¯ï¼Œå¯¹ GC çš„ä¼˜åŒ–å› ä» pprof heap å›¾ inuse_objects ä¸ alloc_objects ä¸¤ä¸ªæŒ‡æ ‡å‡ºå‘ã€‚
![[Pasted image 20240806131945.png]]
ç”šè‡³æ²¡æœ‰ä¾èµ–ç»éªŒï¼Œ åªæ˜¯å•çº¯çš„æƒ³å½“ç„¶äº†ğŸ¤¦â€â™‚ï¸  

##### æ–¹æ³•äºŒï¼šè®¾ç½® GOGC

**åŸç†**ï¼šGOGC é»˜è®¤å€¼æ˜¯ 100ï¼Œä¹Ÿå°±æ˜¯ä¸‹æ¬¡ GC è§¦å‘çš„ heap çš„å¤§å°æ˜¯è¿™æ¬¡ GC ä¹‹åçš„ heap çš„ä¸€å€ï¼Œé€šè¿‡è°ƒå¤§ GOGC å€¼ï¼ˆgcpercentï¼‰çš„æ–¹å¼ï¼Œè¾¾åˆ°å‡å°‘ GC æ¬¡æ•°çš„ç›®çš„ï¼›

> å…¬å¼ï¼šgc_trigger = heap_marked * (1+gcpercent/100) gcpercentï¼šé€šè¿‡ GOGC æ¥è®¾ç½®ï¼Œé»˜è®¤æ˜¯ 100ï¼Œä¹Ÿå°±æ˜¯å½“å‰å†…å­˜åˆ†é…åˆ°è¾¾ä¸Šæ¬¡å­˜æ´»å †å†…å­˜ 2 å€æ—¶ï¼Œè§¦å‘ GCï¼›heap_markedï¼šä¸Šä¸€ä¸ª GC ä¸­è¢«æ ‡è®°çš„(å­˜æ´»çš„)å­—èŠ‚æ•°ï¼›

**é—®é¢˜**ï¼šGOGC å‚æ•°ä¸æ˜“æ§åˆ¶ï¼Œè®¾ç½®è¾ƒå°æå‡æœ‰é™ï¼Œè®¾ç½®è¾ƒå¤§å®¹æ˜“æœ‰ OOM é£é™©ï¼Œå› ä¸ºå †å¤§å°æœ¬èº«æ˜¯åœ¨å®æ—¶å˜åŒ–çš„ï¼Œåœ¨ä»»ä½•æµé‡ä¸‹éƒ½è®¾ç½®ä¸€ä¸ªå›ºå®šå€¼ï¼Œæ˜¯ä¸€ä»¶æœ‰é£é™©çš„äº‹æƒ…ã€‚è¿™ä¸ªé—®é¢˜ç›®å‰å·²ç»æœ‰è§£å†³æ–¹æ¡ˆï¼ŒUber å‘è¡¨çš„æ–‡ç« ä¸­æåˆ°äº†ä¸€ç§è‡ªåŠ¨è°ƒæ•´ GOGC å‚æ•°çš„æ–¹æ¡ˆï¼Œç”¨äºåœ¨è¿™ç§æ–¹å¼ä¸‹ä¼˜åŒ– GO çš„ GC CPU å ç”¨ï¼Œä¸è¿‡ä¸šç•Œè¿˜æ²¡æœ‰å¼€æºç›¸å…³å®ç°
![[Pasted image 20240806132020.png]]
è®¾ç½® GOGC è‡³ 1000% åï¼ŒGC å ç”¨å¤§å¹…ç¼©å°
![[Pasted image 20240806132039.png]]
å†…å­˜åˆ©ç”¨ç‡æ¥è¿‘ 100%
![[Pasted image 20240806132050.png]]
##### æ–¹æ³•ä¸‰ï¼šGO ballast å†…å­˜æ§åˆ¶

> ballast å‹èˆ±ç‰©--èˆªæµ·ã€‚ä¸ºæä¾›æ‰€éœ€çš„åƒæ°´å’Œç¨³å®šæ€§è€Œä¸´æ—¶æˆ–æ°¸ä¹…æºå¸¦åœ¨èˆ¹ä¸Šçš„é‡å‹ææ–™ã€‚æ¥æºï¼šDictionary.com

**åŸç†**ï¼šä»ç„¶æ˜¯ä»åˆ©ç”¨äº†ä¸‹æ¬¡ GC è§¦å‘çš„ heap çš„å¤§å°æ˜¯è¿™æ¬¡ GC ä¹‹åçš„ heap çš„ä¸€å€è¿™ä¸€åŸç†ï¼Œåˆå§‹åŒ–ä¸€ä¸ªç”Ÿå‘½å‘¨æœŸè´¯ç©¿æ•´ä¸ª Go åº”ç”¨ç”Ÿå‘½å‘¨æœŸçš„è¶…å¤§ sliceï¼Œç”¨äºå†…å­˜å ä½ï¼Œå¢å¤§ heap_marked å€¼é™ä½ GC é¢‘ç‡ï¼›å®é™…æ“ä½œæœ‰ä»¥ä¸‹ä¸¤ç§æ–¹å¼

> å…¬å¼ï¼šgc_trigger = heap_marked * (1+gcpercent/100) gcpercentï¼šé€šè¿‡ GOGC æ¥è®¾ç½®ï¼Œé»˜è®¤æ˜¯ 100ï¼Œä¹Ÿå°±æ˜¯å½“å‰å†…å­˜åˆ†é…åˆ°è¾¾ä¸Šæ¬¡å­˜æ´»å †å†…å­˜ 2 å€æ—¶ï¼Œè§¦å‘ GCï¼›heap_markedï¼šä¸Šä¸€ä¸ª GC ä¸­è¢«æ ‡è®°çš„(å­˜æ´»çš„)å­—èŠ‚æ•°ï¼›
![[Pasted image 20240806132114.png]]
æ–¹å¼ä¸€
![[Pasted image 20240806132126.png]]
æ–¹å¼äºŒ  

ä¸¤ç§æ–¹å¼éƒ½å¯ä»¥è¾¾åˆ°åŒæ ·çš„æ•ˆæœï¼Œä½†æ˜¯æ–¹å¼ä¸€ä¼šå®é™…å ç”¨ç‰©ç†å†…å­˜ï¼Œåœ¨å¯è§‚æµ‹æ€§ä¸Šä¼šæ›´èˆ’æœä¸€ç‚¹ï¼Œæ–¹å¼äºŒå¹¶ä¸ä¼šå®é™…å ç”¨ç‰©ç†å†…å­˜ã€‚

> åŸå› ï¼šMemory in â€˜nix (and even Windows) systems is virtually addressed and mapped through page tables by the OS. When the above code runs, the array the ballast slice points to will be allocated in the programâ€™s virtual address space. Only if we attempt to read or write to the slice, will the page fault occur that causes the physical RAM backing the virtual addresses to be allocated. å¼•ç”¨è‡ªï¼šhttps://blog.twitch.tv/en/2019/04/10/go-memory-ballast-how-i-learnt-to-stop-worrying-and-love-the-heap/
![[Pasted image 20240806132206.png]]
ä¼˜åŒ–å GC é¢‘ç‡ç”±æ¯ç§’ 5 æ¬¡é™ä½åˆ°äº†æ¯ç§’ 0.1 æ¬¡
![[Pasted image 20240806132243.png]]
ä½¿ç”¨ ballast å†…å­˜æ§åˆ¶åï¼ŒGC å ç”¨ç¼©å°è‡³çº¢æ¡†å¤§å°
![[Pasted image 20240806132232.png]]
ä½¿ç”¨æ–¹å¼ä¸€åï¼Œå†…å­˜å§‹ç»ˆç¨³å®šåœ¨ 25% -30%ï¼Œå³ 3G å¤§å°  

**ç›¸æ¯”äºè®¾ç½® GOGC çš„ä¼˜åŠ¿**

- å®‰å…¨æ€§æ›´é«˜ï¼ŒOOM é£é™©å°ï¼›
    
- æ•ˆæœæ›´å¥½ï¼Œå¯ä»¥ä» pprof å›¾çœ‹å‡ºï¼Œåè€…çš„ä¼˜åŒ–æ•ˆæœæ›´å¤§ï¼›
    

**è´Ÿé¢è€ƒé‡**é—®ï¼šè™½ç„¶é€šè¿‡å¤§åˆ‡ç‰‡å ä½çš„æ–¹å¼å¯ä»¥æœ‰æ•ˆé™ä½ GC é¢‘ç‡ï¼Œä½†æ˜¯æ¯æ¬¡ GC éœ€è¦æ‰«æå’Œå›æ”¶çš„å¯¹è±¡æ•°é‡å˜å¤šäº†ï¼Œæ˜¯å¦ä¼šå¯¼è‡´è¿›è¡Œ GC çš„é‚£ä¸€æ®µæ—¶é—´äº§ç”Ÿè€—æ—¶æ¯›åˆºï¼Ÿç­”ï¼šä¸ä¼šï¼ŒGC æœ‰ä¸¤ä¸ªé˜¶æ®µ mark ä¸ sweepï¼Œunused_objects åªä¸ sweep é˜¶æ®µæœ‰å…³ï¼Œä½†è¿™ä¸ªè¿‡ç¨‹æ˜¯éå¸¸å¿«é€Ÿçš„ï¼›mark é˜¶æ®µæ˜¯ GC æ—¶é—´å ç”¨æœ€ä¸»è¦çš„éƒ¨åˆ†ï¼Œä½†å…¶åªä¸å½“å‰çš„ inuse_objects æœ‰å…³ï¼Œä¸ unused_objects æ— å¤ªå¤§å…³ç³»ï¼›å› æ­¤ï¼Œç»¼ä¸Šæ‰€è¿°ï¼Œé™ä½é¢‘ç‡ç¡®å®ä¼šè®©æ¯æ¬¡ GC æ—¶çš„ unused_objects æœ‰æ‰€å¢é•¿ï¼Œä½†å¹¶ä¸ä¼šå¯¹ GC å¢åŠ å¤ªå¤šè´Ÿæ‹…ï¼›

> å…³äº ballast å†…å­˜æ§åˆ¶æ›´è¯¦ç»†çš„å†…å®¹è¯·çœ‹ï¼šhttps://blog.twitch.tv/en/2019/04/10/go-memory-ballast-how-i-learnt-to-stop-worrying-and-love-the-heap/

#### å…³äº GC è°ƒä¼˜

- GC ä¼˜åŒ–æ‰‹æ®µçš„ä¼˜å…ˆçº§ï¼šè®¾ç½® GOGCã€GO ballast å†…å­˜æ§åˆ¶ç­‰æ“ä½œæ˜¯ä¸€ç§æ²»æ ‡ä¸æ²»æœ¬ç•¥æ˜¾ trick çš„æ–¹å¼ï¼Œåœ¨åš GC ä¼˜åŒ–æ—¶è¿˜åº”å…ˆä»å¯¹è±¡å¤ç”¨ã€å‡å°‘å¯¹è±¡åˆ†é…è§’åº¦ç€æ‰‹ï¼Œåœ¨ç¡®æ— ä¼˜åŒ–ç©ºé—´æˆ–ä¼˜åŒ–æˆæœ¬è¾ƒå¤§æ—¶ï¼Œå†é€‰æ‹©æ­¤ç§æ–¹å¼ï¼›
    
- è®¾ç½® GOGCã€GO ballast å†…å­˜æ§åˆ¶ç­‰æ“ä½œæœ¬è´¨ä¸Šä¹Ÿæ˜¯ä¸€ç§ç©ºé—´æ¢æ—¶é—´çš„åšæ³•ï¼Œåœ¨å†…å­˜ä¸ CPU ä¹‹é—´è¿›è¡Œå‹åŠ›ç½®æ¢ï¼›
    
- åœ¨ GC è°ƒä¼˜æ–¹é¢ï¼Œè¿˜æœ‰å¾ˆå¤šå…¶ä»–ä¼˜åŒ–æ–¹å¼ï¼Œå¦‚ bigcache åœ¨å †å†…å®šä¹‰å¤§æ•°ç»„åˆ‡ç‰‡è‡ªè¡Œç®¡ç†ã€fastcache ç›´æ¥è°ƒç”¨ syscall.mmap ç”³è¯·å †å¤–å†…å­˜ä½¿ç”¨ã€offheap ä½¿ç”¨ cgo ç®¡ç†å †å¤–å†…å­˜ç­‰ç­‰ã€‚
    

## ä¼˜åŒ–æ•ˆæœ
![[Pasted image 20240806132356.png]]
é»„è‰²çº¿ï¼šè°ƒæ•´å‹ç¼©ç­‰çº§ä¸æ›´æ¢ PB åºåˆ—åŒ–åº“ï¼›ç»¿è‰²çº¿ï¼šThrift åºåˆ—åŒ–æ›´æ¢å¸¦ buffer çš„ transportï¼›
![[Pasted image 20240806132413.png]]
è“è‰²æ›²çº¿æŠ–åŠ¨æ˜¯å› ä¸ºä¸Šæ¸¸ä¸šåŠ¡æ”¾é‡ï¼Œååˆåšå‚ç›´ä¼¸ç¼©å°† CPU ç”± 8 æ ¸æè‡³ 16 æ ¸ GC ä¼˜åŒ–ï¼ˆçº¢æ¡†éƒ¨åˆ†ï¼‰  

- å…ˆåå°† CPU æå‡ **25%ã€10%**ï¼ˆå‡è®¾ä¸åšä¼¸ç¼©ï¼‰ï¼›
    
- æ”¯æŒä¸Šæ¸¸æ•°æ®Â **100%**Â æ”¾é‡ï¼›
    
- é€šè¿‡å¯¹ CPU ç“¶é¢ˆçš„è§£å†³ï¼Œé¡ºåˆ©åˆå¹¶æœåŠ¡ï¼Œä¸‹æ‰Â **70 å°**å®¹å™¨ã€‚
    

## æ€»ç»“

**ç»éªŒåˆ†äº«**

- åšæ€§èƒ½ä¼˜åŒ–ç»éªŒå¾ˆé‡è¦ï¼Œå…¶æ¬¡åœ¨ä¼˜åŒ–ä¹‹å‰æŒæ¡ä¸€éƒ¨åˆ†å‰ç½®çŸ¥è¯†æ›´å¥½ï¼›
    
- å¹³æ—¶å¤šçœ‹ä¸€äº›èµ„æ–™å­¦ä¹ ï¼Œæœ‰ä¼˜åŒ–æœºä¼šå°±æŠ“ä½å®è·µï¼Œé¿å…ä¹¦åˆ°ç”¨æ—¶æ–¹æ¨å°‘ï¼›
    
- ä»”ç»†è§‚å¯Ÿ pprof å›¾ï¼Œåˆ†æå¤§å—éƒ¨åˆ†ï¼›
    
- è§‚å¯Ÿé—®é¢˜ç‚¹çš„ api ä½¿ç”¨ï¼Œå¯èƒ½å…·æœ‰æ›´é«˜æ•ˆçš„ä½¿ç”¨æ–¹å¼
    
- è®°å½•ä¼˜åŒ–è¿‡ç¨‹å’Œä¼˜åŒ–æ•ˆæœï¼Œä»¥ååˆ†äº«ã€å¹é€¼ç”¨çš„ä¸Šï¼›
    
- æœ€å¥½å¯ä»¥æ„å»ºç¨³å®šçš„åŸºå‡†ç¯å¢ƒï¼ŒéªŒè¯æ•ˆæœï¼›
    
- ç©ºé—´æ¢æ—¶é—´æ˜¯ä¸‡èƒ½é’¥åŒ™ï¼Œå·¥ç¨‹é—®é¢˜ä¸è¦åª case by case çš„çœ‹ï¼Œå¾ˆå¤šè§£å†³æ–¹æ¡ˆéƒ½æ˜¯åŒä¸€ç§æ€æƒ³çš„ä¸åŒè½åœ°ï¼Œå°è¯•å»æ€»ç»“å’ŒæŒæ¡è¿™ç§æ€æƒ³ï¼Œæœ€åè¾¾åˆ°è¿ç§»å¤ç”¨çš„æ•ˆæœï¼›
    
- å¤šå’Œå¤§ä½¬è®¨è®ºï¼Œéå¸¸é‡è¦ï¼Œä»¥ä¸Šå¤šé¡¹ä¼˜åŒ–éƒ½å‡ºè‡ªä¸å¤§ä½¬ï¼ˆç‰¹åˆ«é¸£è°¢ @æå°å®‡@æ›¹æ˜¥æ™–ï¼‰è®¨è®ºåçš„å®è·µï¼›
    
# IO å¯†é›†å‹æœåŠ¡ æ€§èƒ½ä¼˜åŒ–å®æˆ˜è®°å½•

## èƒŒæ™¯

### é¡¹ç›®èƒŒæ™¯

Feature æœåŠ¡ä½œä¸ºç‰¹å¾æœåŠ¡ï¼Œäº§å‡ºç‰¹å¾æ•°æ®ä¾›ä¸Šæ¸¸ä¸šåŠ¡ä½¿ç”¨ã€‚æœåŠ¡å‹åŠ›ï¼šé«˜å³°æœŸ API æ¨¡å— 10wQPSï¼Œè®¡ç®—æ¨¡å— 20wQPSã€‚æœåŠ¡æœ¬åœ°ç¼“å­˜æœºåˆ¶ï¼š

- è®¡ç®—æ¨¡å—æœ‰æœ¬åœ°ç¼“å­˜ï¼Œä¸”å‘½ä¸­ç‡è¾ƒé«˜ï¼Œæœ€é«˜å¯è¾¾ 50% å·¦å³ï¼›
- è®¡ç®—æ¨¡å—æœ¬åœ°ç¼“å­˜åœ¨æ¯åˆ†é’Ÿç¬¬ 0 ç§’ä¼šå…¨éƒ¨å¤±æ•ˆï¼Œè€Œåœ¨æ­¤æ—¶æµé‡ä¼šå…¨éƒ¨å‡»ç©¿è‡³ä¸‹æ¸¸ Codisï¼›
- Codis ä¸­ Key å = ç‰¹å¾å + åœ°ç†æ ¼å­ Id + åˆ†é’Ÿçº§æ—¶é—´ä¸²ï¼›

![å›¾ç‰‡](https://mmbiz.qpic.cn/mmbiz_png/YdZzofiato9LJXrEicIt094ztVYzNoAxyAlqkibcA9FDIxSAnGDZCfKWVOsj6VmHmmho3ibxKibSXC8Jic6eEsmq1d7Q/640?wx_fmt=png&tp=webp&wxfrom=5&wx_lazy=1&wx_co=1)

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â Feature æœåŠ¡æ¨¡å—å›¾

### é¢å¯¹é—®é¢˜

æœåŠ¡ API ä¾§å­˜åœ¨è¾ƒä¸¥é‡çš„ P99 è€—æ—¶æ¯›åˆºé—®é¢˜ï¼ˆå›ºå®šå‡ºç°åœ¨æ¯åˆ†é’Ÿç¬¬ 0-10sï¼‰ï¼Œå¯¼è‡´ä¸Šæ¸¸æœåŠ¡çš„è®¿é—®é”™è¯¯ç‡è¾¾åˆ° 1â€° ä»¥ä¸Šï¼Œå½±å“åˆ°ä¸šåŠ¡æŒ‡æ ‡ï¼›ç›®æ ‡ï¼šè§£å†³è€—æ—¶æ¯›åˆºé—®é¢˜ï¼Œå°† P99 è€—æ—¶æ•´ä½“ä¼˜åŒ–è‡³ 15ms ä»¥ä¸‹ï¼›![å›¾ç‰‡](https://mmbiz.qpic.cn/mmbiz_png/YdZzofiato9LJXrEicIt094ztVYzNoAxyAEvFFyicbBh0hKmIcym63NMJZybCIeIhP8lK9cMFHZBibDBwoR0SfFuCA/640?wx_fmt=png&tp=webp&wxfrom=5&wx_lazy=1&wx_co=1)Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â API æ¨¡å—è¿”å›ä¸Šæ¸¸ P99 è€—æ—¶å›¾

## è§£å†³æ–¹æ¡ˆ

### æœåŠ¡ CPU ä¼˜åŒ–

#### èƒŒæ™¯

å¶ç„¶çš„ä¸€æ¬¡ä¸Šçº¿å˜åŠ¨ä¸­ï¼Œå‘ç°å¯¹ Feature æœåŠ¡æ¥è¯´ CPU çš„ä½¿ç”¨ç‡çš„é«˜ä½ä¼šè¾ƒå¤§ç¨‹åº¦ä¸Šå½±å“åˆ°æœåŠ¡è€—æ—¶ï¼Œå› æ­¤ä»**æé«˜æœåŠ¡ CPU Idle**Â è§’åº¦å…¥æ‰‹ï¼Œå¯¹æœåŠ¡è€—æ—¶æ¯›åˆºé—®é¢˜å±•å¼€ä¼˜åŒ–ã€‚

#### ä¼˜åŒ–

é€šè¿‡å¯¹ Pprof profile å›¾çš„è§‚å¯Ÿå‘ç° JSON ååºåˆ—åŒ–æ“ä½œå ç”¨äº†è¾ƒå¤§æ¯”ä¾‹ï¼ˆ50% ä»¥ä¸Šï¼‰ï¼Œå› æ­¤é€šè¿‡å‡å°‘ååºåˆ—åŒ–æ“ä½œã€æ›´æ¢ JSON åºåˆ—åŒ–åº“ï¼ˆjson-iteratorï¼‰ä¸¤ç§æ–¹å¼è¿›è¡Œäº†ä¼˜åŒ–ã€‚
#### æ•ˆæœ

æ”¶ç›Šï¼šCPU idle æå‡ 5%ï¼ŒP99 è€—æ—¶æ¯›åˆºä» 30ms é™ä½è‡³Â **20 ms ä»¥ä¸‹**ã€‚
![å›¾ç‰‡](https://mmbiz.qpic.cn/mmbiz_png/YdZzofiato9LJXrEicIt094ztVYzNoAxyAxDWTcia2v3En2kvibucqRQtj2W9Q56IC0nicwsPOUXK9kg8bmgd6eqSdw/640?wx_fmt=png&tp=webp&wxfrom=5&wx_lazy=1&wx_co=1)ä¼˜åŒ–åçš„è€—æ—¶æ›²çº¿ï¼ˆçº¢è‰²ä¸ç»¿è‰²çº¿ï¼‰

#### å…³äº CPU ä¸è€—æ—¶

**ä¸ºä»€ä¹ˆ CPU Idle æå‡è€—æ—¶ä¼šä¸‹é™**

- ååºåˆ—åŒ–æ—¶çš„å¼€é”€å‡å°‘ï¼Œä½¿å•ä¸ªè¯·æ±‚ä¸­çš„è®¡ç®—æ—¶é—´å¾—åˆ°äº†å‡å°‘ï¼›
- å•ä¸ªè¯·æ±‚çš„å¤„ç†æ—¶é—´å‡å°‘ï¼Œä½¿åŒæ—¶å¹¶å‘å¤„ç†çš„è¯·æ±‚æ•°å¾—åˆ°äº†å‡å°‘ï¼Œå‡è½»äº†è°ƒåº¦åˆ‡æ¢ã€åç¨‹/çº¿ç¨‹æ’é˜Ÿã€èµ„æºç«äº‰çš„å¼€é”€ï¼›

#### å…³äº json-iterator åº“

**json-iterator åº“ä¸ºä»€ä¹ˆå¿«**æ ‡å‡†åº“ json åº“ä½¿ç”¨ reflect.Value è¿›è¡Œå–å€¼ä¸èµ‹å€¼ï¼Œä½† reflect.Value ä¸æ˜¯ä¸€ä¸ªå¯å¤ç”¨çš„åå°„å¯¹è±¡ï¼Œæ¯æ¬¡éƒ½éœ€è¦æŒ‰ç…§å˜é‡ç”Ÿæˆ reflect.Value ç»“æ„ä½“ï¼Œå› æ­¤æ€§èƒ½å¾ˆå·®ã€‚json-iterator å®ç°åŸç†æ˜¯ç”¨ reflect.Type å¾—å‡ºçš„ç±»å‹ä¿¡æ¯é€šè¿‡ã€Œå¯¹è±¡æŒ‡é’ˆåœ°å€+å­—æ®µåç§»ã€çš„æ–¹å¼ç›´æ¥è¿›è¡Œå–å€¼ä¸èµ‹å€¼ï¼Œè€Œä¸ä¾èµ–äº reflect.Valueï¼Œreflect.Type æ˜¯ä¸€ä¸ªå¯å¤ç”¨çš„å¯¹è±¡ï¼ŒåŒä¸€ç±»å‹çš„ reflect.Type æ˜¯ç›¸ç­‰çš„ï¼Œå› æ­¤å¯æŒ‰ç…§ç±»å‹å¯¹ reflect.Type è¿›è¡Œ cache å¤ç”¨ã€‚æ€»çš„æ¥è¯´å…¶ä½œç”¨æ˜¯**å‡å°‘å†…å­˜åˆ†é…**å’Œ**åå°„è°ƒç”¨æ¬¡æ•°**ï¼Œè¿›è€Œå‡å°‘äº†å†…å­˜åˆ†é…å¸¦æ¥çš„ç³»ç»Ÿè°ƒç”¨ã€é”å’Œ GC ç­‰ä»£ä»·ï¼Œä»¥åŠä½¿ç”¨åå°„å¸¦æ¥çš„å¼€é”€ã€‚

> è¯¦æƒ…å¯è§ï¼šhttps://cloud.tencent.com/developer/article/1064753

### è°ƒç”¨æ–¹å¼ä¼˜åŒ– - å¯¹å†²è¯·æ±‚

#### èƒŒæ™¯

1. Feature æœåŠ¡ API æ¨¡å—è®¿é—®è®¡ç®—æ¨¡å— P99 æ˜¾è‘—é«˜äº P95ï¼›![å›¾ç‰‡](https://mmbiz.qpic.cn/mmbiz_png/YdZzofiato9LJXrEicIt094ztVYzNoAxyArzDQiaiacfI9G4TJlrD8Tcvk2kRwnBxcH6oNVrkiaGUiczDuzP9gmkjgsw/640?wx_fmt=png&tp=webp&wxfrom=5&wx_lazy=1&wx_co=1)API æ¨¡å—è®¿é—®è®¡ç®—æ¨¡å— P99 ä¸ P95 è€—æ—¶æ›²çº¿
    
2. ç»è§‚å¯Ÿè®¡ç®—æ¨¡å—ä¸åŒæœºå™¨ä¹‹é—´æ¯›åˆºå‡ºç°æ—¶é—´ç‚¹ä¸åŒï¼Œå•æœºæ¯›åˆºå‘ˆ**å¶å‘ç°è±¡**ï¼Œæ‰€æœ‰æœºå™¨èšåˆçœ‹**å‘ˆè§„å¾‹æ€§**æ¯›åˆºï¼›![å›¾ç‰‡](https://mmbiz.qpic.cn/mmbiz_png/YdZzofiato9LJXrEicIt094ztVYzNoAxyAHALNSicOLKUkYOz7CvE8ictoBlcMnG0eO2fGeA05jXrqF8gwpmrwAYHw/640?wx_fmt=png&tp=webp&wxfrom=5&wx_lazy=1&wx_co=1)è®¡ç®—æ¨¡å—è¿”å› API P99 è€—æ—¶æ›²çº¿ï¼ˆæœªèšåˆï¼‰![å›¾ç‰‡](https://mmbiz.qpic.cn/mmbiz_png/YdZzofiato9LJXrEicIt094ztVYzNoAxyAricDY8PzgEeZNFgibvS2r8YcpsRIbe8A4ecfhye5XZTzLicKC0icBVceYw/640?wx_fmt=png&tp=webp&wxfrom=5&wx_lazy=1&wx_co=1)è®¡ç®—æ¨¡å—è¿”å› API P99 è€—æ—¶æ›²çº¿ï¼ˆå‡å€¼èšåˆï¼‰

#### ä¼˜åŒ–

1. é’ˆå¯¹ P99 é«˜äº P95 ç°è±¡ï¼Œæå‡ºå¯¹å†²è¯·æ±‚æ–¹æ¡ˆï¼Œå¯¹æ¯›åˆºé—®é¢˜è¿›è¡Œä¼˜åŒ–ï¼›

> å¯¹å†²è¯·æ±‚ï¼šæŠŠå¯¹ä¸‹æ¸¸çš„ä¸€æ¬¡è¯·æ±‚æ‹†æˆä¸¤ä¸ªï¼Œå…ˆå‘ç¬¬ä¸€ä¸ªï¼Œnæ¯«ç§’è¶…æ—¶åï¼Œå‘å‡ºç¬¬äºŒä¸ªï¼Œä¸¤ä¸ªè¯·æ±‚å“ªä¸ªå…ˆè¿”å›ç”¨å“ªä¸ªï¼›Hedged requests. A simple way to curb latency variability is to issue the same request to multiple replicas and use the results from whichever replica responds first. We term such requests â€œhedged requestsâ€ because a client first sends one request to the replica be- lieved to be the most appropriate, but then falls back on sending a secondary request after some brief delay. The cli- ent cancels remaining outstanding re- quests once the first result is received. Although naive implementations of this technique typically add unaccept- able additional load, many variations exist that give most of the latency-re- duction effects while increasing load only modestly. One such approach is to defer send- ing a secondary request until the first request has been outstanding for more than the 95th-percentile expected la- tency for this class of requests. This approach limits the additional load to approximately 5% while substantially shortening the latency tail. The tech- nique works because the source of la- tency is often not inherent in the par- ticular request but rather due to other forms of interference. æ‘˜è‡ªï¼šè®ºæ–‡ã€ŠThe Tail at Scaleã€‹

2. è°ƒç ”

- é˜…è¯»è®ºæ–‡ Googleã€ŠThe Tail at Scaleã€‹ï¼›
- å¼€æºå®ç°ï¼šBRPCã€RPCXï¼›
- å·¥ä¸šå®è·µï¼šç™¾åº¦é»˜è®¤å¼€å¯ã€Grab LBS æœåŠ¡ï¼ˆä¸‹æ¸¸çº¯å†…å­˜å‹æ•°æ®åº“ï¼‰æ•ˆæœéå¸¸æ˜æ˜¾ã€è°·æ­Œè®ºæ–‡ä¸­ä¹Ÿæœ‰ç›¸å…³çš„å®è·µæ•ˆæœé˜è¿°ï¼›

4. è½åœ°å®ç°ï¼šä¿®æ”¹è‡ª RPCX å¼€æºå®ç°
```go
package backuprequest


import (
 "sync/atomic"
 "time"

 "golang.org/x/net/context"
)


var inflight int64

// call represents an active RPC.
type call struct {
 Name  string
 Reply interface{} // The reply from the function (*struct).
 Error error       // After completion, the error status.
 Done  chan *call  // Strobes when call is complete.
}


func (call *call) done() {
 select {
 case call.Done <- call:
 default:
  logger.Debug("rpc: discarding Call reply due to insufficient Done chan capacity")
 }
}


func BackupRequest(backupTimeout time.Duration, fn func() (interface{}, error)) (interface{}, error) {
 ctx, cancelFn := context.WithCancel(context.Background())
 defer cancelFn()
 callCh := make(chan *call, 2)
 call1 := &call{Done: callCh, Name: "first"}
 call2 := &call{Done: callCh, Name: "second"}


 go func(c *call) {
  defer helpers.PanicRecover()
  c.Reply, c.Error = fn()
  c.done()
 }(call1)


 t := time.NewTimer(backupTimeout)
 select {
 case <-ctx.Done(): // cancel by context
  return nil, ctx.Err()
 case c := <-callCh:
  t.Stop()
  return c.Reply, c.Error
 case <-t.C:
  go func(c *call) {
   defer helpers.PanicRecover()
   defer atomic.AddInt64(&inflight, -1)
   if atomic.AddInt64(&inflight, 1) > BackupLimit {
    metric.Counter("backup", map[string]string{"mark": "limited"})
    return
   }

   metric.Counter("backup", map[string]string{"mark": "trigger"})
   c.Reply, c.Error = fn()
   c.done()
  }(call2)
 }


 select {
 case <-ctx.Done(): // cancel by context
  return nil, ctx.Err()
 case c := <-callCh:
  metric.Counter("backup_back", map[string]string{"call": c.Name})
  return c.Reply, c.Error
 }
}

```

#### æ•ˆæœ

æ”¶ç›Šï¼šP99 è€—æ—¶æ•´ä½“ä» 20-60ms é™ä½è‡³ 6msï¼Œæ¯›åˆºå…¨éƒ¨å¹²æ‰ï¼›ï¼ˆbackupTimeout=5msï¼‰
![å›¾ç‰‡](https://mmbiz.qpic.cn/mmbiz_png/YdZzofiato9LJXrEicIt094ztVYzNoAxyAhXEHUwAUao8ZhdhHq9zxMr3OTwwWh0jagJB1Vy4Jh0aVxlqLBPDekQ/640?wx_fmt=png&tp=webp&wxfrom=5&wx_lazy=1&wx_co=1)API æ¨¡å—è¿”å›ä¸Šæ¸¸æœåŠ¡è€—æ—¶ç»Ÿè®¡å›¾

#### ã€ŠThe Tail at Scaleã€‹è®ºæ–‡èŠ‚é€‰åŠè§£è¯»

æ‹¬å·ä¸­å†…å®¹ä¸ºä¸ªäººè§£è¯»**ä¸ºä»€ä¹ˆå­˜åœ¨å˜å¼‚æ€§ï¼Ÿï¼ˆé«˜å°¾éƒ¨å»¶è¿Ÿçš„å“åº”æ—¶é—´ï¼‰**

- å¯¼è‡´æœåŠ¡çš„ä¸ªåˆ«éƒ¨åˆ†å‡ºç°é«˜å°¾éƒ¨å»¶è¿Ÿçš„å“åº”æ—¶é—´çš„å˜å¼‚æ€§ï¼ˆè€—æ—¶é•¿å°¾çš„åŸå› ï¼‰å¯èƒ½ç”±äºè®¸å¤šåŸå› è€Œäº§ç”Ÿï¼ŒåŒ…æ‹¬ï¼š
- å…±äº«çš„èµ„æºã€‚æœºå™¨å¯èƒ½è¢«ä¸åŒçš„åº”ç”¨ç¨‹åºå…±äº«ï¼Œäº‰å¤ºå…±äº«èµ„æºï¼ˆå¦‚CPUæ ¸å¿ƒã€å¤„ç†å™¨ç¼“å­˜ã€å†…å­˜å¸¦å®½å’Œç½‘ç»œå¸¦å®½ï¼‰ï¼ˆåœ¨äº‘ä¸Šç¯å¢ƒä¸­è¿™ä¸ªé—®é¢˜æ›´ç”šï¼Œå¦‚ä¸åŒå®¹å™¨èµ„æºäº‰æŠ¢ã€Sidecar è¿›ç¨‹å½±å“ï¼‰ï¼›åœ¨åŒä¸€ä¸ªåº”ç”¨ç¨‹åºä¸­ï¼Œä¸åŒçš„è¯·æ±‚å¯èƒ½äº‰å¤ºèµ„æºã€‚
- å®ˆæŠ¤ç¨‹åºã€‚åå°å®ˆæŠ¤ç¨‹åºå¯èƒ½å¹³å‡åªä½¿ç”¨æœ‰é™çš„èµ„æºï¼Œä½†åœ¨å®‰æ’æ—¶å¯èƒ½äº§ç”Ÿå‡ æ¯«ç§’çš„ä¸­æ–­ã€‚
- å…¨å±€èµ„æºå…±äº«ã€‚åœ¨ä¸åŒæœºå™¨ä¸Šè¿è¡Œçš„åº”ç”¨ç¨‹åºå¯èƒ½ä¼šäº‰å¤ºå…¨çƒèµ„æºï¼ˆå¦‚ç½‘ç»œäº¤æ¢æœºå’Œå…±äº«æ–‡ä»¶ç³»ç»Ÿï¼ˆæ•°æ®åº“ï¼‰ï¼‰ã€‚
- ç»´æŠ¤æ´»åŠ¨ã€‚åå°æ´»åŠ¨ï¼ˆå¦‚åˆ†å¸ƒå¼æ–‡ä»¶ç³»ç»Ÿä¸­çš„æ•°æ®é‡å»ºï¼ŒBigTableç­‰å­˜å‚¨ç³»ç»Ÿä¸­çš„å®šæœŸæ—¥å¿—å‹ç¼©ï¼ˆæ­¤å¤„æŒ‡ LSM Compaction æœºåˆ¶ï¼ŒåŸºäº RocksDB çš„æ•°æ®åº“çš†æœ‰æ­¤é—®é¢˜ï¼‰ï¼Œä»¥åŠåƒåœ¾æ”¶é›†è¯­è¨€ä¸­çš„å®šæœŸåƒåœ¾æ”¶é›†ï¼ˆè‡ªèº«å’Œä¸Šä¸‹æ¸¸éƒ½ä¼šæœ‰ GC é—®é¢˜ 1. Codis proxy ä¸º GO è¯­è¨€æ‰€å†™ï¼Œä¹Ÿä¼šæœ‰ GC é—®é¢˜ï¼›2. æ­¤æ¬¡ Feature æœåŠ¡è€—æ—¶æ¯›åˆºå³æ—¶å› ä¸ºæœåŠ¡æœ¬èº« GC é—®é¢˜ï¼Œè¯¦æƒ…è§ä¸‹æ–‡ï¼‰ä¼šå¯¼è‡´å‘¨æœŸæ€§çš„å»¶è¿Ÿé«˜å³°ï¼›ä»¥åŠæ’é˜Ÿã€‚ä¸­é—´æœåŠ¡å™¨å’Œç½‘ç»œäº¤æ¢æœºçš„å¤šå±‚æ’é˜Ÿæ”¾å¤§äº†è¿™ç§å˜åŒ–æ€§ã€‚
    

**å‡å°‘ç»„ä»¶çš„å¯å˜æ€§**

- åå°ä»»åŠ¡å¯ä»¥äº§ç”Ÿå·¨å¤§çš„CPUã€ç£ç›˜æˆ–ç½‘ç»œè´Ÿè½½ï¼›ä¾‹å­æ˜¯é¢å‘æ—¥å¿—çš„å­˜å‚¨ç³»ç»Ÿçš„æ—¥å¿—å‹ç¼©å’Œåƒåœ¾æ”¶é›†è¯­è¨€çš„åƒåœ¾æ”¶é›†å™¨æ´»åŠ¨ã€‚
    
- é€šè¿‡èŠ‚æµã€å°†é‡é‡çº§çš„æ“ä½œåˆ†è§£æˆè¾ƒå°çš„æ“ä½œï¼ˆä¾‹å¦‚ GOã€Redis rehash æ—¶æ¸è¿›å¼æ¬è¿ï¼‰ï¼Œå¹¶åœ¨æ•´ä½“è´Ÿè½½è¾ƒä½çš„æ—¶å€™è§¦å‘è¿™äº›æ“ä½œï¼ˆä¾‹å¦‚æŸæ•°æ®åº“å°† RocksDB Compaction æ“ä½œæ”¾åœ¨å‡Œæ™¨å®šæ—¶æ‰§è¡Œï¼‰ï¼Œé€šå¸¸èƒ½å¤Ÿå‡å°‘åå°æ´»åŠ¨å¯¹äº¤äº’å¼è¯·æ±‚å»¶è¿Ÿçš„å½±å“ã€‚
    

**å…³äºæ¶ˆé™¤å˜å¼‚æº**

- æ¶ˆé™¤å¤§è§„æ¨¡ç³»ç»Ÿä¸­æ‰€æœ‰çš„å»¶è¿Ÿå˜å¼‚æºæ˜¯ä¸ç°å®çš„ï¼Œç‰¹åˆ«æ˜¯åœ¨å…±äº«ç¯å¢ƒä¸­ã€‚
    
- ä½¿ç”¨ä¸€ç§ç±»ä¼¼äºå®¹é”™è®¡ç®—çš„æ–¹æ³•ï¼ˆæ­¤å¤„æŒ‡å¯¹å†²è¯·æ±‚ï¼‰ï¼Œå®¹å°¾è½¯ä»¶æŠ€æœ¯ä»ä¸å¤ªå¯é¢„æµ‹çš„éƒ¨åˆ†ä¸­å½¢æˆä¸€ä¸ªå¯é¢„æµ‹çš„æ•´ä½“ï¼ˆå¯¹ä¸‹æ¸¸è€—æ—¶æ›²çº¿è¿›è¡Œå»ºæ¨¡ï¼Œä»æ¦‚ç‡çš„è§’åº¦è¿›è¡Œä¼˜åŒ–ï¼‰ã€‚
    
- ä¸€ä¸ªçœŸå®çš„è°·æ­ŒæœåŠ¡çš„æµ‹é‡ç»“æœï¼Œè¯¥æœåŠ¡åœ¨é€»è¾‘ä¸Šä¸è¿™ä¸ªç†æƒ³åŒ–çš„åœºæ™¯ç›¸ä¼¼ï¼›æ ¹æœåŠ¡å™¨é€šè¿‡ä¸­é—´æœåŠ¡å™¨å°†ä¸€ä¸ªè¯·æ±‚åˆ†å‘åˆ°å¤§é‡çš„å¶å­æœåŠ¡å™¨ã€‚è¯¥è¡¨æ˜¾ç¤ºäº†å¤§æ‰‡å‡ºå¯¹å»¶è¿Ÿåˆ†å¸ƒçš„å½±å“ã€‚åœ¨æ ¹æœåŠ¡å™¨ä¸Šæµ‹é‡çš„å•ä¸ªéšæœºè¯·æ±‚å®Œæˆçš„ç¬¬99ä¸ªç™¾åˆ†ç‚¹çš„å»¶è¿Ÿæ˜¯10msã€‚ç„¶è€Œï¼Œæ‰€æœ‰è¯·æ±‚å®Œæˆçš„ç¬¬99ç™¾åˆ†ä½æ•°å»¶è¿Ÿæ˜¯140msï¼Œ95%çš„è¯·æ±‚å®Œæˆçš„ç¬¬99ç™¾åˆ†ä½æ•°å»¶è¿Ÿæ˜¯70msï¼Œè¿™æ„å‘³ç€ç­‰å¾…æœ€æ…¢çš„5%çš„è¯·æ±‚å®Œæˆçš„æ—¶é—´å æ€»çš„99%ç™¾åˆ†ä½æ•°å»¶è¿Ÿçš„ä¸€åŠã€‚ä¸“æ³¨äºè¿™äº›æ…¢é€Ÿå¼‚å¸¸å€¼çš„æŠ€æœ¯å¯ä»¥ä½¿æ•´ä½“æœåŠ¡æ€§èƒ½å¤§å¹…é™ä½ã€‚
    
- åŒæ ·ï¼Œç”±äºæ¶ˆé™¤æ‰€æœ‰çš„å˜å¼‚æ€§æ¥æºä¹Ÿæ˜¯ä¸å¯è¡Œçš„ï¼Œå› æ­¤æ­£åœ¨ä¸ºå¤§è§„æ¨¡æœåŠ¡å¼€å‘å°¾éƒ¨å®¹å¿æŠ€æœ¯ã€‚å°½ç®¡è§£å†³ç‰¹å®šçš„å»¶è¿Ÿå˜å¼‚æ¥æºçš„æ–¹æ³•æ˜¯æœ‰ç”¨çš„ï¼Œä½†æœ€å¼ºå¤§çš„å°¾éƒ¨å®¹é”™æŠ€æœ¯å¯ä»¥é‡æ–°è§£å†³å»¶è¿Ÿé—®é¢˜ï¼Œè€Œä¸è€ƒè™‘æ ¹æœ¬åŸå› ã€‚è¿™äº›å°¾éƒ¨å®¹å¿æŠ€æœ¯å…è®¸è®¾è®¡è€…ç»§ç»­ä¸ºæ™®é€šæƒ…å†µè¿›è¡Œä¼˜åŒ–ï¼ŒåŒæ—¶æä¾›å¯¹éæ™®é€šæƒ…å†µçš„æ¢å¤èƒ½åŠ›ã€‚
    

#### å¯¹å†²è¯·æ±‚åŸç†

![å›¾ç‰‡](https://mmbiz.qpic.cn/mmbiz_png/YdZzofiato9LJXrEicIt094ztVYzNoAxyAz6YzBhUlGLOicXwiaeo8TLZddM4HHYl1OtN9lDtiasthSRroxhNic5VBfQ/640?wx_fmt=png&tp=webp&wxfrom=5&wx_lazy=1&wx_co=1)å¯¹å†²è¯·æ±‚å…¸å‹åœºæ™¯

- å…¶åŸç†æ˜¯ä»æ¦‚ç‡è§’åº¦å‡ºå‘ï¼Œåˆ©ç”¨ä¸‹æ¸¸æœåŠ¡çš„è€—æ—¶æ¨¡å‹ï¼Œåœ¨è¿™æ¡è€—æ—¶æ›²çº¿ä¸Šä»»æ„å–ä¸¤ä¸ªç‚¹ï¼Œå…¶ä¸­ä¸€ä¸ªå°äºxçš„æ¦‚ç‡ï¼Œè¿™ä¸ªæ¦‚ç‡è¿œè¿œå¤§äºä»»æ„å–ä¸€ä¸ªç‚¹å°äºxçš„æ¦‚ç‡ï¼Œæ‰€ä»¥å¯ä»¥æå¤§ç¨‹åº¦é™ä½è€—æ—¶ï¼›
- ä½†å¦‚æœå¤šå‘çš„è¯·æ±‚å¤ªå¤šäº†ï¼Œæ¯”å¦‚è¯´1å€ï¼Œä¼šå¯¼è‡´ä¸‹æ¸¸å‹åŠ›å‰§å¢ï¼Œè€—æ—¶æ›²çº¿æ¨¡å‹äº§ç”Ÿæ¶åŒ–ï¼Œè¾¾ä¸åˆ°é¢„æœŸçš„æ•ˆæœï¼Œå¦‚æœæ§åˆ¶æ¯”å¦‚è¯´åœ¨5%ä»¥å†…ï¼Œä¸‹æ¸¸è€—æ—¶æ›²çº¿æ—¢ä¸ä¼šæ¶åŒ–ï¼Œä¹Ÿå¯ä»¥åˆ©ç”¨ä»–95åˆ†ä½ä¹‹å‰çš„é‚£ä¸ªå¹³æ»‘æ›²çº¿ï¼Œå› æ­¤å¯¹å†²è¯·æ±‚è¶…æ—¶æ—¶é—´çš„é€‰æ‹©ä¹Ÿæ˜¯ä¸€ä¸ªéœ€è¦å…³æ³¨çš„ç‚¹ï¼›
- å½“è¶…è¿‡95åˆ†ä½è€—æ—¶çš„æ—¶å€™ï¼Œå†å¤šå‘ä¸€ä¸ªè¯·æ±‚ï¼Œè¿™æ—¶å€™è¿™æ•´ä¸ªè¯·æ±‚å‰©ä½™çš„è€—æ—¶å°±å–å†³äºåœ¨è¿™æ•´ä¸ªçº¿ä¸Šä»»å–ä¸€ç‚¹ï¼Œå’Œåœ¨95åˆ†ä½ä¹‹åçš„é‚£ä¸ªçº¿ä¸Šä»»å–ä¸€ç‚¹ï¼Œè€—æ—¶æ˜¯è¿™ä¸¤ç‚¹ä¸­å°çš„é‚£ä¸ªï¼Œä»æ¦‚ç‡çš„è§’åº¦çœ‹ï¼Œè¿™æ ·95åˆ†ä½ä¹‹åçš„è€—æ—¶æ›²çº¿ï¼Œä¼šæ¯”ä¹‹å‰å¹³æ»‘ç›¸å½“å¤šï¼›
- è¿™ä¸ªå–èˆç›¸å½“å·§å¦™ï¼Œåªå¤šå‘5%çš„è¯·æ±‚ï¼Œå°±èƒ½åŸºæœ¬ä¸Šç›´æ¥å¹²æ‰é•¿å°¾æƒ…å†µï¼›
- å±€é™æ€§

- å¦‚åŒä¸€ä¸ª mget æ¥å£æŸ¥ 100 ä¸ª key ä¸æŸ¥ 10000 ä¸ª key è€—æ—¶ä¸€å®šå·®å¼‚å¾ˆå¤§ï¼Œè¿™ç§æƒ…å†µä¸‹å¯¹å†²è¯·æ±‚æ—¶æ— èƒ½ä¸ºåŠ›çš„ï¼Œå› æ­¤éœ€è¦ä¿è¯åŒä¸€ä¸ªæ¥å£è¯·æ±‚ä¹‹é—´è´¨é‡æ˜¯ç›¸ä¼¼çš„æƒ…å†µä¸‹ï¼Œè¿™æ ·ä¸‹æ¸¸çš„è€—æ—¶å› ç´ å°±ä¸å–å†³äºè¯·æ±‚å†…å®¹æœ¬èº«ï¼›
    
- å¦‚ Feature æœåŠ¡è®¡ç®—æ¨¡å—è®¿é—® Codis ç¼“å­˜å‡»ç©¿å¯¼è‡´çš„è€—æ—¶æ¯›åˆºé—®é¢˜ï¼Œåœ¨è¿™ç§æƒ…å†µä¸‹å¯¹å†²è¯·æ±‚ä¹Ÿæ— èƒ½ä¸ºåŠ›ï¼Œç”šè‡³ä¸€å®šæƒ…å†µä¸‹ä¼šæ¶åŒ–è€—æ—¶ï¼›
    
- è¯·æ±‚éœ€è¦å¹‚ç­‰ï¼Œå¦åˆ™ä¼šé€ æˆæ•°æ®ä¸ä¸€è‡´ï¼›
    
- æ€»å¾—æ¥è¯´å¯¹å†²è¯·æ±‚æ˜¯ä»**æ¦‚ç‡çš„è§’åº¦æ¶ˆé™¤å¶å‘å› ç´ çš„å½±å“**ï¼Œä»è€Œè§£å†³é•¿å°¾é—®é¢˜ï¼Œå› æ­¤éœ€è¦è€ƒé‡è€—æ—¶æ˜¯å¦ä¸ºä¸šåŠ¡ä¾§è‡ªèº«å›ºå®šå› ç´ å¯¼è‡´ï¼Œä¸¾ä¾‹å¦‚ä¸‹ï¼š
    
- å¯¹å†²è¯·æ±‚è¶…æ—¶æ—¶é—´å¹¶éåŠ¨æ€è°ƒæ•´è€Œæ˜¯äººä¸ºè®¾å®šï¼Œå› æ­¤æç«¯æƒ…å†µä¸‹ä¼šæœ‰é›ªå´©é£é™©ï¼Œè§£å†³æ–¹æ¡ˆè§ä¸€ä¸‹å°èŠ‚ï¼›
    

> åç§°æ¥æº backup request å¥½åƒæ˜¯ BRPC è½åœ°æ—¶å€™èµ·çš„åå­—ï¼Œè®ºæ–‡åŸæ–‡é‡Œå« Hedged requestsï¼Œç®€å•ç¿»è¯‘è¿‡æ¥æ˜¯å¯¹å†²è¯·æ±‚ï¼ŒGRPC ä¹Ÿä½¿ç”¨çš„è¿™ä¸ªåå­—ã€‚

#### å…³äºé›ªå´©é£é™©

å¯¹å†²è¯·æ±‚è¶…æ—¶æ—¶é—´å¹¶éåŠ¨æ€è°ƒæ•´ï¼Œè€Œæ˜¯äººä¸ºè®¾å®šï¼Œå› æ­¤æç«¯æƒ…å†µä¸‹ä¼šæœ‰é›ªå´©é£é™©ï¼›

![å›¾ç‰‡](https://mmbiz.qpic.cn/mmbiz_png/YdZzofiato9LJXrEicIt094ztVYzNoAxyADW2KvvW05q926sb4GSz4H84EK6DZKCRhia9RharVkBXkOfib2OqG4LXQ/640?wx_fmt=png&tp=webp&wxfrom=5&wx_lazy=1&wx_co=1)

æ‘˜è‡ªã€ŠGoogle SREã€‹ å¦‚æœä¸åŠ é™åˆ¶ç¡®å®ä¼šæœ‰é›ªå´©é£é™©ï¼Œæœ‰å¦‚ä¸‹è§£æ³•

- BRPC å®è·µï¼šå¯¹å†²è¯·æ±‚ä¼šæ¶ˆè€—ä¸€æ¬¡å¯¹ä¸‹æ¸¸çš„é‡è¯•æ¬¡æ•°ï¼›![å›¾ç‰‡](https://mmbiz.qpic.cn/mmbiz_png/YdZzofiato9LJXrEicIt094ztVYzNoAxyAAgIbadHUOUSbkNicFz5JobIRKu2OU0fF20QTZpFOzlBZ58GefBIbcOg/640?wx_fmt=png&tp=webp&wxfrom=5&wx_lazy=1&wx_co=1)
- bilibili å®è·µï¼š
    
- å¯¹ retry è¯·æ±‚ä¸‹æ¸¸ä¼šé˜»æ–­çº§è”ï¼›
- æœ¬èº«è¦åšç†”æ–­ï¼›
- åœ¨ middleware å±‚å®ç°çª—å£ç»Ÿè®¡ï¼Œé™åˆ¶é‡è¯•æ€»è¯·æ±‚å æ¯”ï¼Œæ¯”å¦‚ 1.1 å€ï¼›
- æœåŠ¡è‡ªèº«å¯¹ä¸‹æ¸¸å®ç°ç†”æ–­æœºåˆ¶ï¼Œä¸‹æ¸¸æœåŠ¡å¯¹ä¸Šæ¸¸æµé‡æœ‰é™æµæœºåˆ¶ï¼Œä¿è¯ä¸è¢«æ‰“å®ã€‚ä»ä¸¤æ–¹é¢å‡ºå‘ä¿è¯æœåŠ¡çš„ç¨³å®šæ€§ï¼›
- Feature æœåŠ¡å®è·µï¼šå¯¹æ¯ä¸ªå¯¹å†²è¯·æ±‚åœ¨å‘å‡ºå’Œè¿”å›æ—¶å¢åŠ  atmoic è‡ªå¢è‡ªå‡æ“ä½œï¼Œå¦‚æœå¤§äºæŸä¸ªå€¼ï¼ˆè¯·æ±‚è€—æ—¶ âœ–ï¸ QPS âœ–ï¸ 5%ï¼‰ï¼Œåˆ™ä¸å‘å‡ºå¯¹å†²è¯·æ±‚ï¼Œä»æ§åˆ¶å¹¶å‘è¯·æ±‚æ•°çš„è§’åº¦è¿›è¡Œæµé‡é™åˆ¶ï¼›
    

### è¯­è¨€ GC ä¼˜åŒ–

#### èƒŒæ™¯

åœ¨å¼•å…¥å¯¹å†²è¯·æ±‚æœºåˆ¶è¿›è¡Œä¼˜åŒ–åï¼Œåœ¨è€—æ—¶æ–¹é¢å–å¾—äº†çªç ´æ€§çš„è¿›å±•ï¼Œä½†ä¸ºä»æ ¹æœ¬ä¸Šè§£å†³è€—æ—¶æ¯›åˆºï¼Œä¼˜åŒ–æœåŠ¡å†…éƒ¨é—®é¢˜ï¼Œè¾¾åˆ°æ ‡æœ¬å…¼æ²»çš„ç›®çš„ï¼Œç€æ‰‹å¯¹æœåŠ¡çš„è€—æ—¶æ¯›åˆºé—®é¢˜è¿›è¡Œæœ€åçš„ä¼˜åŒ–ï¼›

#### ä¼˜åŒ–

**ç¬¬ä¸€æ­¥ï¼šè§‚å¯Ÿç°è±¡ï¼Œåˆæ­¥å®šä½åŸå› **å¯¹ Feature æœåŠ¡æ—©é«˜å³°æ¯›åˆºæ—¶çš„ Trace å›¾è¿›è¡Œè€—æ—¶åˆ†æåå‘ç°ï¼Œåœ¨æ¯›åˆºæœŸé—´ç¨‹åº GC pause æ—¶é—´ï¼ˆGC å‘¨æœŸä¸ä»»åŠ¡ç”Ÿå‘½å‘¨æœŸé‡å çš„æ€»å’Œï¼‰é•¿è¾¾è¿‘ 50+msï¼ˆè§å·¦å›¾ï¼‰ï¼Œç»å¤§å¤šæ•° goroutine åœ¨ GC æ—¶è¿›è¡Œäº†é•¿æ—¶é—´çš„è¾…åŠ©æ ‡è®°ï¼ˆmark assistï¼Œè§å³å›¾ä¸­æµ…ç»¿è‰²éƒ¨åˆ†ï¼‰ï¼ŒGC é—®é¢˜ä¸¥é‡ï¼Œå› æ­¤æ€€ç–‘è€—æ—¶æ¯›åˆºé—®é¢˜æ˜¯ç”± GC å¯¼è‡´ï¼›

![å›¾ç‰‡](https://mmbiz.qpic.cn/mmbiz_png/YdZzofiato9LJXrEicIt094ztVYzNoAxyA4t4VibkJa9hrdlUNXzzb1OBq9eL5FlXceicGZOIoOCvsIQyzOF486qQw/640?wx_fmt=png&tp=webp&wxfrom=5&wx_lazy=1&wx_co=1)![å›¾ç‰‡](https://mmbiz.qpic.cn/mmbiz_png/YdZzofiato9LJXrEicIt094ztVYzNoAxyAKda3AKnjNkdBC2ODoGLNPjo4CrOLueoictynhMe8pXP7z8a7jicTmcIw/640?wx_fmt=png&tp=webp&wxfrom=5&wx_lazy=1&wx_co=1)

**ç¬¬äºŒæ­¥ï¼šä»åŸå› å‡ºå‘ï¼Œè¿›è¡Œé’ˆå¯¹æ€§åˆ†æ**

- æ ¹æ®è§‚å¯Ÿè®¡ç®—æ¨¡å—æœåŠ¡å¹³å‡æ¯ 10 ç§’å‘ç”Ÿ 2 æ¬¡ GCï¼ŒGC é¢‘ç‡è¾ƒä½ï¼Œä½†åœ¨æ¯åˆ†é’Ÿå‰ 10s ç¬¬ä¸€æ¬¡ä¸ç¬¬äºŒæ¬¡çš„ GC å‹åŠ›å¤§å°ï¼ˆåš mark assist çš„ goroutine æ•°ï¼‰å‘ˆæ˜æ˜¾å·®è·ï¼Œå› æ­¤æ€€ç–‘æ˜¯åœ¨æ¯åˆ†é’Ÿå‰ 10s è¿›è¡Œç¬¬ä¸€æ¬¡ GC æ—¶çš„å‹åŠ›è¿‡é«˜å¯¼è‡´äº†è€—æ—¶æ¯›åˆºã€‚
- æ ¹æ® Golang GC åŸç†åˆ†æå¯çŸ¥ï¼ŒG è¢«æ‹›å‹Ÿå»åšè¾…åŠ©æ ‡è®°æ˜¯å› ä¸ºè¯¥ G åˆ†é…å †å†…å­˜å¤ªå¿«å¯¼è‡´ï¼Œè€Œ è®¡ç®—æ¨¡å—æ¯åˆ†é’Ÿç¼“å­˜å¤±æ•ˆæœºåˆ¶ä¼šå¯¼è‡´å¤§é‡çš„ä¸‹æ¸¸è®¿é—®ï¼Œä»è€Œå¼•å…¥æ›´å¤šçš„å¯¹è±¡åˆ†é…ï¼Œä¸¤è€…ç»“åˆäº’ç›¸å°è¯äº†ä¸ºä½•åœ¨æ¯åˆ†é’Ÿå‰ 10s çš„ç¬¬ä¸€æ¬¡ GC å‹åŠ›è¶…ä¹å¯»å¸¸ï¼›

> å…³äº GC è¾…åŠ©æ ‡è®° mark assist ä¸ºäº†ä¿è¯åœ¨Markingè¿‡ç¨‹ä¸­ï¼Œå…¶å®ƒGåˆ†é…å †å†…å­˜å¤ªå¿«ï¼Œå¯¼è‡´Markè·Ÿä¸ä¸ŠAllocateçš„é€Ÿåº¦ï¼Œè¿˜éœ€è¦å…¶å®ƒGé…åˆåšä¸€éƒ¨åˆ†æ ‡è®°çš„å·¥ä½œï¼Œè¿™éƒ¨åˆ†å·¥ä½œå«è¾…åŠ©æ ‡è®°(mutator assists)ã€‚åœ¨MarkingæœŸé—´ï¼Œæ¯æ¬¡Gåˆ†é…å†…å­˜éƒ½ä¼šæ›´æ–°å®ƒçš„â€è´Ÿå€ºæŒ‡æ•°â€(gcAssistBytes)ï¼Œåˆ†é…å¾—è¶Šå¿«ï¼ŒgcAssistBytesè¶Šå¤§ï¼Œè¿™ä¸ªæŒ‡æ•°ä¹˜ä»¥å…¨å±€çš„â€è´Ÿè½½æ±‡ç‡â€(assistWorkPerByte)ï¼Œå°±å¾—åˆ°è¿™ä¸ªGéœ€è¦å¸®å¿™Markingçš„å†…å­˜å¤§å°(è¿™ä¸ªè®¡ç®—è¿‡ç¨‹å«revise)ï¼Œä¹Ÿå°±æ˜¯å®ƒåœ¨æœ¬æ¬¡åˆ†é…çš„mutator assistså·¥ä½œé‡(gcAssistAlloc)ã€‚å¼•ç”¨è‡ªï¼šhttps://wudaijun.com/2020/01/go-gc-keypoint-and-monitor/

**ç¬¬ä¸‰æ­¥ï¼šæŒ‰ç…§åˆ†æç»“è®ºï¼Œè®¾è®¡ä¼˜åŒ–æ“ä½œ**ä»å‡å°‘å¯¹è±¡åˆ†é…æ•°è§’åº¦å‡ºå‘ï¼Œå¯¹ Pprof heap å›¾è¿›è¡Œè§‚å¯Ÿ

- åœ¨ inuse_objects æŒ‡æ ‡ä¸‹ cache åº“å ç”¨æœ€å¤§ï¼›
- åœ¨ alloc_objects æŒ‡æ ‡ä¸‹ json åºåˆ—åŒ–å ç”¨æœ€å¤§ï¼›

ä½†æ— æ³•ç¡®å®šå“ªä¸€ä¸ªæ˜¯çœŸæ­£ä½¿åˆ†é…å†…å­˜å¢å¤§çš„å› ç´ ï¼Œå› æ­¤ç€æ‰‹å¯¹è¿™ä¸¤ç‚¹è¿›è¡Œåˆ†å¼€ä¼˜åŒ–ï¼›

![å›¾ç‰‡](https://mmbiz.qpic.cn/mmbiz_png/YdZzofiato9LJXrEicIt094ztVYzNoAxyAsSicAlsu64icxPhhgSHRc5Nt69x46ETBjdsibFOf8rDrqMNiaYp7icWnCZg/640?wx_fmt=png&tp=webp&wxfrom=5&wx_lazy=1&wx_co=1)![å›¾ç‰‡](https://mmbiz.qpic.cn/mmbiz_png/YdZzofiato9LJXrEicIt094ztVYzNoAxyAsvHiaQVpcgB6MOS29sAvneDfZCkZPjn70ibvicxZ6WicOK7Hsic8Dd9JG6w/640?wx_fmt=png&tp=webp&wxfrom=5&wx_lazy=1&wx_co=1)é€šè¿‡å¯¹ä¸šç•Œå¼€æºçš„ json å’Œ cache åº“è°ƒç ”åï¼ˆè°ƒç ”æŠ¥å‘Šï¼šhttps://segmentfault.com/a/1190000041591284ï¼‰ï¼Œé‡‡ç”¨æ€§èƒ½è¾ƒå¥½ã€ä½åˆ†é…çš„ GJSON å’Œ 0GC çš„ BigCache å¯¹åŸæœ‰åº“è¿›è¡Œæ›¿æ¢ï¼›

  

#### æ•ˆæœ

- æ›´æ¢ JSON åºåˆ—åŒ–åº“ GJSON åº“ä¼˜åŒ–æ— æ•ˆæœï¼›
- æ›´æ¢ Cache åº“ BigCache åº“æ•ˆæœæ˜æ˜¾ï¼Œinuse_objects ç”± 200-300w ä¸‹é™åˆ° 12wï¼Œæ¯›åˆºåŸºæœ¬æ¶ˆå¤±ï¼›
![å›¾ç‰‡](https://mmbiz.qpic.cn/mmbiz_png/YdZzofiato9LJXrEicIt094ztVYzNoAxyAFlXJyibAicX4tmU5R50989VzZG4ZP858obWxdX1cPs55iaRodaYic1icpvg/640?wx_fmt=png&tp=webp&wxfrom=5&wx_lazy=1&wx_co=1)è®¡ç®—æ¨¡å—è€—æ—¶ç»Ÿè®¡å›¾ï¼ˆæµ…è‰²éƒ¨åˆ†ï¼šGJSONï¼Œæ·±è‰²éƒ¨åˆ†ï¼šBigCacheï¼‰
![å›¾ç‰‡](https://mmbiz.qpic.cn/mmbiz_png/YdZzofiato9LJXrEicIt094ztVYzNoAxyAg7Vs67qPAibiciaopHHlQ9ic1dxmp9wE4W32JfbUBHBWfkOOsrUxjSftIQ/640?wx_fmt=png&tp=webp&wxfrom=5&wx_lazy=1&wx_co=1)API æ¨¡å—è¿”å›ä¸Šæ¸¸è€—æ—¶ç»Ÿè®¡å›¾

#### å…³äº Golang GC

åœ¨é€šä¿—æ„ä¹‰ä¸Šå¸¸è®¤ä¸ºï¼ŒGO GC è§¦å‘æ—¶æœºä¸ºå †å¤§å°å¢é•¿ä¸ºä¸Šæ¬¡ GC ä¸¤å€æ—¶ã€‚ä½†åœ¨ GO GC å®é™…å®è·µä¸­ä¼šæŒ‰ç…§ Pacer è°ƒé¢‘ç®—æ³•æ ¹æ®å †å¢é•¿é€Ÿåº¦ã€å¯¹è±¡æ ‡è®°é€Ÿåº¦ç­‰å› ç´ è¿›è¡Œé¢„è®¡ç®—ï¼Œä½¿å †å¤§å°åœ¨è¾¾åˆ°ä¸¤å€å¤§å°å‰æå‰å‘èµ· GCï¼Œæœ€ä½³æƒ…å†µä¸‹ä¼šåªå ç”¨ 25% CPU ä¸”åœ¨å †å¤§å°å¢é•¿ä¸ºä¸¤å€æ—¶ï¼Œåˆšå¥½å®Œæˆ GCã€‚

> å…³äº Pacer è°ƒé¢‘ç®—æ³•ï¼šhttps://golang.design/under-the-hood/zh-cn/part2runtime/ch08gc/pacing/

ä½† Pacer åªèƒ½åœ¨ç¨³æ€æƒ…å†µä¸‹æ§åˆ¶ CPU å ç”¨ä¸º 25%ï¼Œä¸€æ—¦æœåŠ¡å†…éƒ¨æœ‰ç¬æ€æƒ…å†µï¼Œä¾‹å¦‚å®šæ—¶ä»»åŠ¡ã€ç¼“å­˜å¤±æ•ˆç­‰ç­‰ï¼ŒPacer åŸºäºç¨³æ€çš„é¢„åˆ¤å¤±æ•ˆï¼Œå¯¼è‡´ GC æ ‡è®°é€Ÿåº¦å°äºåˆ†é…é€Ÿåº¦ï¼Œä¸ºè¾¾åˆ° GC å›æ”¶ç›®æ ‡ï¼ˆåœ¨å †å¤§å°åˆ°è¾¾ä¸¤å€ä¹‹å‰å®Œæˆ GCï¼‰ï¼Œä¼šå¯¼è‡´å¤§é‡ Goroutine è¢«æ‹›å‹Ÿå»æ‰§è¡Œ Mark Assist æ“ä½œä»¥ååŠ©å›æ”¶å·¥ä½œï¼Œä»è€Œé˜»ç¢åˆ° Goroutine æ­£å¸¸çš„å·¥ä½œæ‰§è¡Œã€‚å› æ­¤ç›®å‰ GO GC çš„ Marking é˜¶æ®µå¯¹è€—æ—¶å½±å“æ—¶æœ€ä¸ºä¸¥é‡çš„ã€‚

> å…³äº gc pacer è°ƒé¢‘å™¨
> 
> ![å›¾ç‰‡](https://mmbiz.qpic.cn/mmbiz_png/YdZzofiato9LJXrEicIt094ztVYzNoAxyAIbPjxRwicIYQhClpEIB8ovHnEiave2YCgiaQqYdvgldTt6Gb7BjVUicnpA/640?wx_fmt=png&tp=webp&wxfrom=5&wx_lazy=1&wx_co=1)å¼•ç”¨è‡ªï¼šhttps://go.googlesource.com/proposal/+/a216b56e743c5b6b300b3ef1673ee62684b5b63b/design/44167-gc-pacer-redesign.md
> 
>   

## æœ€ç»ˆæ•ˆæœ

API æ¨¡å— P99 è€—æ—¶ä» 20-50ms é™ä½è‡³ 6msï¼Œè®¿é—®é”™è¯¯ç‡ä» 1â€° é™ä½åˆ° 1â€±ã€‚

![å›¾ç‰‡](https://mmbiz.qpic.cn/mmbiz_png/YdZzofiato9LJXrEicIt094ztVYzNoAxyAtx8SG3Yfce1LbAWZePfRCNiam9Hwvhwu8njibTRUY3SAVB3oWWbydSwQ/640?wx_fmt=png&tp=webp&wxfrom=5&wx_lazy=1&wx_co=1)API è¿”å›ä¸Šæ¸¸æœåŠ¡è€—æ—¶ç»Ÿè®¡å›¾

  

## æ€»ç»“

1. å½“åˆ†æè€—æ—¶é—®é¢˜æ—¶ï¼Œè§‚å¯Ÿç›‘æ§æˆ–æ—¥å¿—åï¼Œå¯èƒ½ä¼šå‘ç°è¶‹åŠ¿å®Œå…¨åŒ¹é…çš„ä¸¤ç§æŒ‡æ ‡ï¼Œè¯¯ä»¥ä¸ºæ˜¯å› æœå…³ç³»ï¼Œä½†å´æœ‰å¯èƒ½è¿™ä¸¤è€…éƒ½æ˜¯å¤–éƒ¨è¡¨ç°ï¼Œå…±åŒå—åˆ°**ç¬¬ä¸‰å˜é‡çš„å½±å“ï¼Œç›¸å…³ä½†ä¸æ˜¯å› æœ**ï¼›
    
2. ç›¸å¯¹äºç™¾æ¯«ç§’è€—æ—¶æœåŠ¡ï¼Œä½å»¶æ—¶æœåŠ¡çš„è€—æ—¶ä¼šè¾ƒå¤§ç¨‹åº¦ä¸Šå—åˆ°Â **CPU ä½¿ç”¨ç‡**çš„å½±å“ï¼Œåœ¨åšæ€§èƒ½ä¼˜åŒ–æ—¶åˆ‡å‹¿å¿½è§†è¿™ç‚¹ï¼›ï¼ˆçº¿ç¨‹æ’é˜Ÿã€è°ƒåº¦æŸè€—ã€èµ„æºç«äº‰ç­‰ï¼‰
    
3. å¯¹äºé«˜å¹¶å‘ã€ä½å»¶æ—¶æœåŠ¡ï¼Œè€—æ—¶æ–¹é¢å—åˆ°ä¸‹æ¸¸çš„å½±å“å¯èƒ½åªæ˜¯ä¸€ä¸ªæ–¹é¢ï¼ŒæœåŠ¡**è‡ªèº«å¼€é”€**å¦‚åºåˆ—åŒ–ã€GC ç­‰éƒ½å¯èƒ½ä¼šè¾ƒå¤§ç¨‹åº¦ä¸Šå½±å“åˆ°æœåŠ¡è€—æ—¶ï¼›
    
4. æ€§èƒ½ä¼˜åŒ–å› ä»**æé«˜å¯è§‚æµ‹æ€§**å…¥æ‰‹ï¼Œå¦‚é“¾è·¯è¿½è¸ªã€æ ‡å‡†åŒ–çš„ Metricã€go pprof å·¥å…·ç­‰ç­‰ï¼Œæ‰“å¥½æ’æŸ¥åŸºç¡€ï¼ŒåŸºäºå¤šæ–¹å¯é æ•°æ®è¿›è¡Œåˆ†æä¸çŒœæµ‹ï¼Œæœ€åç€æ‰‹è¿›è¡Œä¼˜åŒ–ã€éªŒè¯ï¼Œé¿å…ç›²äººæ‘¸è±¡ä¼¼çš„æ“ä½œï¼Œå¦„å›¾é€šè¿‡ç¢°è¿æ°”çš„æ–¹å¼è§£å†³é—®é¢˜ï¼›
    
5. äº†è§£ä¸€äº›ç®€å•çš„**å»ºæ¨¡çŸ¥è¯†**å¯¹è€—æ—¶ä¼˜åŒ–çš„åˆ†æä¸çŒœæµ‹é˜¶æ®µä¼šæœ‰ä¸é”™çš„å¸®åŠ©ï¼›
    
6. **ç†è®ºç»“åˆå®é™…é—®é¢˜**è¿›è¡Œæ€è€ƒï¼›å¤šçœ‹æ–‡ç« ã€å‚ä¸åˆ†äº«ã€è¿›è¡Œäº¤æµï¼Œäº†è§£æ›´å¤šæŠ€æœ¯ï¼Œæ‰©å±•è§†é‡ï¼›æ¯ä¸€æ¬¡çš„è®¨è®ºå’Œè´¨ç–‘éƒ½æ˜¯è¿›ä¸€æ­¥æ·±å…¥æ€è€ƒçš„æœºä¼šï¼Œä»¥ä¸Šå¤šé¡¹ä¼˜åŒ–éƒ½å‡ºè‡ªä¸å¤§ä½¬ï¼ˆç‰¹åˆ«é¸£è°¢ @æå¿ƒå®‡@åˆ˜ç¦@é¾šå‹‹ï¼‰çš„è®¨è®ºåçš„å®è·µï¼›
    
7. åŒä¸ºæ€§èƒ½ä¼˜åŒ–ï¼Œè€—æ—¶ä¼˜åŒ–ä¸åŒäº CPUã€å†…å­˜ç­‰èµ„æºä¼˜åŒ–ï¼Œæ›´åŠ å¤æ‚ï¼Œéš¾åº¦è¾ƒé«˜ï¼Œåœ¨åšèµ„æºä¼˜åŒ–æ—¶ Go è¯­è¨€è‡ªå¸¦äº†æ–¹ä¾¿æ˜“ç”¨çš„ PProf å·¥å…·ï¼Œå¯ä»¥æä¾›å¾ˆå¤§çš„å¸®åŠ©ï¼Œä½†è€—æ—¶ä¼˜åŒ–å°¤å…¶æ˜¯é•¿å°¾é—®é¢˜çš„ä¼˜åŒ–éå¸¸è‰°éš¾ï¼Œå› æ­¤åœ¨è¿›è¡Œä¼˜åŒ–çš„è¿‡ç¨‹ä¸­ä¸€å®šè¦ç¨³ä½å¿ƒæ€ã€è€å¿ƒè§‚å¯Ÿï¼Œ**è¡Œç™¾é‡Œè€…åŠä¹å**ã€‚
    
8. å…³æ³¨è¯·æ±‚ä¹‹é—´**å…±äº«èµ„æº**çš„äº‰ç”¨å¯¼è‡´çš„è€—æ—¶é—®é¢˜ï¼Œä¸ä»…é™äºä¸‹æ¸¸æœåŠ¡ï¼ŒæœåŠ¡è‡ªèº«çš„ CPUã€å†…å­˜ï¼ˆå¼•å‘ GCï¼‰ç­‰ä¹Ÿæ˜¯å…±äº«èµ„æºçš„ä¸€éƒ¨åˆ†ï¼›
    


# Reference
https://mp.weixin.qq.com/s/aIKNqQAaI37iJPEEi9z8YQ
https://mp.weixin.qq.com/s/83M0j8lIALdF-eOdD5GukA