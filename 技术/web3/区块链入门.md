
![[Pasted image 20240801210336.png]]
## 

前言

区块链作为 Web3 生态的核心基础设施，相当于一个分布式数据库，用于存储全球范围内的交易数据、智能合约、用户身份信息和各种类型的去中心化应用（ dApps ）数据。

以太坊区块链从上往下可以依次分解为：区块链、区块、交易三个层次，其中的交易数据、收据数据、状态数据和账户数据都分别存储在四棵默克尔树中。如果你是第一次接触这些概念，不用担心。在这个章节，我们将以以太坊为例，为你逐层解析区块链的数据结构。

## 

 区块链

区块链是一系列数据块（即“区块”），通过特定的方式相互连接，形成的一条链。每个区块都包含前一个区块的哈希值，称为“父哈希值”（ Parent Hash ），这是前一个区块内容的唯一标识符。通过这种方式，每个区块都与前一个区块相连接，形成了一条从第一个区块（创世区块）到最新区块的连续链条，这就是“区块链”。注：第一个区块里无父哈希值。

![image](https://hackquest-s3-prod-apne1.s3.ap-northeast-1.amazonaws.com/courses/1c7557b1-2dbc-4092-9ea2-a0c349e6f17c/7e6fb65c-bfd2-474c-88e0-6102272a34f5/9dc8af1a-8e5b-4fe8-8536-e9d28974ab07/edd65023-a1ae-4edd-8a12-e3668e937361.webp?X-Amz-Algorithm=AWS4-HMAC-SHA256&X-Amz-Content-Sha256=UNSIGNED-PAYLOAD&X-Amz-Credential=ASIAYCTGVDAPGS3I246A%2F20240731%2Fap-northeast-1%2Fs3%2Faws4_request&X-Amz-Date=20240731T113418Z&X-Amz-Expires=3600&X-Amz-Security-Token=IQoJb3JpZ2luX2VjEHEaDmFwLW5vcnRoZWFzdC0xIkcwRQIhAMKVgh8fbJ2Ufs7cy1eIlajjLldUx7UR3X6h3Q2HelC2AiAWTUC4c3ChamtdUXK6nk%2BUQgjHysUVobQWu9qMAf%2FlqCqeBAhbEAEaDDU1NTMzOTgxNDk0MiIMRqbARxX24dr4XLDKKvsDxYupgs%2BYWKr%2FLQ3ixMy95eAXsA5IGVS0G%2BD%2B9AHByln0WzPc31ciYhlYr3hUuII632MT0iGUwt7bgojfvR3uFnivP2omPUbXtgU62i5R1kYfV5NMnNpCPnyi%2FoH7XO6p8UfyjRrAaMkGdHd5TiCcGZwyLyNlLRgjabCizvINaXMQeQmVzTKwxv0bKGz1cUeaRWP6JBUj8wYD4HkeL4jRbdHci1nx8ZfAl5aauu%2FT5nOLvbVV8Jz4NyME9dK5Stt2XtA4cqceLaM%2BGzbajUTiQvv6Uf60ORdq1Jxi0%2FzfAFbw27UCXatC9UM84T4MF4KW3GFkQuKBR1bQL3UX4%2B5ZVljqwo0j467kK9f%2BNWbNY3lPOVNzT%2F3fUwvdy%2FVhG3JmMHP18Jofju5yG1LKcbDtNgVOcmuZuwAoWw399n59t8gqZ1GoM4E%2BW5phGs5IVFokR%2BAnbqPgnAwS2gmIL72CEzgTXAhUYSxnf6PW%2FhOVSTmgRju8ATJ6ZEZAw71x9cY7W%2FdO1PyXNsMSuhL%2FC9CpuVem3drD3JNz7qwWJ1%2BdpnMPp7KQ0Y182Af4Q29jqN0gtHvpqLTXtmYUng%2BeX7u86enXVelRiyEzn55Yqhecret4vy0xf7%2FBdGKu2q7TO3cnKFl%2FpWho%2BlalPHahuJxrZK0DzAkAIRPeOscbMJGJqLUGOqYBSVDqshSIi%2FdQ6uCeAQyg5NkrF8Wo0XL7uFmH57fUxjDD5rynY6d5SbNSi%2B1qjgt9NTB8ckqapqKnP8XrpWh%2BjwXwfYlWuMrDYRerdkjRXLuRWAnpE%2BkrTdmLO8zGlspCyrkSs8PdLW3XdTH6DfH5%2FiMsBmo0IySUl8VpCnPkrWpKv8F%2F9jKX%2FdD%2Fp%2F%2B7viekEQXU8jaH9ttxT%2BQvQPEr6uIT0g41Ng%3D%3D&X-Amz-Signature=cfd222947e611b7fb344848b371eff7c524da4566b221563010120e261ff8b7e&X-Amz-SignedHeaders=host&x-id=GetObject)

Preview

## 

 区块

区块链中的每一个区块，都由两个部分组成：区块头（ Header ）和区块体（ Body ）。

①区块头

区块头里包含了一个区块的基本信息，主要包括：

●父哈希值（ parentHash ）：记录前一个区块的哈希值。

●时间戳（ timestamp ）：记录区块创建的具体时间。

●随机数（ nonce ）：用于工作量证明（ PoW ）机制中的挖矿过程。

●难度目标（ difficulty ）：表示挖矿的难度。

●币基（ coinBase ）：标识矿工的账户地址。

另外，区块头里还记录了三个非常重要的根哈希值：

●状态树根（ stateRoot ）：表示了区块链的状态树的根哈希值，状态树记录了所有账户的状态信息，如余额、合约代码等。

●收据树根（ receiptRoot ）：表示收据树的根哈希值，收据树记录了交易执行的结果，如交易是否成功、交易费用等。

●交易树根（ transactionRoot ）：表示交易树的根哈希值，交易树包含了区块中所有交易的信息。

②区块体

区块体里存储了该区块中的所有交易数据，即所有交易哈希的列表。

![image](https://hackquest-s3-prod-apne1.s3.ap-northeast-1.amazonaws.com/courses/1c7557b1-2dbc-4092-9ea2-a0c349e6f17c/7e6fb65c-bfd2-474c-88e0-6102272a34f5/9dc8af1a-8e5b-4fe8-8536-e9d28974ab07/3e9e4b1a-c1f0-42bd-82cb-9f82f28c446d.webp?X-Amz-Algorithm=AWS4-HMAC-SHA256&X-Amz-Content-Sha256=UNSIGNED-PAYLOAD&X-Amz-Credential=ASIAYCTGVDAPGS3I246A%2F20240731%2Fap-northeast-1%2Fs3%2Faws4_request&X-Amz-Date=20240731T113418Z&X-Amz-Expires=3600&X-Amz-Security-Token=IQoJb3JpZ2luX2VjEHEaDmFwLW5vcnRoZWFzdC0xIkcwRQIhAMKVgh8fbJ2Ufs7cy1eIlajjLldUx7UR3X6h3Q2HelC2AiAWTUC4c3ChamtdUXK6nk%2BUQgjHysUVobQWu9qMAf%2FlqCqeBAhbEAEaDDU1NTMzOTgxNDk0MiIMRqbARxX24dr4XLDKKvsDxYupgs%2BYWKr%2FLQ3ixMy95eAXsA5IGVS0G%2BD%2B9AHByln0WzPc31ciYhlYr3hUuII632MT0iGUwt7bgojfvR3uFnivP2omPUbXtgU62i5R1kYfV5NMnNpCPnyi%2FoH7XO6p8UfyjRrAaMkGdHd5TiCcGZwyLyNlLRgjabCizvINaXMQeQmVzTKwxv0bKGz1cUeaRWP6JBUj8wYD4HkeL4jRbdHci1nx8ZfAl5aauu%2FT5nOLvbVV8Jz4NyME9dK5Stt2XtA4cqceLaM%2BGzbajUTiQvv6Uf60ORdq1Jxi0%2FzfAFbw27UCXatC9UM84T4MF4KW3GFkQuKBR1bQL3UX4%2B5ZVljqwo0j467kK9f%2BNWbNY3lPOVNzT%2F3fUwvdy%2FVhG3JmMHP18Jofju5yG1LKcbDtNgVOcmuZuwAoWw399n59t8gqZ1GoM4E%2BW5phGs5IVFokR%2BAnbqPgnAwS2gmIL72CEzgTXAhUYSxnf6PW%2FhOVSTmgRju8ATJ6ZEZAw71x9cY7W%2FdO1PyXNsMSuhL%2FC9CpuVem3drD3JNz7qwWJ1%2BdpnMPp7KQ0Y182Af4Q29jqN0gtHvpqLTXtmYUng%2BeX7u86enXVelRiyEzn55Yqhecret4vy0xf7%2FBdGKu2q7TO3cnKFl%2FpWho%2BlalPHahuJxrZK0DzAkAIRPeOscbMJGJqLUGOqYBSVDqshSIi%2FdQ6uCeAQyg5NkrF8Wo0XL7uFmH57fUxjDD5rynY6d5SbNSi%2B1qjgt9NTB8ckqapqKnP8XrpWh%2BjwXwfYlWuMrDYRerdkjRXLuRWAnpE%2BkrTdmLO8zGlspCyrkSs8PdLW3XdTH6DfH5%2FiMsBmo0IySUl8VpCnPkrWpKv8F%2F9jKX%2FdD%2Fp%2F%2B7viekEQXU8jaH9ttxT%2BQvQPEr6uIT0g41Ng%3D%3D&X-Amz-Signature=f9a34fa43b18848e7d308e82a9af96f82389de640590d6d310cccbf0c0135ff8&X-Amz-SignedHeaders=host&x-id=GetObject)

Preview

## 

 交易

在以太坊中，交易代表从一个账户向另一个账户发送资产或消息的行为。当用户发起一笔交易时，以太坊客户端或钱包软件将会构造交易数据。交易数据主要包含如下字段：

●nonce：发送方账户的交易计数器，统计该账户在此区块链中的总交易次数。

●gasPrice：发送方愿意为每单位 gas 支付的价格。

●gasLimit：发送方为这次交易设置的最大 gas 消耗量。

●to：接收方的账户地址。

●value：要传输的以太币数量。

●data：智能合约相关的字节码。

●v, r, s：交易签名，由发送方的私钥生成。

交易数据构造完成后，钱包将使用用户的私钥对整个交易进行签名，并将签名结果（ v, r, s ）加入交易数据中，然后对整个交易数据（不包括签名）计算哈希值，交易哈希是交易数据的唯一标识符，确保了交易的唯一性和不可篡改。

![image](https://hackquest-s3-prod-apne1.s3.ap-northeast-1.amazonaws.com/courses/1c7557b1-2dbc-4092-9ea2-a0c349e6f17c/7e6fb65c-bfd2-474c-88e0-6102272a34f5/9dc8af1a-8e5b-4fe8-8536-e9d28974ab07/42cc8156-951b-47ce-8a51-a728ef81d12c.webp?X-Amz-Algorithm=AWS4-HMAC-SHA256&X-Amz-Content-Sha256=UNSIGNED-PAYLOAD&X-Amz-Credential=ASIAYCTGVDAPGS3I246A%2F20240731%2Fap-northeast-1%2Fs3%2Faws4_request&X-Amz-Date=20240731T113418Z&X-Amz-Expires=3600&X-Amz-Security-Token=IQoJb3JpZ2luX2VjEHEaDmFwLW5vcnRoZWFzdC0xIkcwRQIhAMKVgh8fbJ2Ufs7cy1eIlajjLldUx7UR3X6h3Q2HelC2AiAWTUC4c3ChamtdUXK6nk%2BUQgjHysUVobQWu9qMAf%2FlqCqeBAhbEAEaDDU1NTMzOTgxNDk0MiIMRqbARxX24dr4XLDKKvsDxYupgs%2BYWKr%2FLQ3ixMy95eAXsA5IGVS0G%2BD%2B9AHByln0WzPc31ciYhlYr3hUuII632MT0iGUwt7bgojfvR3uFnivP2omPUbXtgU62i5R1kYfV5NMnNpCPnyi%2FoH7XO6p8UfyjRrAaMkGdHd5TiCcGZwyLyNlLRgjabCizvINaXMQeQmVzTKwxv0bKGz1cUeaRWP6JBUj8wYD4HkeL4jRbdHci1nx8ZfAl5aauu%2FT5nOLvbVV8Jz4NyME9dK5Stt2XtA4cqceLaM%2BGzbajUTiQvv6Uf60ORdq1Jxi0%2FzfAFbw27UCXatC9UM84T4MF4KW3GFkQuKBR1bQL3UX4%2B5ZVljqwo0j467kK9f%2BNWbNY3lPOVNzT%2F3fUwvdy%2FVhG3JmMHP18Jofju5yG1LKcbDtNgVOcmuZuwAoWw399n59t8gqZ1GoM4E%2BW5phGs5IVFokR%2BAnbqPgnAwS2gmIL72CEzgTXAhUYSxnf6PW%2FhOVSTmgRju8ATJ6ZEZAw71x9cY7W%2FdO1PyXNsMSuhL%2FC9CpuVem3drD3JNz7qwWJ1%2BdpnMPp7KQ0Y182Af4Q29jqN0gtHvpqLTXtmYUng%2BeX7u86enXVelRiyEzn55Yqhecret4vy0xf7%2FBdGKu2q7TO3cnKFl%2FpWho%2BlalPHahuJxrZK0DzAkAIRPeOscbMJGJqLUGOqYBSVDqshSIi%2FdQ6uCeAQyg5NkrF8Wo0XL7uFmH57fUxjDD5rynY6d5SbNSi%2B1qjgt9NTB8ckqapqKnP8XrpWh%2BjwXwfYlWuMrDYRerdkjRXLuRWAnpE%2BkrTdmLO8zGlspCyrkSs8PdLW3XdTH6DfH5%2FiMsBmo0IySUl8VpCnPkrWpKv8F%2F9jKX%2FdD%2Fp%2F%2B7viekEQXU8jaH9ttxT%2BQvQPEr6uIT0g41Ng%3D%3D&X-Amz-Signature=fab27911a8a5cfe6a979b078bc110066c8ecf4b009659a1c492612b2769c4508&X-Amz-SignedHeaders=host&x-id=GetObject)

Preview

例如，Alice 想要发送 1 ETH 给 Bob，Alice 的账户地址是 0x123…ABC，Bob 的账户地址是 0x456…DEF。Alice 的账户已经执行过5笔交易，所以她的下一笔交易的 nonce 为6。当前的 gas 价格是 20 Gwei，她设置的 gas limit 是21000（标准以太坊转账所需的gas费）。Alice 不调用任何合约，所以 data 字段为空。

●nonce: 6

●gasPrice: 20000000000 (20 Gwei)

●gasLimit: 21000

●to: 0x456…DEF

●value: 1000000000000000000 (1 ETH)

●data: 0x

●v, r, s: [签名数据]

Alice 的钱包会把这些交易数据进行打包和签名，然后生成交易哈希，并将这个交易广播到以太坊网络。矿工将确认这笔交易并将其加入新区块，一旦成功，1 ETH 就会从 Alice 的账户转移到 Bob 的账户。

## 

 交易收据

在以太坊中，当一笔交易完成后，会生成“交易收据”（ Transaction Receipt，又叫交易回执）。交易收据记录了交易执行的基本信息，是交易被包含在区块链中的重要证据。

![image](https://hackquest-s3-prod-apne1.s3.ap-northeast-1.amazonaws.com/courses/1c7557b1-2dbc-4092-9ea2-a0c349e6f17c/7e6fb65c-bfd2-474c-88e0-6102272a34f5/9dc8af1a-8e5b-4fe8-8536-e9d28974ab07/4f5f0e2a-28b3-4b47-b368-fcb238dfdcfc.webp?X-Amz-Algorithm=AWS4-HMAC-SHA256&X-Amz-Content-Sha256=UNSIGNED-PAYLOAD&X-Amz-Credential=ASIAYCTGVDAPGS3I246A%2F20240731%2Fap-northeast-1%2Fs3%2Faws4_request&X-Amz-Date=20240731T113418Z&X-Amz-Expires=3600&X-Amz-Security-Token=IQoJb3JpZ2luX2VjEHEaDmFwLW5vcnRoZWFzdC0xIkcwRQIhAMKVgh8fbJ2Ufs7cy1eIlajjLldUx7UR3X6h3Q2HelC2AiAWTUC4c3ChamtdUXK6nk%2BUQgjHysUVobQWu9qMAf%2FlqCqeBAhbEAEaDDU1NTMzOTgxNDk0MiIMRqbARxX24dr4XLDKKvsDxYupgs%2BYWKr%2FLQ3ixMy95eAXsA5IGVS0G%2BD%2B9AHByln0WzPc31ciYhlYr3hUuII632MT0iGUwt7bgojfvR3uFnivP2omPUbXtgU62i5R1kYfV5NMnNpCPnyi%2FoH7XO6p8UfyjRrAaMkGdHd5TiCcGZwyLyNlLRgjabCizvINaXMQeQmVzTKwxv0bKGz1cUeaRWP6JBUj8wYD4HkeL4jRbdHci1nx8ZfAl5aauu%2FT5nOLvbVV8Jz4NyME9dK5Stt2XtA4cqceLaM%2BGzbajUTiQvv6Uf60ORdq1Jxi0%2FzfAFbw27UCXatC9UM84T4MF4KW3GFkQuKBR1bQL3UX4%2B5ZVljqwo0j467kK9f%2BNWbNY3lPOVNzT%2F3fUwvdy%2FVhG3JmMHP18Jofju5yG1LKcbDtNgVOcmuZuwAoWw399n59t8gqZ1GoM4E%2BW5phGs5IVFokR%2BAnbqPgnAwS2gmIL72CEzgTXAhUYSxnf6PW%2FhOVSTmgRju8ATJ6ZEZAw71x9cY7W%2FdO1PyXNsMSuhL%2FC9CpuVem3drD3JNz7qwWJ1%2BdpnMPp7KQ0Y182Af4Q29jqN0gtHvpqLTXtmYUng%2BeX7u86enXVelRiyEzn55Yqhecret4vy0xf7%2FBdGKu2q7TO3cnKFl%2FpWho%2BlalPHahuJxrZK0DzAkAIRPeOscbMJGJqLUGOqYBSVDqshSIi%2FdQ6uCeAQyg5NkrF8Wo0XL7uFmH57fUxjDD5rynY6d5SbNSi%2B1qjgt9NTB8ckqapqKnP8XrpWh%2BjwXwfYlWuMrDYRerdkjRXLuRWAnpE%2BkrTdmLO8zGlspCyrkSs8PdLW3XdTH6DfH5%2FiMsBmo0IySUl8VpCnPkrWpKv8F%2F9jKX%2FdD%2Fp%2F%2B7viekEQXU8jaH9ttxT%2BQvQPEr6uIT0g41Ng%3D%3D&X-Amz-Signature=6e9237798bce76c5f870e7a3a852905bc3198331d910aeda640aa5fe07492d57&X-Amz-SignedHeaders=host&x-id=GetObject)

Preview

每个交易收据包含的信息有：

●transactionHash：交易哈希值，用于唯一标识一笔交易。

●transactionIndex：交易在所在区块中的索引位置。

●blockHash：包含该交易的区块哈希值。

●blockNumber：包含该交易的区块编号。

●from：发起交易的地址。

●to：交易的目标地址。

●cumulativeGasUsed：当前区块中累积消耗的 Gas 量。

●gasUsed：这笔交易所消耗的 Gas 量。

●contractAddress：如果交易用于创建合约，则表示合约地址；否则为 null。

●logs：交易过程中产生的事件日志。

●logsBloom：布隆过滤器，用于快速检索交易日志。

●status：交易执行的状态码，表示成功或失败。

## 

 默克尔-帕特里夏树 Merkle Patricia Tree

以太坊每天的交易量达到数百万笔，如此多的交易数据是如何存储的呢？这里采用了一种名为Merkle Patricia Tree（ MPT ）的数据结构，这是一种特殊类型的默克尔树（ Merkle Tree ）。我们先了解一下基本的默克尔树。

①默克尔树，也称为哈希树（ Hash Tree ），这棵树的叶子节点是数据块的哈希值，非叶子节点是其子节点的哈希值串联后再次进行哈希计算的结果，这样可以确保数据的完整性。如图所示，节点值的计算方法为：

哈希 A=Hash (数据 A );

哈希 B=Hash (数据 B );

哈希 E=Hash (哈希 A+哈希 B );

![image](https://hackquest-s3-prod-apne1.s3.ap-northeast-1.amazonaws.com/courses/1c7557b1-2dbc-4092-9ea2-a0c349e6f17c/7e6fb65c-bfd2-474c-88e0-6102272a34f5/9dc8af1a-8e5b-4fe8-8536-e9d28974ab07/76b00fa1-ed61-4e22-9d39-cf198c89ea46.webp?X-Amz-Algorithm=AWS4-HMAC-SHA256&X-Amz-Content-Sha256=UNSIGNED-PAYLOAD&X-Amz-Credential=ASIAYCTGVDAPGS3I246A%2F20240731%2Fap-northeast-1%2Fs3%2Faws4_request&X-Amz-Date=20240731T113418Z&X-Amz-Expires=3600&X-Amz-Security-Token=IQoJb3JpZ2luX2VjEHEaDmFwLW5vcnRoZWFzdC0xIkcwRQIhAMKVgh8fbJ2Ufs7cy1eIlajjLldUx7UR3X6h3Q2HelC2AiAWTUC4c3ChamtdUXK6nk%2BUQgjHysUVobQWu9qMAf%2FlqCqeBAhbEAEaDDU1NTMzOTgxNDk0MiIMRqbARxX24dr4XLDKKvsDxYupgs%2BYWKr%2FLQ3ixMy95eAXsA5IGVS0G%2BD%2B9AHByln0WzPc31ciYhlYr3hUuII632MT0iGUwt7bgojfvR3uFnivP2omPUbXtgU62i5R1kYfV5NMnNpCPnyi%2FoH7XO6p8UfyjRrAaMkGdHd5TiCcGZwyLyNlLRgjabCizvINaXMQeQmVzTKwxv0bKGz1cUeaRWP6JBUj8wYD4HkeL4jRbdHci1nx8ZfAl5aauu%2FT5nOLvbVV8Jz4NyME9dK5Stt2XtA4cqceLaM%2BGzbajUTiQvv6Uf60ORdq1Jxi0%2FzfAFbw27UCXatC9UM84T4MF4KW3GFkQuKBR1bQL3UX4%2B5ZVljqwo0j467kK9f%2BNWbNY3lPOVNzT%2F3fUwvdy%2FVhG3JmMHP18Jofju5yG1LKcbDtNgVOcmuZuwAoWw399n59t8gqZ1GoM4E%2BW5phGs5IVFokR%2BAnbqPgnAwS2gmIL72CEzgTXAhUYSxnf6PW%2FhOVSTmgRju8ATJ6ZEZAw71x9cY7W%2FdO1PyXNsMSuhL%2FC9CpuVem3drD3JNz7qwWJ1%2BdpnMPp7KQ0Y182Af4Q29jqN0gtHvpqLTXtmYUng%2BeX7u86enXVelRiyEzn55Yqhecret4vy0xf7%2FBdGKu2q7TO3cnKFl%2FpWho%2BlalPHahuJxrZK0DzAkAIRPeOscbMJGJqLUGOqYBSVDqshSIi%2FdQ6uCeAQyg5NkrF8Wo0XL7uFmH57fUxjDD5rynY6d5SbNSi%2B1qjgt9NTB8ckqapqKnP8XrpWh%2BjwXwfYlWuMrDYRerdkjRXLuRWAnpE%2BkrTdmLO8zGlspCyrkSs8PdLW3XdTH6DfH5%2FiMsBmo0IySUl8VpCnPkrWpKv8F%2F9jKX%2FdD%2Fp%2F%2B7viekEQXU8jaH9ttxT%2BQvQPEr6uIT0g41Ng%3D%3D&X-Amz-Signature=7f88d290178b4f4b825effbfdc8acc5410b42500c1d7f5425b1fea4bd65881c2&X-Amz-SignedHeaders=host&x-id=GetObject)

Preview

②帕特里夏树（ Patricia Trie ），也称为压缩前缀树，这棵树既可以利用字符串的公共前缀来减少查询时间，又可以通过压缩无分支的节点来节省空间。

![image](https://hackquest-s3-prod-apne1.s3.ap-northeast-1.amazonaws.com/courses/1c7557b1-2dbc-4092-9ea2-a0c349e6f17c/7e6fb65c-bfd2-474c-88e0-6102272a34f5/9dc8af1a-8e5b-4fe8-8536-e9d28974ab07/0a821b29-5a9d-4ae5-b1d5-0e7bfc61eccb.webp?X-Amz-Algorithm=AWS4-HMAC-SHA256&X-Amz-Content-Sha256=UNSIGNED-PAYLOAD&X-Amz-Credential=ASIAYCTGVDAPGS3I246A%2F20240731%2Fap-northeast-1%2Fs3%2Faws4_request&X-Amz-Date=20240731T113418Z&X-Amz-Expires=3600&X-Amz-Security-Token=IQoJb3JpZ2luX2VjEHEaDmFwLW5vcnRoZWFzdC0xIkcwRQIhAMKVgh8fbJ2Ufs7cy1eIlajjLldUx7UR3X6h3Q2HelC2AiAWTUC4c3ChamtdUXK6nk%2BUQgjHysUVobQWu9qMAf%2FlqCqeBAhbEAEaDDU1NTMzOTgxNDk0MiIMRqbARxX24dr4XLDKKvsDxYupgs%2BYWKr%2FLQ3ixMy95eAXsA5IGVS0G%2BD%2B9AHByln0WzPc31ciYhlYr3hUuII632MT0iGUwt7bgojfvR3uFnivP2omPUbXtgU62i5R1kYfV5NMnNpCPnyi%2FoH7XO6p8UfyjRrAaMkGdHd5TiCcGZwyLyNlLRgjabCizvINaXMQeQmVzTKwxv0bKGz1cUeaRWP6JBUj8wYD4HkeL4jRbdHci1nx8ZfAl5aauu%2FT5nOLvbVV8Jz4NyME9dK5Stt2XtA4cqceLaM%2BGzbajUTiQvv6Uf60ORdq1Jxi0%2FzfAFbw27UCXatC9UM84T4MF4KW3GFkQuKBR1bQL3UX4%2B5ZVljqwo0j467kK9f%2BNWbNY3lPOVNzT%2F3fUwvdy%2FVhG3JmMHP18Jofju5yG1LKcbDtNgVOcmuZuwAoWw399n59t8gqZ1GoM4E%2BW5phGs5IVFokR%2BAnbqPgnAwS2gmIL72CEzgTXAhUYSxnf6PW%2FhOVSTmgRju8ATJ6ZEZAw71x9cY7W%2FdO1PyXNsMSuhL%2FC9CpuVem3drD3JNz7qwWJ1%2BdpnMPp7KQ0Y182Af4Q29jqN0gtHvpqLTXtmYUng%2BeX7u86enXVelRiyEzn55Yqhecret4vy0xf7%2FBdGKu2q7TO3cnKFl%2FpWho%2BlalPHahuJxrZK0DzAkAIRPeOscbMJGJqLUGOqYBSVDqshSIi%2FdQ6uCeAQyg5NkrF8Wo0XL7uFmH57fUxjDD5rynY6d5SbNSi%2B1qjgt9NTB8ckqapqKnP8XrpWh%2BjwXwfYlWuMrDYRerdkjRXLuRWAnpE%2BkrTdmLO8zGlspCyrkSs8PdLW3XdTH6DfH5%2FiMsBmo0IySUl8VpCnPkrWpKv8F%2F9jKX%2FdD%2Fp%2F%2B7viekEQXU8jaH9ttxT%2BQvQPEr6uIT0g41Ng%3D%3D&X-Amz-Signature=1a59f39c357f5e7161d520446ab6d5bed63822ab5de47a609073dd400edeca9b&X-Amz-SignedHeaders=host&x-id=GetObject)

Preview

③默克尔-帕特里夏树 （ Merkle Patricia Tree ） 结合了默克尔树（ Merkle Tree ）和帕特里夏树（ Patricia Trie ）的优点，既可以验证数据的完整性，也可以快速检索状态信息，非常适合用作以太坊中的数据存储。在每个区块里，分别有一棵默克尔-帕特里夏树来存储交易数据、收据数据、状态数据和账户数据。

## 

 小结

这一小节，我们对以太坊区块链的数据结构有了一个基本了解，可以用下面一张图来总结，它是一种高度复杂且精妙的设计，它整个系统能够安全地记录和验证交易，同时保证了网络的去中心化特性。

![image](https://hackquest-s3-prod-apne1.s3.ap-northeast-1.amazonaws.com/courses/1c7557b1-2dbc-4092-9ea2-a0c349e6f17c/7e6fb65c-bfd2-474c-88e0-6102272a34f5/9dc8af1a-8e5b-4fe8-8536-e9d28974ab07/2c2a1437-7049-41cf-86e4-00091825d9c0.webp?X-Amz-Algorithm=AWS4-HMAC-SHA256&X-Amz-Content-Sha256=UNSIGNED-PAYLOAD&X-Amz-Credential=ASIAYCTGVDAPGS3I246A%2F20240731%2Fap-northeast-1%2Fs3%2Faws4_request&X-Amz-Date=20240731T113418Z&X-Amz-Expires=3600&X-Amz-Security-Token=IQoJb3JpZ2luX2VjEHEaDmFwLW5vcnRoZWFzdC0xIkcwRQIhAMKVgh8fbJ2Ufs7cy1eIlajjLldUx7UR3X6h3Q2HelC2AiAWTUC4c3ChamtdUXK6nk%2BUQgjHysUVobQWu9qMAf%2FlqCqeBAhbEAEaDDU1NTMzOTgxNDk0MiIMRqbARxX24dr4XLDKKvsDxYupgs%2BYWKr%2FLQ3ixMy95eAXsA5IGVS0G%2BD%2B9AHByln0WzPc31ciYhlYr3hUuII632MT0iGUwt7bgojfvR3uFnivP2omPUbXtgU62i5R1kYfV5NMnNpCPnyi%2FoH7XO6p8UfyjRrAaMkGdHd5TiCcGZwyLyNlLRgjabCizvINaXMQeQmVzTKwxv0bKGz1cUeaRWP6JBUj8wYD4HkeL4jRbdHci1nx8ZfAl5aauu%2FT5nOLvbVV8Jz4NyME9dK5Stt2XtA4cqceLaM%2BGzbajUTiQvv6Uf60ORdq1Jxi0%2FzfAFbw27UCXatC9UM84T4MF4KW3GFkQuKBR1bQL3UX4%2B5ZVljqwo0j467kK9f%2BNWbNY3lPOVNzT%2F3fUwvdy%2FVhG3JmMHP18Jofju5yG1LKcbDtNgVOcmuZuwAoWw399n59t8gqZ1GoM4E%2BW5phGs5IVFokR%2BAnbqPgnAwS2gmIL72CEzgTXAhUYSxnf6PW%2FhOVSTmgRju8ATJ6ZEZAw71x9cY7W%2FdO1PyXNsMSuhL%2FC9CpuVem3drD3JNz7qwWJ1%2BdpnMPp7KQ0Y182Af4Q29jqN0gtHvpqLTXtmYUng%2BeX7u86enXVelRiyEzn55Yqhecret4vy0xf7%2FBdGKu2q7TO3cnKFl%2FpWho%2BlalPHahuJxrZK0DzAkAIRPeOscbMJGJqLUGOqYBSVDqshSIi%2FdQ6uCeAQyg5NkrF8Wo0XL7uFmH57fUxjDD5rynY6d5SbNSi%2B1qjgt9NTB8ckqapqKnP8XrpWh%2BjwXwfYlWuMrDYRerdkjRXLuRWAnpE%2BkrTdmLO8zGlspCyrkSs8PdLW3XdTH6DfH5%2FiMsBmo0IySUl8VpCnPkrWpKv8F%2F9jKX%2FdD%2Fp%2F%2B7viekEQXU8jaH9ttxT%2BQvQPEr6uIT0g41Ng%3D%3D&X-Amz-Signature=3822725632c8126cc2dc40d36dfba66f282786e3daf4f76d0df456073518c7d4&X-Amz-SignedHeaders=host&x-id=GetObject)

Preview
## 

前言

上一章节，我们介绍了非对称加密：使用公钥进行加密，使用私钥进行解密，这样可以确保信息传输的安全性。小明和小红正是使用了非对称加密技术，才使得保密信件的内容在传递过程中不被泄露。

但是仅仅使用非对称加密来保护信件内容是不够的，因为小红的公钥是公开的，任何人都可以使用它来加密信息，假冒小明发送给小红。为了确保小红收到的信件确实来自小明，这里还需要另一种机制来验证消息的真实来源，这就是数字签名技术。

## 

 数字签名

数字签名技术使用私钥进行加密，使用公钥进行解密和验证，它能够验证消息是否由指定的发送者发出，并且在传输过程中没有被篡改，以确认信息的完整性和认证发送者的身份。

![image](https://hackquest-s3-prod-apne1.s3.ap-northeast-1.amazonaws.com/courses/1c7557b1-2dbc-4092-9ea2-a0c349e6f17c/7e6fb65c-bfd2-474c-88e0-6102272a34f5/b8a51b39-94fc-436f-a8e3-cf6964c5818f/e8eec89e-c342-4c46-93c7-54ae10b07e75.webp?X-Amz-Algorithm=AWS4-HMAC-SHA256&X-Amz-Content-Sha256=UNSIGNED-PAYLOAD&X-Amz-Credential=ASIAYCTGVDAPGS3I246A%2F20240731%2Fap-northeast-1%2Fs3%2Faws4_request&X-Amz-Date=20240731T114156Z&X-Amz-Expires=3600&X-Amz-Security-Token=IQoJb3JpZ2luX2VjEHEaDmFwLW5vcnRoZWFzdC0xIkcwRQIhAMKVgh8fbJ2Ufs7cy1eIlajjLldUx7UR3X6h3Q2HelC2AiAWTUC4c3ChamtdUXK6nk%2BUQgjHysUVobQWu9qMAf%2FlqCqeBAhbEAEaDDU1NTMzOTgxNDk0MiIMRqbARxX24dr4XLDKKvsDxYupgs%2BYWKr%2FLQ3ixMy95eAXsA5IGVS0G%2BD%2B9AHByln0WzPc31ciYhlYr3hUuII632MT0iGUwt7bgojfvR3uFnivP2omPUbXtgU62i5R1kYfV5NMnNpCPnyi%2FoH7XO6p8UfyjRrAaMkGdHd5TiCcGZwyLyNlLRgjabCizvINaXMQeQmVzTKwxv0bKGz1cUeaRWP6JBUj8wYD4HkeL4jRbdHci1nx8ZfAl5aauu%2FT5nOLvbVV8Jz4NyME9dK5Stt2XtA4cqceLaM%2BGzbajUTiQvv6Uf60ORdq1Jxi0%2FzfAFbw27UCXatC9UM84T4MF4KW3GFkQuKBR1bQL3UX4%2B5ZVljqwo0j467kK9f%2BNWbNY3lPOVNzT%2F3fUwvdy%2FVhG3JmMHP18Jofju5yG1LKcbDtNgVOcmuZuwAoWw399n59t8gqZ1GoM4E%2BW5phGs5IVFokR%2BAnbqPgnAwS2gmIL72CEzgTXAhUYSxnf6PW%2FhOVSTmgRju8ATJ6ZEZAw71x9cY7W%2FdO1PyXNsMSuhL%2FC9CpuVem3drD3JNz7qwWJ1%2BdpnMPp7KQ0Y182Af4Q29jqN0gtHvpqLTXtmYUng%2BeX7u86enXVelRiyEzn55Yqhecret4vy0xf7%2FBdGKu2q7TO3cnKFl%2FpWho%2BlalPHahuJxrZK0DzAkAIRPeOscbMJGJqLUGOqYBSVDqshSIi%2FdQ6uCeAQyg5NkrF8Wo0XL7uFmH57fUxjDD5rynY6d5SbNSi%2B1qjgt9NTB8ckqapqKnP8XrpWh%2BjwXwfYlWuMrDYRerdkjRXLuRWAnpE%2BkrTdmLO8zGlspCyrkSs8PdLW3XdTH6DfH5%2FiMsBmo0IySUl8VpCnPkrWpKv8F%2F9jKX%2FdD%2Fp%2F%2B7viekEQXU8jaH9ttxT%2BQvQPEr6uIT0g41Ng%3D%3D&X-Amz-Signature=0389073d4033ac381af06c4c6f3d4a286b712aac395498a63d7cf6319dfd2f95&X-Amz-SignedHeaders=host&x-id=GetObject)

Preview

我们还是以小明给小红发送保密信件来举例，他们不仅使用了非对称加密技术，还使用了数字签名技术。

●第一步：计算签名。小明先使用自己的私钥对消息密文进行加密，得到消息密文的签名，再将签名附加到消息密文中一起传输，发送给小红。

●第二步：恢复签名。小红收到消息密文和签名之后，使用公开获得的小明的公钥对签名进行解密，得到消息密文。

●第三步：验证签名。小红将收到的密文和解密签名恢复出来的密文进行对比，如果两者一致，则签名验证成功，说明收到的信件确实是小明发出的，同时还能证明信件在传输过程中没有被修改。

💡

补充说明 因为公私钥加密算法执行比较慢，如果消息比较大，签名过程会消耗很长时间。所以在实际应用中，一般先计算消息的哈希值，再计算哈希值的签名，这样可以减少签名耗时。还记得前面章节学习的哈希函数吗？无论消息内容有多少，计算的哈希值都是固定长度的。

## 

 交易验证

在以太坊中，数字签名技术用于交易验证，确保交易的真实性、完整性。交易验证主要有如下几步：

●用户签名交易。用户将交易数据准备好后，先计算出交易数据的哈希值，再使用椭圆曲线签名算法（ ECDSA ）对哈希值进行签名，将签名值（ v,r,s ）附加到交易数据中进行广播。

●矿工验证交易。矿工接收到一笔交易之后，同样，先计算出交易数据（不含签名）的哈希值，再使用椭圆曲线签名算法（ ECDSA ），从签名和哈希值中恢复出用户公钥。最后将恢复出的公钥与用户钱包地址做对比，如果两者一致，则交易验证成功。

![image](https://hackquest-s3-prod-apne1.s3.ap-northeast-1.amazonaws.com/courses/1c7557b1-2dbc-4092-9ea2-a0c349e6f17c/7e6fb65c-bfd2-474c-88e0-6102272a34f5/b8a51b39-94fc-436f-a8e3-cf6964c5818f/9abbadb3-ee21-4d8a-afd6-3a3cff44eb36.webp?X-Amz-Algorithm=AWS4-HMAC-SHA256&X-Amz-Content-Sha256=UNSIGNED-PAYLOAD&X-Amz-Credential=ASIAYCTGVDAPGS3I246A%2F20240731%2Fap-northeast-1%2Fs3%2Faws4_request&X-Amz-Date=20240731T114156Z&X-Amz-Expires=3600&X-Amz-Security-Token=IQoJb3JpZ2luX2VjEHEaDmFwLW5vcnRoZWFzdC0xIkcwRQIhAMKVgh8fbJ2Ufs7cy1eIlajjLldUx7UR3X6h3Q2HelC2AiAWTUC4c3ChamtdUXK6nk%2BUQgjHysUVobQWu9qMAf%2FlqCqeBAhbEAEaDDU1NTMzOTgxNDk0MiIMRqbARxX24dr4XLDKKvsDxYupgs%2BYWKr%2FLQ3ixMy95eAXsA5IGVS0G%2BD%2B9AHByln0WzPc31ciYhlYr3hUuII632MT0iGUwt7bgojfvR3uFnivP2omPUbXtgU62i5R1kYfV5NMnNpCPnyi%2FoH7XO6p8UfyjRrAaMkGdHd5TiCcGZwyLyNlLRgjabCizvINaXMQeQmVzTKwxv0bKGz1cUeaRWP6JBUj8wYD4HkeL4jRbdHci1nx8ZfAl5aauu%2FT5nOLvbVV8Jz4NyME9dK5Stt2XtA4cqceLaM%2BGzbajUTiQvv6Uf60ORdq1Jxi0%2FzfAFbw27UCXatC9UM84T4MF4KW3GFkQuKBR1bQL3UX4%2B5ZVljqwo0j467kK9f%2BNWbNY3lPOVNzT%2F3fUwvdy%2FVhG3JmMHP18Jofju5yG1LKcbDtNgVOcmuZuwAoWw399n59t8gqZ1GoM4E%2BW5phGs5IVFokR%2BAnbqPgnAwS2gmIL72CEzgTXAhUYSxnf6PW%2FhOVSTmgRju8ATJ6ZEZAw71x9cY7W%2FdO1PyXNsMSuhL%2FC9CpuVem3drD3JNz7qwWJ1%2BdpnMPp7KQ0Y182Af4Q29jqN0gtHvpqLTXtmYUng%2BeX7u86enXVelRiyEzn55Yqhecret4vy0xf7%2FBdGKu2q7TO3cnKFl%2FpWho%2BlalPHahuJxrZK0DzAkAIRPeOscbMJGJqLUGOqYBSVDqshSIi%2FdQ6uCeAQyg5NkrF8Wo0XL7uFmH57fUxjDD5rynY6d5SbNSi%2B1qjgt9NTB8ckqapqKnP8XrpWh%2BjwXwfYlWuMrDYRerdkjRXLuRWAnpE%2BkrTdmLO8zGlspCyrkSs8PdLW3XdTH6DfH5%2FiMsBmo0IySUl8VpCnPkrWpKv8F%2F9jKX%2FdD%2Fp%2F%2B7viekEQXU8jaH9ttxT%2BQvQPEr6uIT0g41Ng%3D%3D&X-Amz-Signature=9ac5621294c8a19d7c612be1d119eeaa0da66b8431a852aaaa9a776428a51166&X-Amz-SignedHeaders=host&x-id=GetObject)

Preview

对于初学者来说，为了方便理解，可以简单的认为用户钱包地址就是公钥。但是请注意，实际上两者并不相等，用户钱包地址是由公钥先经过哈希计算，再取末尾20个字节而来的。在后面的章节，我们会做详细介绍。

## 

 小结

这一小节，我们学习了数字签名的概念及其在交易验证中的重要作用。

简单来说，数字签名是一种使用私钥加密、公钥解密的技术，它保证了消息的真实性和完整性。通过这种方式，可以验证信息确实由发送者发出，并且在传递过程中未被篡改。这在加密货币交易中非常重要，可以用来确保交易的安全性。